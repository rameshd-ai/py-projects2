<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Project Wizard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .wizard-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }

        .wizard-header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            padding: 32px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wizard-header-content {
            flex: 1;
        }

        .wizard-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .wizard-header p {
            color: #bfdbfe;
            font-size: 14px;
        }

        .header-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        .header-link:hover {
            background: #f0f9ff !important;
            color: #1d4ed8 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .wizard-body {
            display: flex;
            min-height: 600px;
        }

        /* Sidebar */
        .wizard-sidebar {
            width: 320px;
            background: #f9fafb;
            border-right: 1px solid #e5e7eb;
            padding: 24px;
        }

        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .step-item:hover {
            background: #f3f4f6;
        }

        .step-item.active {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 4px;
        }

        .step-icon.completed {
            background: #10b981;
            color: white;
        }

        .step-icon.failed {
            background: #ef4444;
            color: white;
        }

        .step-icon.skipped {
            background: #f59e0b;
            color: white;
        }

        .step-icon.active {
            background: #2563eb;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .step-icon.pending {
            border: 2px solid #d1d5db;
            background: white;
        }

        .step-content {
            flex: 1;
        }

        .step-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .step-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
        }

        .step-item.active .step-title {
            color: #2563eb;
        }

        .step-subtitle {
            font-size: 12px;
            color: #6b7280;
        }

        .progress-box {
            margin-top: 32px;
            padding: 16px;
            background: #dbeafe;
            border-radius: 8px;
            border: 1px solid #93c5fd;
        }

        .progress-text {
            font-size: 12px;
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .progress-bar-container {
            background: white;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            background: #2563eb;
            height: 100%;
            transition: width 0.3s ease;
        }

        /* Main Content */
        .wizard-content {
            flex: 1;
            padding: 48px;
        }

        .content-inner {
            max-width: 800px;
        }

        .step-page {
            display: none;
        }

        .step-page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .page-description {
            color: #6b7280;
            margin-bottom: 32px;
        }

        .form-section {
            margin-bottom: 24px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .checkbox-item:hover {
            background: #f9fafb;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #2563eb;
        }

        .checkbox-label {
            color: #374151;
            font-weight: 500;
            flex: 1;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #2563eb;
            background: #f9fafb;
        }

        .upload-area.disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none !important;
            background: #f3f4f6 !important;
        }

        .upload-area.disabled * {
            pointer-events: none !important;
        }

        .upload-area.disabled .upload-button {
            background: #9ca3af !important;
            cursor: not-allowed !important;
        }
        
        .upload-area.disabled:hover {
            border-color: #d1d5db !important;
            background: #f3f4f6 !important;
        }

        .upload-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 8px;
            color: #9ca3af;
        }

        .upload-text {
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .upload-subtext {
            color: #9ca3af;
            font-size: 11px;
        }

        .upload-button {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-button:hover {
            background: #1d4ed8;
        }

        .file-name {
            margin-top: 8px;
            color: #10b981;
            font-size: 13px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .info-box {
            padding: 16px;
            border-radius: 8px;
            margin-top: 24px;
        }

        .info-box.blue {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
        }

        .info-box.yellow {
            background: #fef3c7;
            border: 1px solid #fde047;
            color: #92400e;
        }

        .info-box.green {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
        }

        .info-box strong {
            font-weight: 600;
        }

        .info-box p {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Summary Section */
        .summary-box {
            padding: 24px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            margin-bottom: 24px;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: #374151;
        }

        .summary-value {
            font-weight: 600;
            color: #2563eb;
        }

        /* Template Selection */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .template-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .template-card:hover {
            border-color: #2563eb;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1);
            transform: translateY(-4px);
        }

        .template-card.selected {
            border-color: #2563eb;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .template-preview {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-bottom: 1px solid #e5e7eb;
        }

        .template-info {
            padding: 20px;
        }

        .template-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .template-description {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
        }

        .selected-badge {
            background: #2563eb;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .search-box {
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px 12px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%239ca3af"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>');
            background-repeat: no-repeat;
            background-position: 12px center;
            background-size: 20px;
        }

        .search-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Navigation Buttons */
        .wizard-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #d1d5db;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        /* Sub-Processes */
        .sub-processes-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .sub-process-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-process-item:hover:not(.disabled) {
            border-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }

        .sub-process-item.active {
            border-color: #2563eb;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .sub-process-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f9fafb;
        }

        .sub-process-item.disabled:hover {
            border-color: #e5e7eb;
            box-shadow: none;
            transform: none;
        }

        .sub-process-content {
            flex: 1;
        }

        .sub-process-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .sub-process-icon {
            font-size: 24px;
        }

        .sub-process-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .sub-process-item.active .sub-process-title {
            color: #2563eb;
        }

        .sub-process-description {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
            margin-left: 36px;
        }

        .sub-process-item.processed {
            border-color: #10b981;
            background: #f0fdf4;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .sub-process-item.processed .sub-process-title {
            color: #10b981;
        }

        .sub-process-btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            background: #2563eb;
            color: white;
            white-space: nowrap;
        }

        .sub-process-btn:hover:not(:disabled) {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        }

        .sub-process-btn:disabled {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .sub-process-item.processed .sub-process-btn {
            background: #10b981;
            color: white;
            cursor: default;
        }

        .sub-process-item.processed .sub-process-btn:hover {
            background: #10b981;
            transform: none;
            box-shadow: none;
        }

        .sub-process-item.processing .sub-process-btn {
            background: #6b7280;
            cursor: wait;
        }

        @media (max-width: 1024px) {
            .wizard-body {
                flex-direction: column;
            }

            .wizard-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="wizard-card">
            <!-- Header -->
            <div class="wizard-header">
                <div class="wizard-header-content">
                    <h1>WebSite Creation Workflow</h1>
                    <p>OSB/Template/Custom project</p>
                </div>
                <a href="/jobs" class="header-link" style="background: white !important; color: #2563eb !important; border: 2px solid white !important; padding: 12px 24px !important; font-size: 15px !important; font-weight: 600 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    View All Jobs
                </a>
            </div>

        <!-- Jobs Link Banner (Additional Prominent Link) -->
        <div style="background: #f0f9ff; border-bottom: 2px solid #2563eb; padding: 16px 32px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #1e40af; font-size: 14px;">
                <strong><i class="fas fa-lightbulb"></i> Tip:</strong> View and manage all your jobs from the jobs list page
            </div>
            <a href="/jobs" style="background: #2563eb; color: white; padding: 10px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#1d4ed8'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.background='#2563eb'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                View All Jobs
            </a>
        </div>

        <div class="wizard-body">
                <!-- Sidebar -->
                <div class="wizard-sidebar">
                    <div id="stepsList">
                        <div class="step-item active" data-step="1">
                            <div class="step-icon active">1</div>
                            <div class="step-content">
                                <div class="step-label">Step One</div>
                                <div class="step-title">Site Setup Readiness</div>
                                <div class="step-subtitle">Initial configuration</div>
                            </div>
                        </div>
                        <div class="step-item" data-step="2">
                            <div class="step-icon pending"></div>
                            <div class="step-content">
                                <div class="step-label">Step Two</div>
                                <div class="step-title">Brand/Theme Setup</div>
                                <div class="step-subtitle">Design configuration</div>
                            </div>
                        </div>
                        <div class="step-item" data-step="3">
                            <div class="step-icon pending"></div>
                            <div class="step-content">
                                <div class="step-label">Step Three</div>
                                <div class="step-title">Content Plug-in</div>
                                <div class="step-subtitle">Content migration</div>
                            </div>
                        </div>
                        <div class="step-item" data-step="4">
                            <div class="step-icon pending"></div>
                            <div class="step-content">
                                <div class="step-label">Step Four</div>
                                <div class="step-title">Modules/Features</div>
                                <div class="step-subtitle">Select features</div>
                            </div>
                        </div>
                        <div class="step-item" data-step="5">
                            <div class="step-icon pending"></div>
                            <div class="step-content">
                                <div class="step-label">Step Five</div>
                                <div class="step-title">Review & Complete</div>
                                <div class="step-subtitle">Final review</div>
                            </div>
                        </div>
                    </div>

                    <div class="progress-box">
                        <div class="progress-text">Progress: Step <span id="currentStepNum">1</span> of 5</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar" style="width: 20%"></div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="wizard-content">
                    <div class="content-inner">
                        <!-- Step 1: Site Setup Readiness -->
                        <div class="step-page active" id="step1">
                            <h2 class="page-title">Site Setup Readiness</h2>
                            <p class="page-description">Complete the initial site configuration tasks</p>

                            <div class="form-section">
                                <div style="margin-bottom: 32px; padding: 24px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #111827;">Source</h3>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Source URL <span style="color: #ef4444;">*</span></label>
                                        <input type="url" class="form-input" id="sourceUrl" placeholder="https://source-website.com">
                                    </div>

                                    <div class="grid-2">
                                        <div class="form-group">
                                            <label class="form-label">Site ID <span style="color: #ef4444;">*</span></label>
                                            <input type="text" class="form-input" id="sourceSiteId" placeholder="Enter Site ID">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Profile Alias ID <span style="color: #ef4444;">*</span></label>
                                            <input type="text" class="form-input" id="sourceProfileAliasId" placeholder="Enter Profile Alias ID">
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 32px; padding: 24px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #111827;">Destination</h3>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Source URL <span style="color: #ef4444;">*</span></label>
                                        <input type="url" class="form-input" id="destinationUrl" placeholder="https://destination-website.com">
                                    </div>

                                    <div class="grid-2">
                                        <div class="form-group">
                                            <label class="form-label">Site ID <span style="color: #ef4444;">*</span></label>
                                            <input type="text" class="form-input" id="destinationSiteId" placeholder="Enter Site ID">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Profile Alias ID <span style="color: #ef4444;">*</span></label>
                                            <input type="text" class="form-input" id="destinationProfileAliasId" placeholder="Enter Profile Alias ID">
                                        </div>
                                    </div>
                                </div>

                                <div style="margin: 32px 0; padding: 24px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #111827;">Create Site Copy</h3>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Create Site</label>
                                        <div style="display: flex; gap: 24px;">
                                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                                <input type="radio" name="createSiteType" value="new" style="width: 18px; height: 18px; cursor: pointer;">
                                                <span style="color: #374151; font-size: 14px;">Create as New Site</span>
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                                <input type="radio" name="createSiteType" value="existing" checked style="width: 18px; height: 18px; cursor: pointer;">
                                                <span style="color: #374151; font-size: 14px;">Create in Existing Site</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Location Id <span style="color: #ef4444;">*</span></label>
                                        <input type="text" class="form-input" id="locationId" placeholder="387121.7443">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Create From</label>
                                        <select class="form-select" id="createFrom">
                                            <option value="">Select template...</option>
                                            <option value="luxury-dining">Luxury & Fine Dining Template 2025 [16229 - https://luxury-and-fine-dining-template-2025.web5]</option>
                                            <option value="resort-spa">Resort & Spa Template 2025</option>
                                            <option value="boutique-hotel">Boutique Hotel Template 2025</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Application Pool <span style="color: #ef4444;">*</span></label>
                                        <select class="form-select" id="applicationPool">
                                            <option value="">Select application pool...</option>
                                            <option value="CMS_PROGRAMMING_W016" selected>CMS_PROGRAMMING_W016</option>
                                            <option value="CMS_PROGRAMMING_W017">CMS_PROGRAMMING_W017</option>
                                            <option value="CMS_PROGRAMMING_W018">CMS_PROGRAMMING_W018</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Site Name <span style="color: #ef4444;">*</span></label>
                                        <input type="text" class="form-input" id="siteName" placeholder="FLYING STAG | New OSB Style - 1">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Site URL <span style="color: #ef4444;">*</span></label>
                                        <input type="url" class="form-input" id="siteUrl" placeholder="https://trivet-dining-luxury-and-finedining-2025.web5">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">IIS Certificate</label>
                                        <select class="form-select" id="iisCertificate">
                                            <option value="">Select certificate...</option>
                                            <option value="origin-2034" selected>Origin SSL â€“ 2034</option>
                                            <option value="origin-2035">Origin SSL â€“ 2035</option>
                                            <option value="origin-2036">Origin SSL â€“ 2036</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Alternative Bindings</label>
                                        <div style="display: flex; gap: 8px;">
                                            <input type="url" class="form-input" id="alternativeBindings" placeholder="http://trivet-dining-luxury-and-finedining-2025.web5c">
                                            <button type="button" style="padding: 12px 16px; background: #e5e7eb; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; color: #6b7280; transition: all 0.2s;" onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">+</button>
                                        </div>
                                    </div>

                                    <div class="grid-2">
                                        <div class="form-group">
                                            <label class="form-label">Create Copy of Asset</label>
                                            <select class="form-select" id="createCopyAsset">
                                                <option value="no" selected>No</option>
                                                <option value="yes">Yes</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Copy Physical Files</label>
                                            <select class="form-select" id="copyPhysicalFiles">
                                                <option value="no">No</option>
                                                <option value="yes" selected>Yes</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Is this a Secondary Language Site as a Subfolder?</label>
                                        <select class="form-select" id="secondaryLanguageSite">
                                            <option value="no" selected>No</option>
                                            <option value="yes">Yes</option>
                                        </select>
                                    </div>

                                    <div class="grid-2">
                                        <div class="form-group">
                                            <label class="form-label">Site Language</label>
                                            <select class="form-select" id="siteLanguage">
                                                <option value="en" selected>English (en)</option>
                                                <option value="es">Spanish (es)</option>
                                                <option value="fr">French (fr)</option>
                                                <option value="de">German (de)</option>
                                                <option value="it">Italian (it)</option>
                                                <option value="pt">Portuguese (pt)</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Site Country</label>
                                            <select class="form-select" id="siteCountry">
                                                <option value="us" selected>United States</option>
                                                <option value="uk">United Kingdom</option>
                                                <option value="ca">Canada</option>
                                                <option value="au">Australia</option>
                                                <option value="de">Germany</option>
                                                <option value="fr">France</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Is Translation required?</label>
                                        <select class="form-select" id="translationRequired">
                                            <option value="no" selected>No</option>
                                            <option value="yes">Yes</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Tracking Code</label>
                                    <textarea class="form-textarea" id="trackingCode" placeholder="Enter tracking code details..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Brand/Theme Setup -->
                        <div class="step-page" id="step2">
                            <h2 class="page-title">Brand/Theme Setup</h2>
                            <p class="page-description">Configure the visual design and branding</p>

                            <div class="form-section">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="fontPulled" id="fontPulled" onchange="toggleBrandUploadFields()">
                                    <span class="checkbox-label">Pull from Current Site</span>
                                </label>

                                <div class="form-group" id="fontFileGroup">
                                    <label class="form-label">Upload Font File <span style="color: #6b7280; font-weight: normal;">(CSV/JSON)</span></label>
                                    <div class="upload-area" id="fontUploadArea" onclick="if(!this.classList.contains('disabled')) document.getElementById('fontFile').click()">
                                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="upload-text">Upload Font Configuration</p>
                                        <p class="upload-subtext">CSV or JSON file format</p>
                                        <span class="upload-button">Choose File</span>
                                        <input type="file" id="fontFile" accept=".csv,.json" style="display: none;" onchange="displayFileName(this, 'fontFileName')">
                                        <div id="fontFileName" class="file-name"></div>
                                    </div>
                                </div>

                                <div class="form-group" id="colorFileGroup">
                                    <label class="form-label">Upload Color File <span style="color: #6b7280; font-weight: normal;">(CSV/JSON)</span></label>
                                    <div class="upload-area" id="colorUploadArea" onclick="if(!this.classList.contains('disabled')) document.getElementById('colorFile').click()">
                                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="upload-text">Upload Color Configuration</p>
                                        <p class="upload-subtext">CSV or JSON file format</p>
                                        <span class="upload-button">Choose File</span>
                                        <input type="file" id="colorFile" accept=".csv,.json" style="display: none;" onchange="displayFileName(this, 'colorFileName')">
                                        <div id="colorFileName" class="file-name"></div>
                                    </div>
                                </div>

                                <div class="info-box blue">
                                    <p><strong>Note:</strong> Fonts and colors will be automatically extracted from the current site if the checkbox is selected, or you can upload separate CSV/JSON files for font and color configurations.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Content Plug-in -->
                        <div class="step-page" id="step3">
                            <h2 class="page-title">Content Plug-in: Inner Pages</h2>
                            <p class="page-description">Configure content migration settings</p>

                            <div class="form-section">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="miblockMigration" id="miblockMigration">
                                    <span class="checkbox-label">MiBlock Records Migration</span>
                                </label>

                                <div class="form-group">
                                    <label class="form-label">Content Mapping Sheet</label>
                                    <div class="upload-area" onclick="document.getElementById('mappingSheet').click()">
                                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="upload-text">Upload Content Mapping Sheet</p>
                                        <p class="upload-subtext">Excel or CSV file</p>
                                        <span class="upload-button">Choose File</span>
                                        <input type="file" id="mappingSheet" accept=".xlsx,.xls,.csv" style="display: none;" onchange="displayFileName(this, 'fileName')">
                                        <div id="fileName" class="file-name"></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Migration Approach</label>
                                    <textarea class="form-textarea" id="migrationApproach" placeholder="Describe the content migration strategy..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Modules/Features -->
                        <div class="step-page" id="step4">
                            <h2 class="page-title">Modules/Features</h2>
                            <p class="page-description">Select and configure modules and features to include</p>

                            <div class="form-section">
                                <div class="sub-processes-container">
                                    <div class="sub-process-item disabled" data-module="socialFeed">
                                        <div class="sub-process-content">
                                            <div class="sub-process-header">
                                                <span class="sub-process-icon">ðŸ“±</span>
                                                <h3 class="sub-process-title">Social Feed (Zuicer)</h3>
                                            </div>
                                            <p class="sub-process-description">Migrate social media feed integration</p>
                                        </div>
                                        <button class="sub-process-btn" disabled>Disabled</button>
                                    </div>

                                    <div class="sub-process-item" data-module="htmlMenu">
                                        <div class="sub-process-content">
                                            <div class="sub-process-header">
                                                <span class="sub-process-icon"><i class="fas fa-utensils"></i></span>
                                                <h3 class="sub-process-title">Dine Menu: Inner Pages</h3>
                                            </div>
                                            <p class="sub-process-description">Configure and migrate menu data with field mapping</p>
                                        </div>
                                        <button class="sub-process-btn" onclick="processSubProcess('htmlMenu')">Process</button>
                                    </div>

                                    <div class="sub-process-item" data-module="faqManager">
                                        <div class="sub-process-content">
                                            <div class="sub-process-header">
                                                <span class="sub-process-icon"><i class="fas fa-question-circle"></i></span>
                                                <h3 class="sub-process-title">FAQ Manager Migration</h3>
                                            </div>
                                            <p class="sub-process-description">Migrate frequently asked questions</p>
                                        </div>
                                        <button class="sub-process-btn" onclick="handleFaqManagerClick()">Process</button>
                                    </div>

                                    <div class="sub-process-item disabled" data-module="ltoMigration">
                                        <div class="sub-process-content">
                                            <div class="sub-process-header">
                                                <span class="sub-process-icon"><i class="fas fa-sync-alt"></i></span>
                                                <h3 class="sub-process-title">LTO Migration: CMS to MiBlock</h3>
                                            </div>
                                            <p class="sub-process-description">Migrate Limited Time Offers from CMS to MiBlock</p>
                                        </div>
                                        <button class="sub-process-btn" disabled>Disabled</button>
                                    </div>

                                    <div class="sub-process-item disabled" data-module="rfpForm">
                                        <div class="sub-process-content">
                                            <div class="sub-process-header">
                                                <span class="sub-process-icon"><i class="fas fa-clipboard-list"></i></span>
                                                <h3 class="sub-process-title">RFP Form Migration (Db)</h3>
                                            </div>
                                            <p class="sub-process-description">Migrate Request for Proposal forms</p>
                                        </div>
                                        <button class="sub-process-btn" disabled>Disabled</button>
                                    </div>

                                    <div class="sub-process-item disabled" data-module="damMigration">
                                        <div class="sub-process-content">
                                            <div class="sub-process-header">
                                                <span class="sub-process-icon"><i class="fas fa-images"></i></span>
                                                <h3 class="sub-process-title">DAM Migration</h3>
                                            </div>
                                            <p class="sub-process-description">Migrate Digital Asset Management content</p>
                                        </div>
                                        <button class="sub-process-btn" disabled>Disabled</button>
                                    </div>
                                </div>

                                <div class="info-box yellow">
                                    <p><strong>Note:</strong> Additional modules may require extra configuration time. Estimated completion will be calculated based on your selections.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Review & Complete -->
                        <div class="step-page" id="step5">
                            <h2 class="page-title">Review & Complete</h2>
                            <p class="page-description">Review your migration configuration</p>

                            <div class="form-section">
                                <div class="summary-box">
                                    <h3 class="summary-title">Migration Summary</h3>
                                    <div class="summary-item">
                                        <span class="summary-label">Brand/Theme Configuration</span>
                                        <span class="summary-value" id="brandThemeStatus">â—‹ Pending</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Content Migration</span>
                                        <span class="summary-value" id="contentMigrationStatus">â—‹ Disabled</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Modules/Features Selected</span>
                                        <span class="summary-value" id="modulesCount">0 modules</span>
                                    </div>
                                </div>

                                <div class="info-box green">
                                    <h4 style="font-weight: 600; margin-bottom: 8px;">Ready to Process</h4>
                                    <p>All configuration steps have been reviewed. Click "Process" to complete the final step.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="wizard-navigation">
                            <button class="btn btn-secondary" id="prevBtn" onclick="previousStep()" disabled>
                                Previous
                            </button>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-secondary" id="skipNextBtn" onclick="skipNextStep()">
                                    Process and Skip Next Step
                                </button>
                                <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                                    Process
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 5;
        // Check if job_id is provided in URL (for resuming)
        const urlParams = new URLSearchParams(window.location.search);
        const urlJobId = urlParams.get('job_id');
        let jobId = urlJobId || generateJobId();
        let workflowInProgress = false;
        let eventSource = null;
        let stepStatus = {}; // Track step status: 'success', 'failed', 'skipped'
        let processedSubProcesses = {}; // Track which sub-processes have been processed

        // Generate unique job ID
        function generateJobId() {
            return 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Load job status when jobId changes
        let lastJobId = null;
        
        async function checkAndLoadJobStatus() {
            if (jobId && jobId !== lastJobId) {
                lastJobId = jobId;
                await loadJobStatus();
                updateUI();
            }
        }
        
        async function loadJobStatus() {
            // Load completed steps from JSON
            try {
                const response = await fetch(`/api/job-status/${jobId}`);
                const result = await response.json();
                
                if (result.success) {
                    const completedSteps = result.completed_steps || [];
                    const stepResults = result.step_results || {};
                    const stepIds = ['site_setup', 'brand_theme', 'content_plugin', 'modules_features', 'finalize'];
                    
                    completedSteps.forEach(stepId => {
                        const stepIndex = stepIds.indexOf(stepId);
                        if (stepIndex >= 0) {
                            const stepResult = stepResults[stepId] || {};
                            const stepStatusValue = stepResult.status || 'success';
                            const stepMessage = (stepResult.result?.message || stepResult.message || '').toLowerCase();
                            
                            // Check if step was skipped
                            const isSkipped = stepStatusValue === 'skipped' || 
                                             stepMessage.includes('skipped') || 
                                             stepMessage.includes('not enabled') ||
                                             stepMessage.includes('not selected') ||
                                             stepMessage.includes('no modules');
                            
                            if (isSkipped) {
                                stepStatus[stepIndex + 1] = 'skipped';
                                // Update UI to show skipped (orange)
                                const stepItem = document.querySelector(`.step-item[data-step="${stepIndex + 1}"]`);
                                const stepIcon = stepItem?.querySelector('.step-icon');
                                if (stepIcon) {
                                    stepIcon.innerHTML = '<i class="fas fa-minus"></i>';
                                    stepIcon.style.background = '#f59e0b';
                                    stepIcon.classList.add('skipped');
                                    stepIcon.classList.remove('completed', 'active', 'pending');
                                }
                            } else {
                                stepStatus[stepIndex + 1] = 'success';
                                // Update UI to show success (green) if not already set
                                const stepItem = document.querySelector(`.step-item[data-step="${stepIndex + 1}"]`);
                                const stepIcon = stepItem?.querySelector('.step-icon');
                                if (stepIcon && !stepIcon.classList.contains('skipped')) {
                                    stepIcon.innerHTML = '<i class="fas fa-check"></i>';
                                    stepIcon.style.background = '#10b981';
                                    stepIcon.classList.add('completed');
                                    stepIcon.classList.remove('skipped', 'active', 'pending');
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading job status:', error);
            }
        }
        
        function updateUI() {
            // Update step items
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const stepNum = index + 1;
                const icon = item.querySelector('.step-icon');
                
                item.classList.remove('active');
                icon.classList.remove('active', 'completed', 'pending', 'failed', 'skipped');
                
                // Apply status from stepStatus object if it exists
                const status = stepStatus[stepNum];
                
                if (status === 'failed') {
                    icon.innerHTML = '<i class="fas fa-times"></i>';
                    icon.style.background = '#ef4444';
                    icon.classList.add('failed');
                } else if (status === 'skipped') {
                    icon.innerHTML = '<i class="fas fa-minus"></i>';
                    icon.style.background = '#f59e0b'; // Orange color
                    icon.classList.add('skipped');
                } else if (status === 'success' || status === 'completed') {
                    icon.innerHTML = '<i class="fas fa-check"></i>';
                    icon.style.background = '#10b981';
                    icon.classList.add('completed');
                } else if (status === 'processing' || status === 'active') {
                    icon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    icon.style.background = '#2563eb';
                    icon.classList.add('active');
                } else if (stepNum < currentStep) {
                    // Step was processed but not yet marked complete
                    icon.innerHTML = '<i class="fas fa-check"></i>';
                    icon.style.background = '#10b981';
                    icon.classList.add('completed');
                } else if (stepNum === currentStep) {
                    item.classList.add('active');
                    icon.classList.add('active');
                    icon.innerHTML = stepNum;
                } else {
                    icon.classList.add('pending');
                    icon.innerHTML = '';
                }
            });

            // Update step pages
            document.querySelectorAll('.step-page').forEach((page, index) => {
                page.classList.remove('active');
                if (index + 1 === currentStep) {
                    page.classList.add('active');
                }
            });

            // Update progress bar
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentStepNum').textContent = currentStep;

            // Update buttons
            document.getElementById('prevBtn').disabled = currentStep === 1 || workflowInProgress;
            const nextBtn = document.getElementById('nextBtn');
            const skipNextBtn = document.getElementById('skipNextBtn');
            nextBtn.disabled = workflowInProgress;
            // Disable skip when workflow is in progress or there is no next step to skip
            const hasNextStepToSkip = currentStep < totalSteps;
            skipNextBtn.disabled = workflowInProgress || !hasNextStepToSkip;
            
            if (currentStep === totalSteps) {
                nextBtn.innerHTML = 'Process <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            } else {
                nextBtn.innerHTML = 'Process <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>';
            }

            // Update summary if on last step
            if (currentStep === 5) {
                updateSummary();
            }
        }

        async function collectFormData() {
            const formData = {
                job_id: jobId,
                // Step 1: Site Setup
                sourceUrl: document.getElementById('sourceUrl')?.value || '',
                sourceSiteId: document.getElementById('sourceSiteId')?.value || '',
                sourceProfileAliasId: document.getElementById('sourceProfileAliasId')?.value || '',
                destinationUrl: document.getElementById('destinationUrl')?.value || '',
                destinationSiteId: document.getElementById('destinationSiteId')?.value || '',
                destinationProfileAliasId: document.getElementById('destinationProfileAliasId')?.value || '',
                createSiteType: document.querySelector('input[name="createSiteType"]:checked')?.value || 'existing',
                locationId: document.getElementById('locationId')?.value || '',
                createFrom: document.getElementById('createFrom')?.value || '',
                applicationPool: document.getElementById('applicationPool')?.value || '',
                siteName: document.getElementById('siteName')?.value || '',
                siteUrl: document.getElementById('siteUrl')?.value || '',
                iisCertificate: document.getElementById('iisCertificate')?.value || '',
                alternativeBindings: document.getElementById('alternativeBindings')?.value || '',
                createCopyAsset: document.getElementById('createCopyAsset')?.value || 'no',
                copyPhysicalFiles: document.getElementById('copyPhysicalFiles')?.value || 'yes',
                secondaryLanguageSite: document.getElementById('secondaryLanguageSite')?.value || 'no',
                siteLanguage: document.getElementById('siteLanguage')?.value || 'en',
                siteCountry: document.getElementById('siteCountry')?.value || 'us',
                translationRequired: document.getElementById('translationRequired')?.value || 'no',
                trackingCode: document.getElementById('trackingCode')?.value || '',
                
                // Step 2: Brand/Theme
                fontPulled: document.getElementById('fontPulled')?.checked || false,
                fontFile: document.getElementById('fontFile')?.files[0]?.name || '',
                colorFile: document.getElementById('colorFile')?.files[0]?.name || '',
                
                // Step 3: Content
                miblockMigration: document.getElementById('miblockMigration')?.checked || false,
                mappingSheet: document.getElementById('mappingSheet')?.files[0]?.name || '',
                migrationApproach: document.getElementById('migrationApproach')?.value || '',
                
                // Step 4: Modules (from sub-processes - check if processed)
                socialFeed: processedSubProcesses['socialFeed'] || false,
                htmlMenu: processedSubProcesses['htmlMenu'] || false,
                faqManager: processedSubProcesses['faqManager'] || false,
                ltoMigration: processedSubProcesses['ltoMigration'] || false,
                rfpForm: processedSubProcesses['rfpForm'] || false,
                damMigration: processedSubProcesses['damMigration'] || false
            };
            
            return formData;
        }

        async function saveConfiguration() {
            try {
                const formData = await collectFormData();
                
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    console.error('Failed to save configuration:', result.error);
                    return false;
                }
                
                console.log('Configuration saved successfully');
                return true;
            } catch (error) {
                console.error('Error saving configuration:', error);
                return false;
            }
        }

        async function startWorkflow() {
            try {
                // Save configuration first
                await saveConfiguration();
                
                workflowInProgress = true;
                updateUI();
                
                // Show processing modal
                showProcessingModal();
                
                // Start workflow
                const response = await fetch('/api/start-workflow', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ job_id: jobId })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to start workflow');
                }
                
                // Connect to SSE stream
                connectToWorkflowStream(result.stream_url);
                
            } catch (error) {
                console.error('Error starting workflow:', error);
                alert('Failed to start workflow: ' + error.message);
                workflowInProgress = false;
                updateUI();
            }
        }

        function connectToWorkflowStream(streamUrl) {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(streamUrl);
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWorkflowUpdate(data);
                } catch (error) {
                    console.error('Error parsing SSE data:', error);
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE connection error:', error);
                eventSource.close();
                workflowInProgress = false;
                updateUI();
            };
        }

        function handleWorkflowUpdate(data) {
            console.log('Workflow update:', data);
            
            const modalContent = document.getElementById('processingModalContent');
            
            switch (data.status) {
                case 'start':
                    addProcessingLog(data.message, 'info');
                    break;
                    
                case 'in_progress':
                    addProcessingLog(data.message, 'processing');
                    updateProcessingStep(data.step_number, 'in_progress');
                    break;
                    
                case 'done':
                    addProcessingLog(`${data.message} (${data.duration}s)`, 'success');
                    updateProcessingStep(data.step_number, 'completed');
                    break;
                    
                case 'complete':
                    addProcessingLog(data.message, 'success');
                    showCompletionMessage(data);
                    eventSource.close();
                    workflowInProgress = false;
                    break;
                    
                case 'error':
                    addProcessingLog(`Error: ${data.message}`, 'error');
                    eventSource.close();
                    workflowInProgress = false;
                    updateUI();
                    break;
                    
                case 'close':
                    console.log('SSE connection closed');
                    break;
            }
        }

        function showProcessingModal() {
            const modal = document.createElement('div');
            modal.id = 'processingModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 32px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 24px; font-size: 24px; font-weight: 600;">Workflow Processing</h2>
                    <div id="processingSteps" style="margin-bottom: 24px;"></div>
                    <div id="processingModalContent" style="background: #f9fafb; padding: 16px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
                    <div id="completionMessage" style="display: none; margin-top: 24px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Create step indicators
            const stepsContainer = document.getElementById('processingSteps');
            for (let i = 1; i <= 5; i++) {
                const stepDiv = document.createElement('div');
                stepDiv.id = `processStep${i}`;
                stepDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; gap: 12px;';
                stepDiv.innerHTML = `
                    <div class="process-step-icon" style="width: 24px; height: 24px; border-radius: 50%; background: #d1d5db; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">${i}</div>
                    <div class="process-step-name" style="font-size: 14px; color: #6b7280;">Step ${i}</div>
                `;
                stepsContainer.appendChild(stepDiv);
            }
        }

        function updateProcessingStep(stepNumber, status) {
            const stepDiv = document.getElementById(`processStep${stepNumber}`);
            const icon = stepDiv.querySelector('.process-step-icon');
            
            if (status === 'in_progress') {
                stepDiv.style.background = '#dbeafe';
                icon.style.background = '#2563eb';
                icon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            } else if (status === 'completed') {
                stepDiv.style.background = '#d1fae5';
                icon.style.background = '#10b981';
                icon.innerHTML = '<i class="fas fa-check"></i>';
            }
        }

        function addProcessingLog(message, type) {
            const logContainer = document.getElementById('processingModalContent');
            const logEntry = document.createElement('div');
            logEntry.style.cssText = 'padding: 4px 0;';
            
            const colors = {
                info: '#6b7280',
                processing: '#2563eb',
                success: '#10b981',
                error: '#ef4444'
            };
            
            logEntry.innerHTML = `<span style="color: ${colors[type] || '#000'};">${new Date().toLocaleTimeString()}: ${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showCompletionMessage(data) {
            const completionDiv = document.getElementById('completionMessage');
            completionDiv.style.display = 'block';
            completionDiv.innerHTML = `
                <div style="background: #d1fae5; border: 2px solid #10b981; border-radius: 8px; padding: 24px; text-align: center;">
                    <h3 style="color: #065f46; font-size: 20px; margin-bottom: 12px;"><i class="fas fa-check"></i> Workflow Completed!</h3>
                    <p style="color: #047857; margin-bottom: 16px;">Total duration: ${data.total_duration}s</p>
                    ${data.report_url ? `<a href="${data.report_url}" style="display: inline-block; padding: 12px 24px; background: #10b981; color: white; border-radius: 8px; text-decoration: none; font-weight: 500;">Download Report</a>` : ''}
                    <button onclick="closeProcessingModal()" style="display: inline-block; margin-left: 12px; padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Close</button>
                </div>
            `;
        }

        function closeProcessingModal() {
            const modal = document.getElementById('processingModal');
            if (modal) {
                modal.remove();
            }
            // Reset to first step
            currentStep = 1;
            jobId = generateJobId();
            stepStatus = {}; // Clear step status
            updateUI();
        }
        
        function closeStepProcessingModal() {
            const modal = document.getElementById('stepProcessingModal');
            if (modal) {
                modal.remove();
            }
        }

        async function nextStep() {
            if (currentStep < totalSteps) {
                // Process current step, then move to next
                await saveAndProcessStep();
                currentStep++;
                updateUI();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // Process final step and show completion
                await saveAndProcessStep();
                showCompletion();
            }
        }
        
        function showProcessingModal(message = 'Processing...') {
            // Remove existing modal if any
            const existingModal = document.getElementById('stepProcessingModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'stepProcessingModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 32px; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);">
                    <div style="margin-bottom: 24px;">
                        <div class="spinner" style="width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    </div>
                    <h3 style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">Processing Step ${currentStep}</h3>
                    <p id="processingModalMessage" style="color: #6b7280; font-size: 14px; margin-bottom: 0;">${message}</p>
                </div>
            `;
            
            // Add spinner animation
            if (!document.getElementById('spinnerStyle')) {
                const style = document.createElement('style');
                style.id = 'spinnerStyle';
                style.textContent = `
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(modal);
            return modal;
        }
        
        function updateProcessingModalMessage(message) {
            const messageEl = document.getElementById('processingModalMessage');
            if (messageEl) {
                messageEl.textContent = message;
            }
        }
        
        function closeProcessingModal() {
            const modal = document.getElementById('stepProcessingModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function markStepAsComplete(stepNumber) {
            try {
                const response = await fetch('/api/mark-step-complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_id: jobId,
                        step_number: stepNumber
                    })
                });
                
                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Error marking step as complete:', error);
                return false;
            }
        }
        
        async function saveAndProcessStep() {
            const processingModal = showProcessingModal('Initializing step processing...');
            
            try {
                // Show processing indicator
                const stepItem = document.querySelector(`.step-item[data-step="${currentStep}"]`);
                const stepIcon = stepItem?.querySelector('.step-icon');
                if (stepIcon) {
                    stepIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    stepIcon.style.background = '#2563eb';
                }
                
                updateProcessingModalMessage('Collecting form data...');
                
                // Collect and save config, then process step
                const formData = await collectFormData();
                formData.step_number = currentStep;
                
                updateProcessingModalMessage('Saving configuration...');
                
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                updateProcessingModalMessage('Processing step (this may take a moment)...');
                
                const result = await response.json();
                
                if (!result.success) {
                    closeProcessingModal();
                    // Mark step as failed
                    stepStatus[currentStep] = 'failed';
                    throw new Error(result.error || 'Failed to process step');
                }
                
                // Check if step processing completed (but not marked as complete yet)
                if (result.step_processed && result.step_result) {
                    updateProcessingModalMessage('Step processing completed. Finalizing...');
                    
                    // Explicitly mark step as complete
                    const markedComplete = await markStepAsComplete(currentStep);
                    
                    if (markedComplete) {
                        // Check step status from backend
                        const stepStatusFromBackend = result.step_result?.status || 'success';
                        const stepResult = result.step_result?.result || {};
                        const stepMessage = stepResult.message || '';
                        
                        // Determine if step was skipped
                        const isSkipped = stepStatusFromBackend === 'skipped' || 
                                         stepMessage.toLowerCase().includes('skipped') || 
                                         stepMessage.toLowerCase().includes('not enabled') ||
                                         stepMessage.toLowerCase().includes('not selected') ||
                                         stepMessage.toLowerCase().includes('no modules');
                        
                        // Update step status
                        if (isSkipped) {
                            stepStatus[currentStep] = 'skipped';
                            if (stepIcon) {
                                stepIcon.innerHTML = '<i class="fas fa-minus"></i>';
                                stepIcon.style.background = '#f59e0b';
                                stepIcon.classList.add('skipped');
                            }
                        } else {
                            stepStatus[currentStep] = 'success';
                            if (stepIcon) {
                                stepIcon.innerHTML = '<i class="fas fa-check"></i>';
                                stepIcon.style.background = '#10b981';
                                stepIcon.classList.add('completed');
                            }
                        }
                        
                        updateProcessingModalMessage('Step completed successfully!');
                        await new Promise(resolve => setTimeout(resolve, 500)); // Brief delay to show success
                        closeProcessingModal();
                        
                        console.log(`Step ${currentStep} ${isSkipped ? 'skipped' : 'completed'}:`, result.step_result.step_name);
                    } else {
                        closeProcessingModal();
                        alert('Step processed but failed to mark as complete. Please try again.');
                    }
                } else {
                    closeProcessingModal();
                }
                
            } catch (error) {
                closeProcessingModal();
                console.error('Error processing step:', error);
                
                // Mark step as failed
                stepStatus[currentStep] = 'failed';
                
                // Update step icon to failed (red with cross)
                const stepItem = document.querySelector(`.step-item[data-step="${currentStep}"]`);
                const stepIcon = stepItem?.querySelector('.step-icon');
                if (stepIcon) {
                    stepIcon.innerHTML = '<i class="fas fa-times"></i>';
                    stepIcon.style.background = '#ef4444';
                    stepIcon.classList.add('failed');
                }
                
                alert('Failed to process step: ' + error.message);
            }
        }
        
        async function showCompletion() {
            // Generate final report
            try {
                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ job_id: jobId })
                });
                
                const result = await response.json();
                
                if (result.success && result.report_url) {
                    alert('All steps completed successfully!\n\nDownload report: ' + result.report_url);
                } else {
                    alert('All steps completed successfully!');
                }
            } catch (error) {
                alert('All steps completed successfully!');
            }
        }

        async function skipStepOnServer(stepNumber) {
            try {
                const response = await fetch('/api/skip-step', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_id: jobId,
                        step_number: stepNumber
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to skip step');
                }
                return true;
            } catch (error) {
                console.error('Error skipping step:', error);
                alert('Failed to skip step: ' + error.message);
                return false;
            }
        }

        async function skipNextStep() {
            if (workflowInProgress) {
                return;
            }

            const nextStepNumber = currentStep + 1;
            if (nextStepNumber > totalSteps) {
                return;
            }

            const confirmed = confirm('This will process the current step, then skip the next step and jump ahead. Continue?');
            if (!confirmed) {
                return;
            }

            // First, process the current step
            await saveAndProcessStep();

            // Then skip the next step
            const success = await skipStepOnServer(nextStepNumber);
            if (!success) {
                alert('Failed to skip step on server. Please try again.');
                return;
            }

            // Mark the next step as skipped in UI state
            stepStatus[nextStepNumber] = 'skipped';

            // Update the UI to show the skipped step
            const skippedStepItem = document.querySelector(`.step-item[data-step="${nextStepNumber}"]`);
            const skippedStepIcon = skippedStepItem?.querySelector('.step-icon');
            if (skippedStepIcon) {
                skippedStepIcon.innerHTML = '<i class="fas fa-minus"></i>';
                skippedStepIcon.style.background = '#f59e0b';
                skippedStepIcon.classList.add('skipped');
            }

            // If there is a step after the skipped one, jump to it; otherwise, we just move to the final state
            if (nextStepNumber < totalSteps) {
                currentStep = nextStepNumber + 1;
                updateUI();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // Skipping the final step â€“ mark workflow as effectively complete
                currentStep = totalSteps;
                updateUI();
                await showCompletion();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Click on step items
        document.querySelectorAll('.step-item').forEach(item => {
            item.addEventListener('click', function() {
                if (!workflowInProgress) {
                    currentStep = parseInt(this.dataset.step);
                    updateUI();
                }
            });
        });

        function displayFileName(input, targetId) {
            const fileName = input.files[0]?.name;
            if (fileName && targetId) {
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.innerHTML = '<i class="fas fa-check"></i> ' + fileName;
                }
            } else if (fileName) {
                // Fallback for mapping sheet (uses 'fileName' as default)
                const defaultElement = document.getElementById('fileName');
                if (defaultElement) {
                    defaultElement.textContent = 'âœ“ ' + fileName;
                }
            }
        }

        function displayCsvJsonFileName(input) {
            // Legacy function - kept for backward compatibility
            displayFileName(input, 'fontFileName');
        }

        function updateSummary() {
            // Brand/Theme status - check if font/color files are uploaded or Pull from Site is checked
            const fontPulled = document.getElementById('fontPulled');
            const fontFile = document.getElementById('fontFile');
            const colorFile = document.getElementById('colorFile');
            const hasFontFile = fontFile && fontFile.files && fontFile.files.length > 0;
            const hasColorFile = colorFile && colorFile.files && colorFile.files.length > 0;
            const isPulled = fontPulled && fontPulled.checked;
            const isConfigured = (hasFontFile || hasColorFile || isPulled);
            document.getElementById('brandThemeStatus').textContent = 
                isConfigured ? '<i class="fas fa-check"></i> Configured' : '<i class="far fa-circle"></i> Pending';

            // Content migration status
            const miblockMigration = document.getElementById('miblockMigration');
            document.getElementById('contentMigrationStatus').textContent = 
                (miblockMigration && miblockMigration.checked) ? '<i class="fas fa-check"></i> Enabled' : '<i class="far fa-circle"></i> Disabled';

            // Additional modules count (from sub-processes - count processed)
            const modulesCount = Object.keys(processedSubProcesses).filter(key => processedSubProcesses[key]).length;
            document.getElementById('modulesCount').textContent = modulesCount + ' modules';
            
            // Check if all enabled sub-processes are processed
            checkStep4Completion();
        }

        function checkStep4Completion() {
            // Get all enabled sub-processes (not disabled)
            const enabledSubProcesses = document.querySelectorAll('.sub-process-item:not(.disabled)');
            const enabledModules = Array.from(enabledSubProcesses).map(el => el.dataset.module);
            
            // Check if all enabled sub-processes are processed
            const allProcessed = enabledModules.length > 0 && enabledModules.every(module => processedSubProcesses[module] === true);
            
            if (allProcessed) {
                // Mark Step 4 as complete
                stepStatus[4] = 'success';
                updateUI();
            }
        }

        function toggleBrandUploadFields() {
            const fontPulled = document.getElementById('fontPulled');
            const fontUploadArea = document.getElementById('fontUploadArea');
            const colorUploadArea = document.getElementById('colorUploadArea');
            const fontFileInput = document.getElementById('fontFile');
            const colorFileInput = document.getElementById('colorFile');
            
            if (fontPulled && fontPulled.checked) {
                // Disable file uploads when checkbox is checked
                if (fontUploadArea) {
                    fontUploadArea.classList.add('disabled');
                    fontUploadArea.style.pointerEvents = 'none';
                }
                if (colorUploadArea) {
                    colorUploadArea.classList.add('disabled');
                    colorUploadArea.style.pointerEvents = 'none';
                }
                if (fontFileInput) {
                    fontFileInput.disabled = true;
                }
                if (colorFileInput) {
                    colorFileInput.disabled = true;
                }
            } else {
                // Enable file uploads when checkbox is unchecked
                if (fontUploadArea) {
                    fontUploadArea.classList.remove('disabled');
                    fontUploadArea.style.pointerEvents = 'auto';
                }
                if (colorUploadArea) {
                    colorUploadArea.classList.remove('disabled');
                    colorUploadArea.style.pointerEvents = 'auto';
                }
                if (fontFileInput) {
                    fontFileInput.disabled = false;
                }
                if (colorFileInput) {
                    colorFileInput.disabled = false;
                }
            }
        }

        // Load job configuration and populate form
        async function loadJobConfiguration() {
            if (!jobId || jobId.startsWith('job_') === false) {
                return; // Only load if it's an existing job ID
            }
            
            try {
                const response = await fetch(`/api/job-config/${jobId}`);
                const result = await response.json();
                
                if (result.success && result.config) {
                    const config = result.config;
                    
                    // Populate Step 1 fields
                    if (config.sourceUrl) document.getElementById('sourceUrl').value = config.sourceUrl;
                    if (config.sourceSiteId) document.getElementById('sourceSiteId').value = config.sourceSiteId;
                    if (config.sourceProfileAliasId) document.getElementById('sourceProfileAliasId').value = config.sourceProfileAliasId;
                    if (config.destinationUrl) document.getElementById('destinationUrl').value = config.destinationUrl;
                    if (config.destinationSiteId) document.getElementById('destinationSiteId').value = config.destinationSiteId;
                    if (config.destinationProfileAliasId) document.getElementById('destinationProfileAliasId').value = config.destinationProfileAliasId;
                    if (config.locationId) document.getElementById('locationId').value = config.locationId;
                    if (config.createFrom) document.getElementById('createFrom').value = config.createFrom;
                    if (config.applicationPool) document.getElementById('applicationPool').value = config.applicationPool;
                    if (config.siteName) document.getElementById('siteName').value = config.siteName;
                    if (config.siteUrl) document.getElementById('siteUrl').value = config.siteUrl;
                    if (config.iisCertificate) document.getElementById('iisCertificate').value = config.iisCertificate;
                    if (config.alternativeBindings) document.getElementById('alternativeBindings').value = config.alternativeBindings;
                    if (config.createCopyAsset) document.getElementById('createCopyAsset').value = config.createCopyAsset;
                    if (config.copyPhysicalFiles) document.getElementById('copyPhysicalFiles').value = config.copyPhysicalFiles;
                    if (config.secondaryLanguageSite) document.getElementById('secondaryLanguageSite').value = config.secondaryLanguageSite;
                    if (config.siteLanguage) document.getElementById('siteLanguage').value = config.siteLanguage;
                    if (config.siteCountry) document.getElementById('siteCountry').value = config.siteCountry;
                    if (config.translationRequired) document.getElementById('translationRequired').value = config.translationRequired;
                    if (config.trackingCode) document.getElementById('trackingCode').value = config.trackingCode;
                    
                    // Handle radio buttons
                    if (config.createSiteType) {
                        const radio = document.querySelector(`input[name="createSiteType"][value="${config.createSiteType}"]`);
                        if (radio) radio.checked = true;
                    }
                    
                    // Populate Step 2 fields
                    if (config.fontPulled) document.getElementById('fontPulled').checked = config.fontPulled;
                    
                    // Populate Step 3 fields
                    if (config.miblockMigration) document.getElementById('miblockMigration').checked = config.miblockMigration;
                    if (config.migrationApproach) document.getElementById('migrationApproach').value = config.migrationApproach;
                    
                    // Populate Step 4 - sub-processes status will be checked after loadJobStatus
                    
                    toggleBrandUploadFields();
                }
            } catch (error) {
                console.error('Error loading job configuration:', error);
            }
        }

        // Check sub-process status from results
        async function checkSubProcessStatus() {
            if (!jobId) return;
            
            try {
                // First check job config for processed_modules (persistent state)
                const configResponse = await fetch(`/api/job-config/${jobId}`);
                const configData = await configResponse.json();
                
                if (configData.success && configData.config) {
                    const processedModules = configData.config.processed_modules || {};
                    
                    // Check each module and mark as processed if found
                    ['htmlMenu', 'faqManager', 'socialFeed', 'ltoMigration', 'rfpForm', 'damMigration'].forEach(moduleId => {
                        const moduleItem = document.querySelector(`.sub-process-item[data-module="${moduleId}"]`);
                        if (!moduleItem) return;
                        
                        const isDisabled = moduleItem.classList.contains('disabled');
                        const isProcessed = processedModules[moduleId] === true;
                        const hasTimestamp = processedModules[`${moduleId}_timestamp`] !== undefined;
                        
                        // Only mark as processed (green) if it was actually executed (has timestamp)
                        if (isProcessed && hasTimestamp && !isDisabled) {
                            moduleItem.classList.add('processed');
                            processedSubProcesses[moduleId] = true;
                            const btn = moduleItem.querySelector('.sub-process-btn');
                            if (btn) {
                                btn.innerHTML = '<i class="fas fa-check"></i> Processed';
                                btn.style.background = '#10b981';
                                btn.disabled = false; // Allow reprocessing
                                if (moduleId === 'htmlMenu') {
                                    btn.onclick = () => showMenuConfigModal();
                                } else if (moduleId === 'faqManager') {
                                    btn.onclick = () => handleFaqManagerClick();
                                } else {
                                    btn.onclick = () => reprocessModule(moduleId);
                                }
                                btn.title = 'Click to reprocess';
                                
                                // Add download button for FAQ
                                if (moduleId === 'faqManager' && !moduleItem.querySelector('.download-faq-btn')) {
                                    const downloadBtn = document.createElement('button');
                                    downloadBtn.className = 'download-faq-btn';
                                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
                                    downloadBtn.style.cssText = 'padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 8px;';
                                    downloadBtn.onclick = () => downloadFaqFile();
                                    btn.parentNode.appendChild(downloadBtn);
                                }
                                
                                // Add reprocess button next to processed button
                                if (!moduleItem.querySelector('.reprocess-btn')) {
                                    const reprocessBtn = document.createElement('button');
                                    reprocessBtn.className = 'reprocess-btn';
                                    reprocessBtn.innerHTML = '<i class="fas fa-redo"></i> Reprocess';
                                    reprocessBtn.style.cssText = 'padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 8px;';
                                    reprocessBtn.onclick = () => reprocessModule(moduleId);
                                    btn.parentNode.appendChild(reprocessBtn);
                                }
                            }
                        } else if (isDisabled || (!isProcessed && !hasTimestamp)) {
                            // Mark as skipped (orange) if disabled or not processed
                            moduleItem.classList.add('skipped');
                            const btn = moduleItem.querySelector('.sub-process-btn');
                            if (btn && !btn.disabled) {
                                btn.innerHTML = '<i class="fas fa-minus"></i> Skipped';
                                btn.style.background = '#f59e0b';
                                btn.disabled = true;
                                btn.title = isDisabled ? 'Module is disabled' : 'Module not executed';
                            }
                        }
                    });
                }
                
                // Also check results.json as fallback
                const response = await fetch(`/api/job-status/${jobId}`);
                const result = await response.json();
                
                if (result.success) {
                    const completedSteps = result.completed_steps || [];
                    // If modules_features is completed, check which sub-processes were processed
                    if (completedSteps.includes('modules_features')) {
                        // Try to load results.json to check module results
                        try {
                            const resultsResponse = await fetch(`/api/job-results/${jobId}`);
                            const resultsData = await resultsResponse.json();
                            
                            if (resultsData.success && resultsData.results) {
                                const stepResults = resultsData.results.step_results || {};
                                const modulesResult = stepResults.modules_features || {};
                                const moduleResults = modulesResult.module_results || {};
                                
                                // Mark HTML Menu as processed if it was processed (fallback)
                                if (moduleResults.htmlMenu && !processedSubProcesses['htmlMenu']) {
                                    const htmlMenuItem = document.querySelector('.sub-process-item[data-module="htmlMenu"]');
                                    if (htmlMenuItem && !htmlMenuItem.classList.contains('disabled')) {
                                        htmlMenuItem.classList.add('processed');
                                        processedSubProcesses['htmlMenu'] = true;
                                        const btn = htmlMenuItem.querySelector('.sub-process-btn');
                                        if (btn) {
                                            btn.innerHTML = '<i class="fas fa-check"></i> Processed';
                                            btn.style.background = '#10b981';
                                            btn.disabled = false;
                                            btn.onclick = () => showMenuConfigModal();
                                        }
                                    }
                                }
                                
                                // Mark FAQ Manager as processed if it was processed (fallback)
                                if (moduleResults.faqManager && !processedSubProcesses['faqManager']) {
                                    const faqItem = document.querySelector('.sub-process-item[data-module="faqManager"]');
                                    if (faqItem && !faqItem.classList.contains('disabled')) {
                                        faqItem.classList.add('processed');
                                        processedSubProcesses['faqManager'] = true;
                                        const btn = faqItem.querySelector('.sub-process-btn');
                                        if (btn) {
                                            btn.innerHTML = '<i class="fas fa-check"></i> Processed';
                                            btn.style.background = '#10b981';
                                            btn.disabled = false;
                                            btn.onclick = () => reprocessModule('faqManager');
                                        }
                                    }
                                }
                            }
                        } catch (err) {
                            // If results.json doesn't exist or can't be read, that's okay
                            console.log('Could not load detailed results:', err);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking sub-process status:', error);
            }
        }
        
        async function reprocessModule(moduleId) {
            if (!confirm(`Are you sure you want to reprocess ${moduleId}? This will run the processing again.`)) {
                return;
            }
            
            // Reset processed state
            processedSubProcesses[moduleId] = false;
            const moduleItem = document.querySelector(`.sub-process-item[data-module="${moduleId}"]`);
            if (moduleItem) {
                moduleItem.classList.remove('processed');
                const btn = moduleItem.querySelector('.sub-process-btn');
                const reprocessBtn = moduleItem.querySelector('.reprocess-btn');
                const downloadBtn = moduleItem.querySelector('.download-faq-btn');
                
                if (reprocessBtn) {
                    reprocessBtn.remove();
                }
                if (downloadBtn) {
                    downloadBtn.remove();
                }
                if (btn) {
                    btn.innerHTML = 'Process';
                    btn.style.background = '#10b981';
                    if (moduleId === 'htmlMenu') {
                        btn.onclick = () => showMenuConfigModal();
                    } else if (moduleId === 'faqManager') {
                        btn.onclick = () => handleFaqManagerClick();
                    } else {
                        btn.onclick = () => processSubProcess(moduleId);
                    }
                }
            }
            
            // Process the module
            if (moduleId === 'htmlMenu') {
                await processSubProcessDirectly('htmlMenu');
            } else if (moduleId === 'faqManager') {
                showFaqManagerModal();
            } else {
                await processSubProcessDirectly(moduleId);
            }
        }

        // Initialize - load job status and update UI
        (async function init() {
            // If resuming a job, load its configuration
            if (jobId && urlJobId) {
                await loadJobConfiguration();
            }
            
            await loadJobStatus();
            await checkSubProcessStatus();
            
            // Set current step based on completed steps
            const stepIds = ['site_setup', 'brand_theme', 'content_plugin', 'modules_features', 'finalize'];
            let lastCompletedStep = 0;
            for (let i = 0; i < stepIds.length; i++) {
                if (stepStatus[i + 1] === 'success') {
                    lastCompletedStep = i + 1;
                }
            }
            // Set current step to the next incomplete step
            if (lastCompletedStep < totalSteps) {
                currentStep = lastCompletedStep + 1;
            } else {
                currentStep = totalSteps;
            }
            
            updateUI();
            toggleBrandUploadFields(); // Apply initial state for file uploads
        })();

        // Sub-Process Functions
        async function processSubProcess(moduleId) {
            const subProcess = document.querySelector(`.sub-process-item[data-module="${moduleId}"]`);
            const processBtn = subProcess?.querySelector('.sub-process-btn');
            
            if (!subProcess || subProcess.classList.contains('disabled') || processedSubProcesses[moduleId]) {
                return;
            }
            
            // For Dine Menu, show config modal first
            if (moduleId === 'htmlMenu') {
                showMenuConfigModal();
                // Note: Processing will happen after user saves config and clicks process button in modal
                return;
            }
            
            // For FAQ Manager, show FAQ modal first
            if (moduleId === 'faqManager') {
                showFaqManagerModal();
                return;
            }
            
            // Set processing state
            subProcess.classList.add('processing');
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';
            
            try {
                // Collect form data
                const formData = await collectFormData();
                formData.step_number = 4;
                formData.module_id = moduleId;
                
                // Process the sub-process
                const response = await fetch('/api/process-sub-process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_id: jobId,
                        module_id: moduleId,
                        form_data: formData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Mark as processed
                    processedSubProcesses[moduleId] = true;
                    subProcess.classList.remove('processing');
                    subProcess.classList.add('processed');
                    processBtn.innerHTML = '<i class="fas fa-check"></i> Processed';
                    processBtn.disabled = true;
                    
                    // Check if all sub-processes are done
                    checkStep4Completion();
                } else {
                    throw new Error(result.error || 'Failed to process sub-process');
                }
            } catch (error) {
                console.error('Error processing sub-process:', error);
                alert('Failed to process sub-process: ' + error.message);
                subProcess.classList.remove('processing');
                processBtn.disabled = false;
                processBtn.textContent = 'Process';
            }
        }
        
        // Function to process Dine Menu after config is saved
        async function processDineMenuAfterConfig() {
            await processSubProcessDirectly('htmlMenu');
        }
        
        async function processSubProcessDirectly(moduleId) {
            const subProcess = document.querySelector(`.sub-process-item[data-module="${moduleId}"]`);
            const processBtn = subProcess?.querySelector('.sub-process-btn');
            
            // Allow reprocessing if already processed
            if (!subProcess || subProcess.classList.contains('disabled')) {
                return;
            }
            
            // If already processed, reset state for reprocessing
            if (processedSubProcesses[moduleId]) {
                processedSubProcesses[moduleId] = false;
                subProcess.classList.remove('processed');
                const reprocessBtn = subProcess.querySelector('.reprocess-btn');
                if (reprocessBtn) reprocessBtn.remove();
                if (processBtn) {
                    processBtn.innerHTML = 'Process';
                    processBtn.style.background = '#10b981';
                }
            }
            
            // Set processing state
            subProcess.classList.add('processing');
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';
            
            try {
                // Collect form data
                const formData = await collectFormData();
                formData.step_number = 4;
                formData.module_id = moduleId;
                
                // Ensure the module is enabled in form_data for processing
                // This is critical - the backend checks htmlMenu flag to decide if processing should run
                if (moduleId === 'htmlMenu') {
                    formData.htmlMenu = true;
                } else if (moduleId === 'faqManager') {
                    formData.faqManager = true;
                }
                // Add other modules as needed
                
                // Process the sub-process
                const response = await fetch('/api/process-sub-process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_id: jobId,
                        module_id: moduleId,
                        form_data: formData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Mark as processed (state is saved on backend)
                    processedSubProcesses[moduleId] = true;
                    subProcess.classList.remove('processing');
                    subProcess.classList.add('processed');
                    processBtn.innerHTML = '<i class="fas fa-check"></i> Processed';
                    processBtn.style.background = '#10b981';
                    processBtn.disabled = false; // Allow reprocessing
                    if (moduleId === 'htmlMenu') {
                        processBtn.onclick = () => showMenuConfigModal();
                    } else if (moduleId === 'faqManager') {
                        processBtn.onclick = () => handleFaqManagerClick();
                    } else {
                        processBtn.onclick = () => reprocessModule(moduleId);
                    }
                    processBtn.title = 'Click to reprocess';
                    
                    // Add download button for FAQ
                    if (moduleId === 'faqManager' && !subProcess.querySelector('.download-faq-btn')) {
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'download-faq-btn';
                        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
                        downloadBtn.style.cssText = 'padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 8px;';
                        downloadBtn.onclick = () => downloadFaqFile();
                        processBtn.parentNode.appendChild(downloadBtn);
                    }
                    
                    // Add reprocess button
                    if (!subProcess.querySelector('.reprocess-btn')) {
                        const reprocessBtn = document.createElement('button');
                        reprocessBtn.className = 'reprocess-btn';
                        reprocessBtn.innerHTML = '<i class="fas fa-redo"></i> Reprocess';
                        reprocessBtn.style.cssText = 'padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 8px;';
                        reprocessBtn.onclick = () => reprocessModule(moduleId);
                        processBtn.parentNode.appendChild(reprocessBtn);
                    }
                    
                    // For htmlMenu, also update modal button
                    if (moduleId === 'htmlMenu') {
                        const modalProcessBtn = document.getElementById('processDineMenuBtn');
                        if (modalProcessBtn) {
                            modalProcessBtn.innerHTML = '<i class="fas fa-check"></i> Processed';
                            modalProcessBtn.style.background = '#10b981';
                            modalProcessBtn.disabled = false;
                        }
                    }
                    
                    // Check if all sub-processes are done
                    checkStep4Completion();
                } else {
                    throw new Error(result.error || 'Failed to process sub-process');
                }
            } catch (error) {
                console.error('Error processing sub-process:', error);
                alert('Failed to process sub-process: ' + error.message);
                subProcess.classList.remove('processing');
                processBtn.disabled = false;
                processBtn.textContent = 'Process';
            }
        }

        function showMenuConfigModal() {
            // Remove existing modal if any
            const existingModal = document.getElementById('menuConfigModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'menuConfigModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 0; max-width: 90%; width: 1200px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);">
                    <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: #111827;">Dine Menu Configuration</h2>
                        <button onclick="closeMenuConfigModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">Ã—</button>
                    </div>
                    
                    <div style="display: flex; border-bottom: 1px solid #e5e7eb;">
                        <button id="tabMapper" onclick="switchMenuTab('mapper')" style="flex: 1; padding: 16px; background: #2563eb; color: white; border: none; cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 0; border-top-left-radius: 16px;">
                            Field Mapper
                        </button>
                        <button id="tabTemplate" onclick="switchMenuTab('template')" style="flex: 1; padding: 16px; background: #e5e7eb; color: #374151; border: none; cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 0; border-top-right-radius: 16px;">
                            Payload Template
                        </button>
                    </div>
                    
                    <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <div id="tabContentMapper" style="display: flex; flex-direction: column; height: 100%; padding: 24px;">
                            <div style="margin-bottom: 16px;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Menu Field Mapper</h3>
                            </div>
                            <textarea id="mapperEditor" data-config-type="mapper" style="flex: 1; padding: 16px; border: 1px solid #d1d5db; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; resize: none; min-height: 400px;"></textarea>
                        </div>
                        
                        <div id="tabContentTemplate" style="display: none; flex-direction: column; height: 100%; padding: 24px;">
                            <div style="margin-bottom: 16px;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Menu Payload Template</h3>
                            </div>
                            <textarea id="templateEditor" data-config-type="template" style="flex: 1; padding: 16px; border: 1px solid #d1d5db; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; resize: none; min-height: 400px;"></textarea>
                        </div>
                    </div>
                    
                    <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 12px;">
                            <button onclick="saveAllMenuConfigs()" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;" onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">Save All</button>
                            <button onclick="processDineMenuFromModal()" id="processDineMenuBtn" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">Process</button>
                        </div>
                        <button onclick="closeMenuConfigModal()" style="padding: 10px 20px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load initial data for the mapper tab (first tab, now active by default)
            loadMenuConfig('mapper');
            
            // Track which tabs have been loaded to prevent overwriting user edits
            window.menuConfigTabsLoaded = {
                template: false,
                mapper: false
            };
            
            // Mark mapper as loaded
            setTimeout(() => {
                window.menuConfigTabsLoaded.mapper = true;
            }, 500);
            
            // Update Process button state if already processed
            const processBtn = document.getElementById('processDineMenuBtn');
            if (processBtn && processedSubProcesses['htmlMenu']) {
                processBtn.innerHTML = '<i class="fas fa-check"></i> Processed';
                processBtn.style.background = '#10b981';
                processBtn.disabled = false; // Allow reprocessing
            }
        }

        async function processDineMenuFromModal() {
            const processBtn = document.getElementById('processDineMenuBtn');
            
            // If already processed, ask for confirmation to reprocess
            if (processedSubProcesses['htmlMenu']) {
                if (!confirm('Dine Menu has already been processed. Do you want to reprocess it?')) {
                    return;
                }
                // Reset processed state for reprocessing
                processedSubProcesses['htmlMenu'] = false;
            }
            
            // NOTE: Do NOT save mapper files here - "Save All" button handles that
            // "Process" button should ONLY process the menu, not save mapper files
            
            // Disable button and show processing
            if (processBtn) {
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';
                processBtn.style.background = '#6b7280';
            }
            
            // Process the Dine Menu sub-process (this will call APIs)
            try {
                await processSubProcessDirectly('htmlMenu');
                // Close the modal after successful processing
                closeMenuConfigModal();
            } catch (error) {
                // Re-enable button on error
                if (processBtn) {
                    processBtn.disabled = false;
                    processBtn.textContent = 'Process';
                    processBtn.style.background = '#10b981';
                }
            }
        }

        function switchMenuTab(tab) {
            const templateTab = document.getElementById('tabTemplate');
            const mapperTab = document.getElementById('tabMapper');
            const templateContent = document.getElementById('tabContentTemplate');
            const mapperContent = document.getElementById('tabContentMapper');
            
            if (tab === 'mapper') {
                mapperTab.style.background = '#2563eb';
                mapperTab.style.color = 'white';
                templateTab.style.background = '#e5e7eb';
                templateTab.style.color = '#374151';
                mapperContent.style.display = 'flex';
                templateContent.style.display = 'none';
                // Do NOT reload - just switch tabs to preserve user edits
            } else {
                templateTab.style.background = '#2563eb';
                templateTab.style.color = 'white';
                mapperTab.style.background = '#e5e7eb';
                mapperTab.style.color = '#374151';
                templateContent.style.display = 'flex';
                mapperContent.style.display = 'none';
                
                // Load template data only if it hasn't been loaded yet (first time viewing this tab)
                if (!window.menuConfigTabsLoaded || !window.menuConfigTabsLoaded.template) {
                    const templateEditor = document.getElementById('templateEditor');
                    if (templateEditor && !templateEditor.value.trim()) {
                        loadMenuConfig('template');
                        if (!window.menuConfigTabsLoaded) {
                            window.menuConfigTabsLoaded = { template: false, mapper: true };
                        }
                        window.menuConfigTabsLoaded.template = true;
                    }
                }
            }
        }

        async function loadMenuConfig(type) {
            try {
                // Explicitly determine which editor to use
                let editorId, fileName;
                if (type === 'template') {
                    editorId = 'templateEditor';
                    fileName = 'Payload Template';
                } else if (type === 'mapper') {
                    editorId = 'mapperEditor';
                    fileName = 'Field Mapper';
                } else {
                    console.error('Invalid config type:', type);
                    return;
                }
                
                console.log(`Loading ${type} configuration into editor: ${editorId}`);
                
                const response = await fetch(`/api/menu-config/${type}`);
                const result = await response.json();
                
                if (result.success) {
                    const editor = document.getElementById(editorId);
                    if (editor) {
                        // Always load the data (this is called only when editor is empty or on initial load)
                        editor.value = JSON.stringify(result.data, null, 2);
                        console.log(`[OK] Loaded ${fileName} into ${editorId} (${editor.value.length} chars)`);
                    } else {
                        console.error(`Editor element "${editorId}" not found`);
                    }
                } else {
                    console.error('Failed to load ' + type + ' configuration:', result.error);
                    alert('Failed to load ' + fileName + ': ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading menu config:', error);
                alert('Error loading configuration: ' + error.message);
            }
        }

        async function saveMenuConfig(type) {
            try {
                // Validate type first
                if (type !== 'template' && type !== 'mapper') {
                    alert('Invalid configuration type: ' + type);
                    console.error('Invalid type:', type);
                    return;
                }
                
                // Explicitly get the correct editor based on type
                const editorId = type === 'template' ? 'templateEditor' : 'mapperEditor';
                const fileName = type === 'template' ? 'Payload Template' : 'Field Mapper';
                
                // Get editor element - use querySelector with data attribute as backup
                let editor = document.getElementById(editorId);
                if (!editor) {
                    // Fallback: try to find by data attribute
                    editor = document.querySelector(`textarea[data-config-type="${type}"]`);
                    if (!editor) {
                        alert(`Editor "${editorId}" not found for ${type}`);
                        console.error(`Editor element with ID "${editorId}" does not exist`);
                        return;
                    }
                }
                
                // Double-check we have the right editor by verifying data attribute
                if (editor.getAttribute('data-config-type') !== type && editor.id !== editorId) {
                    console.warn(`Editor data attribute mismatch. Expected: ${type}, Got: ${editor.getAttribute('data-config-type')}`);
                }
                
                // Get the current editor content - make sure we're reading from the right editor
                const editorContent = editor.value.trim();
                if (!editorContent) {
                    alert(`${fileName} editor is empty. Nothing to save.`);
                    return;
                }
                
                // Validate JSON
                let jsonData;
                try {
                    jsonData = JSON.parse(editorContent);
                } catch (e) {
                    alert(`Invalid JSON format in ${fileName}. Please check your syntax.\n\nError: ${e.message}`);
                    return;
                }
                
                // Log detailed info for debugging
                console.log(`=== Saving ${type} configuration ===`);
                console.log(`Editor ID: ${editorId}`);
                console.log(`Editor element found:`, editor);
                console.log(`File name: ${fileName}`);
                console.log(`Content length: ${editorContent.length} characters`);
                console.log(`First 200 chars: ${editorContent.substring(0, 200)}...`);
                console.log(`Last 100 chars: ...${editorContent.substring(Math.max(0, editorContent.length - 100))}`);
                
                // Verify we're sending to the correct endpoint
                const endpoint = `/api/menu-config/${type}`;
                console.log(`Sending to endpoint: ${endpoint}`);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: jsonData })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`${fileName} saved successfully!`);
                    console.log(`[OK] Successfully saved ${type} configuration to ${endpoint}`);
                } else {
                    alert(`Failed to save ${fileName}: ${result.error || 'Unknown error'}`);
                    console.error('[ERROR] Save failed:', result);
                }
            } catch (error) {
                console.error('Error saving menu config:', error);
                alert('Error saving configuration: ' + error.message);
            }
        }

        async function saveAllMenuConfigs() {
            const confirmed = confirm('This will save both Payload Template and Field Mapper. Continue?');
            if (!confirmed) {
                return;
            }
            
            let templateSaved = false;
            let mapperSaved = false;
            let errors = [];
            
            // Save template
            try {
                await saveMenuConfig('template');
                templateSaved = true;
            } catch (error) {
                errors.push('Template: ' + error.message);
            }
            
            // Small delay between saves
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Save mapper
            try {
                await saveMenuConfig('mapper');
                mapperSaved = true;
            } catch (error) {
                errors.push('Mapper: ' + error.message);
            }
            
            if (templateSaved && mapperSaved) {
                alert('Both configurations saved successfully!');
            } else if (templateSaved || mapperSaved) {
                alert(`Partially saved:\n${templateSaved ? '[OK] Template saved' : '[ERROR] Template failed'}\n${mapperSaved ? '[OK] Mapper saved' : '[ERROR] Mapper failed'}\n\nErrors: ${errors.join(', ')}`);
            } else {
                alert('Failed to save configurations:\n' + errors.join('\n'));
            }
        }

        function closeMenuConfigModal() {
            const modal = document.getElementById('menuConfigModal');
            if (modal) {
                modal.remove();
            }
        }

        // FAQ Manager Modal Functions
        function handleFaqManagerClick() {
            const subProcess = document.querySelector('.sub-process-item[data-module="faqManager"]');
            if (subProcess && !subProcess.classList.contains('disabled')) {
                // If already processed, ask for confirmation to reprocess
                if (processedSubProcesses['faqManager']) {
                    if (!confirm('FAQ has already been processed. Do you want to reprocess it?')) {
                        return;
                    }
                    // Reset processed state for reprocessing
                    processedSubProcesses['faqManager'] = false;
                    const btn = subProcess.querySelector('.sub-process-btn');
                    const reprocessBtn = subProcess.querySelector('.reprocess-btn');
                    const downloadBtn = subProcess.querySelector('.download-faq-btn');
                    if (reprocessBtn) reprocessBtn.remove();
                    if (downloadBtn) downloadBtn.remove();
                    if (btn) {
                        btn.innerHTML = 'Process';
                        btn.style.background = '#10b981';
                    }
                    subProcess.classList.remove('processed');
                }
                showFaqManagerModal();
            }
        }

        function showFaqManagerModal() {
            // Remove existing modal if any
            const existingModal = document.getElementById('faqManagerModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Get source URL from Step 1
            const sourceUrl = document.getElementById('sourceUrl')?.value || '';

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'faqManagerModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 0; max-width: 90%; width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);">
                    <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: #111827;">FAQ Manager Migration</h2>
                        <button onclick="closeFaqManagerModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">Ã—</button>
                    </div>
                    
                    <div style="flex: 1; overflow-y: auto; padding: 24px;">
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Source Link <span style="color: #ef4444;">*</span></label>
                            <input type="url" id="faqSourceLink" value="${sourceUrl}" placeholder="https://example.com" style="width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#2563eb'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)'" onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'">
                            <p style="margin-top: 8px; font-size: 12px; color: #6b7280;">Enter the source URL to extract FAQ data from (pre-filled from Step 1)</p>
                        </div>
                        
                        <div id="faqProcessingStatus" style="display: none; padding: 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="spinner" style="width: 20px; height: 20px; border: 2px solid #e5e7eb; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span id="faqStatusMessage" style="font-size: 14px; color: #374151;">Processing FAQ data...</span>
                            </div>
                        </div>
                        
                        <div id="faqDownloadSection" style="display: none; padding: 16px; background: #d1fae5; border: 2px solid #10b981; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <p style="margin: 0; font-size: 14px; font-weight: 600; color: #065f46;"><i class="fas fa-check"></i> FAQ Processing Completed!</p>
                                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #047857;">Output file has been generated</p>
                                </div>
                                <button id="faqDownloadBtn" onclick="downloadFaqFile()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">Download</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <button onclick="processFaqFromModal()" id="processFaqBtn" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">Process</button>
                        <button onclick="closeFaqManagerModal()" style="padding: 10px 20px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function processFaqFromModal() {
            const sourceLink = document.getElementById('faqSourceLink')?.value.trim();
            const processBtn = document.getElementById('processFaqBtn');
            const statusDiv = document.getElementById('faqProcessingStatus');
            const statusMessage = document.getElementById('faqStatusMessage');
            const downloadSection = document.getElementById('faqDownloadSection');
            
            if (!sourceLink) {
                alert('Please enter a source link');
                return;
            }
            
            // Validate URL
            if (!sourceLink.startsWith('http://') && !sourceLink.startsWith('https://')) {
                alert('Please enter a valid URL starting with http:// or https://');
                return;
            }
            
            // Disable button and show processing
            if (processBtn) {
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';
                processBtn.style.background = '#6b7280';
            }
            
            if (statusDiv) {
                statusDiv.style.display = 'block';
            }
            if (statusMessage) {
                statusMessage.textContent = 'Processing FAQ data from source link...';
            }
            if (downloadSection) {
                downloadSection.style.display = 'none';
            }
            
            try {
                // Collect form data
                const formData = await collectFormData();
                formData.step_number = 4;
                formData.module_id = 'faqManager';
                formData.faq_source_link = sourceLink;
                
                // Process the FAQ
                const response = await fetch('/api/process-sub-process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_id: jobId,
                        module_id: 'faqManager',
                        form_data: formData,
                        source_link: sourceLink
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Mark as processed
                    processedSubProcesses['faqManager'] = true;
                    
                    // Update UI in card
                    const subProcess = document.querySelector('.sub-process-item[data-module="faqManager"]');
                    const processBtnInCard = subProcess?.querySelector('.sub-process-btn');
                    if (subProcess) {
                        subProcess.classList.remove('processing');
                        subProcess.classList.add('processed');
                    }
                    if (processBtnInCard) {
                        processBtnInCard.innerHTML = '<i class="fas fa-check"></i> Processed';
                        processBtnInCard.style.background = '#10b981';
                        processBtnInCard.disabled = false; // Allow reprocessing
                        processBtnInCard.onclick = () => handleFaqManagerClick();
                        processBtnInCard.title = 'Click to reprocess';
                        
                        // Add download button next to process button
                        if (!subProcess.querySelector('.download-faq-btn')) {
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = 'download-faq-btn';
                            downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
                            downloadBtn.style.cssText = 'padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 8px;';
                            downloadBtn.onclick = () => downloadFaqFile();
                            processBtnInCard.parentNode.appendChild(downloadBtn);
                        }
                        
                        // Add reprocess button next to process button
                        if (!subProcess.querySelector('.reprocess-btn')) {
                            const reprocessBtn = document.createElement('button');
                            reprocessBtn.className = 'reprocess-btn';
                            reprocessBtn.innerHTML = '<i class="fas fa-redo"></i> Reprocess';
                            reprocessBtn.style.cssText = 'padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 8px;';
                            reprocessBtn.onclick = () => reprocessModule('faqManager');
                            processBtnInCard.parentNode.appendChild(reprocessBtn);
                        }
                    }
                    
                    // Show download section in modal
                    if (statusMessage) {
                        statusMessage.textContent = 'FAQ processing completed successfully!';
                    }
                    if (downloadSection) {
                        downloadSection.style.display = 'block';
                    }
                    if (processBtn) {
                        processBtn.disabled = false;
                        processBtn.innerHTML = '<i class="fas fa-check"></i> Processed';
                        processBtn.style.background = '#10b981';
                        processBtn.onclick = () => {
                            if (confirm('FAQ has already been processed. Do you want to reprocess it?')) {
                                processedSubProcesses['faqManager'] = false;
                                processFaqFromModal();
                            }
                        };
                    }
                    
                    // Store download file name
                    window.faqDownloadFileName = result.result?.output_file || result.result?.file_name || `faq_processed_${jobId}.xlsx`;
                    
                    // Update download button if it exists
                    const downloadBtn = subProcess?.querySelector('.download-faq-btn');
                    if (downloadBtn) {
                        downloadBtn.onclick = () => downloadFaqFile();
                    }
                    
                    // Check if all sub-processes are done
                    checkStep4Completion();
                } else {
                    throw new Error(result.error || 'Failed to process FAQ');
                }
            } catch (error) {
                console.error('Error processing FAQ:', error);
                alert('Failed to process FAQ: ' + error.message);
                
                // Re-enable button on error
                if (processBtn) {
                    processBtn.disabled = false;
                    processBtn.textContent = 'Process';
                    processBtn.style.background = '#10b981';
                }
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
            }
        }

        function downloadFaqFile() {
            // Try to get file name from window variable or construct from job ID
            const fileName = window.faqDownloadFileName || `faq_processed_${jobId}.xlsx`;
            const downloadUrl = `/api/download-faq-file?job_id=${jobId}&file_name=${encodeURIComponent(fileName)}`;
            window.open(downloadUrl, '_blank');
        }

        function closeFaqManagerModal() {
            const modal = document.getElementById('faqManagerModal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html>