<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IND-Quant-Alpha — Dashboard</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --danger: #f85149;
      --success: #3fb950;
      --warn: #d29922;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
    }
    .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .top h1 { font-size: 1.125rem; margin: 0; font-weight: 600; }
    .top a {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.875rem;
      margin-left: 1rem;
    }
    .top a:hover { color: var(--accent); }
    .main {
      padding: 1.5rem;
      max-width: 900px;
      margin: 0 auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }
    .card h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin: 0 0 0.5rem 0;
    }
    .card .val { font-size: 1.25rem; font-weight: 600; }
    .card .val.positive { color: var(--success); }
    .card .val.negative { color: var(--danger); }
    .card .val.warn { color: var(--warn); }
    .actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    .btn-primary {
      background: var(--success);
      color: #fff;
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-danger {
      background: var(--danger);
      color: #fff;
    }
    .btn:hover:not(:disabled) { opacity: 0.9; }
    .live-pane {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .live-pane h2 { font-size: 1rem; margin: 0 0 0.75rem 0; }
    .countdown {
      font-size: 1.125rem;
      color: var(--muted);
    }
    .countdown span { color: var(--accent); font-weight: 600; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    th, td {
      text-align: left;
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    th { color: var(--muted); font-weight: 500; }
    .status-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-running { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .status-stopped { background: rgba(139, 148, 158, 0.2); color: var(--muted); }
    .status-auto { background: rgba(210, 153, 34, 0.2); color: var(--warn); }
  </style>
</head>
<body>
  <header class="top">
    <h1>IND-Quant-Alpha</h1>
    <div>
      <a href="{{ url_for('settings') }}">Settings</a>
      <a href="{{ url_for('logout') }}">Log out</a>
    </div>
  </header>
  <div class="main">
    <div class="grid">
      <div class="card">
        <h3>Status</h3>
        <div class="val" id="status">—</div>
      </div>
      <div class="card">
        <h3>Mode</h3>
        <div class="val" id="mode">Backtest</div>
      </div>
      <div class="card">
        <h3>US Bias</h3>
        <div class="val" id="usBias">—</div>
      </div>
      <div class="card">
        <h3>Sentiment</h3>
        <div class="val" id="sentiment">—</div>
      </div>
      <div class="card">
        <h3>Price</h3>
        <div class="val" id="price">—</div>
      </div>
      <div class="card">
        <h3>P&L</h3>
        <div class="val" id="pnl">—</div>
      </div>
      <div class="card">
        <h3>Trades today</h3>
        <div class="val" id="tradesToday">0 / 3</div>
      </div>
    </div>

    <div class="actions">
      <button type="button" class="btn btn-primary" id="btnStart" onclick="startTrading()">Start Trading</button>
      <button type="button" class="btn btn-secondary" id="btnStop" onclick="stopTrading()" disabled>Stop Trading</button>
      <button type="button" class="btn btn-danger" id="btnKill" onclick="killSwitch()">Kill Switch</button>
    </div>

    <div class="live-pane">
      <h2>Live</h2>
      <p class="countdown">Auto-close: <span id="autoCloseTime">14:30</span> IST — <span id="countdown">—</span></p>
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Qty</th>
            <th>P&L</th>
          </tr>
        </thead>
        <tbody id="positionsBody">
          <tr><td colspan="3">No positions</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const POLL_MS = 8000;
    let pollTimer = null;

    function api(path, options = {}) {
      return fetch(path, { ...options, headers: { 'Content-Type': 'application/json', ...options.headers } });
    }

    function updateUI(data) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = data.status || '—';
      statusEl.className = 'val status-badge ' + (
        data.status === 'RUNNING' ? 'status-running' :
        data.status === 'AUTO_CLOSED' ? 'status-auto' : 'status-stopped'
      );
      document.getElementById('mode').textContent = (data.mode || 'backtest').toUpperCase();
      document.getElementById('usBias').textContent = data.us_bias != null ? (data.us_bias === 1 ? 'Bullish' : data.us_bias === -1 ? 'Bearish' : 'Neutral') : '—';
      document.getElementById('sentiment').textContent = data.sentiment_score != null ? data.sentiment_score.toFixed(2) : '—';
      document.getElementById('price').textContent = data.price != null ? data.price.toFixed(2) : '—';
      document.getElementById('pnl').textContent = data.pnl != null ? data.pnl.toFixed(2) : '—';
      document.getElementById('pnl').className = 'val ' + (data.pnl > 0 ? 'positive' : data.pnl < 0 ? 'negative' : '');
      document.getElementById('tradesToday').textContent = (data.trade_count_today ?? 0) + ' / 3';
      document.getElementById('autoCloseTime').textContent = data.auto_close_time || '14:30';
      const mins = data.minutes_until_auto_close;
      document.getElementById('countdown').textContent = mins != null ? (mins + ' min left') : '—';

      const running = data.trading_on === true;
      document.getElementById('btnStart').disabled = running || data.status === 'AUTO_CLOSED';
      document.getElementById('btnStop').disabled = !running;

      const positions = data.positions || [];
      const tbody = document.getElementById('positionsBody');
      if (positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No positions</td></tr>';
      } else {
        tbody.innerHTML = positions.map(p =>
          '<tr><td>' + (p.symbol || '—') + '</td><td>' + (p.quantity ?? p.qty ?? '—') + '</td><td>' + (p.pnl ?? p.unrealized ?? '—') + '</td></tr>'
        ).join('');
      }
    }

    function poll() {
      api('/api/live?symbol=RELIANCE&mode=backtest')
        .then(r => r.json())
        .then(updateUI)
        .catch(() => {});
    }

    function startTrading() {
      api('/api/start', { method: 'POST' })
        .then(r => r.json())
        .then(d => { if (d.ok) poll(); })
        .then(() => { pollTimer = setInterval(poll, POLL_MS); })
        .catch(() => {});
    }

    function stopTrading() {
      api('/api/stop', { method: 'POST' }).then(() => {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = null;
        poll();
      });
    }

    function killSwitch() {
      if (!confirm('Close ALL open positions immediately?')) return;
      api('/api/kill', { method: 'POST' })
        .then(r => r.json())
        .then(() => { stopTrading(); poll(); });
    }

    poll();
  </script>
</body>
</html>
