{% extends "base_dashboard.html" %}
{% block content %}
<div class="fade-in ai-agent-dashboard">
  <!-- GLOBAL MODE SELECTOR -->
  <div class="card mb-3">
    <div class="card-body py-3">
      <div class="row align-items-center g-3">
        <div class="col-auto">
          <label class="form-label small text-muted mb-0">Trading Mode</label>
          <select class="form-select form-select-sm" id="trading-mode-select" style="min-width: 280px;">
            <option value="agent">ü§ñ AI Mode (Auto Trade)</option>
            <option value="manual" selected>üßç‚Äç‚ôÇÔ∏è Manual Mode (User Selects Strikes)</option>
          </select>
        </div>
        <div class="col-auto">
          <span class="badge px-3 py-2 rounded-pill bg-secondary bg-opacity-50" id="trading-mode-badge">Manual Mode</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION 1 ‚Äî USER CAPITAL SETTINGS (TOP BAR) -->
  <div class="card mb-4">
    <div class="card-header d-flex flex-wrap align-items-center gap-3">
      <span class="material-icons-round text-primary-custom">account_balance_wallet</span>
      <span>Capital & Risk</span>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label small text-muted">Total Capital (‚Çπ)</label>
          <input type="number" class="form-control" id="total-capital" placeholder="e.g. 100000" min="0" value="100000" step="1000">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Risk Per Trade (%)</label>
          <input type="number" class="form-control" id="risk-pct" placeholder="2" min="0" max="100" value="2" step="0.5">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted d-block">Mode</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="trade-mode" id="mode-intraday" value="intraday" checked>
            <label class="btn btn-outline-secondary btn-sm" for="mode-intraday">Intraday</label>
            <input type="radio" class="btn-check" name="trade-mode" id="mode-btst" value="btst">
            <label class="btn btn-outline-secondary btn-sm" for="mode-btst">BTST</label>
          </div>
        </div>
        <div class="col-md-3 d-flex align-items-center">
          <div class="metric-item flex-grow-1 py-2 px-3">
            <span class="metric-label">Max Risk Per Trade</span>
            <span class="metric-value d-block" id="max-risk-value">‚Çπ2,000</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INDEX OPPORTUNITIES (Capital Friendly) -->
  <div class="card mb-4" id="index-opportunities-block">
    <div class="card-header d-flex align-items-center gap-2" style="background: rgba(156, 39, 176, 0.2); color: #ce93d8;">
      <span class="material-icons-round">show_chart</span>
      <span>Index Opportunities (Capital Friendly)</span>
    </div>
    <div class="card-body">
      <div id="index-opportunities-loading" class="text-center text-muted py-3">Loading index bias‚Ä¶</div>
      <div id="index-opportunities-content" class="d-none">
        <div id="index-ai-mode-msg" class="alert border-0 small d-none mb-3" style="background: rgba(168, 199, 250, 0.12);">
          AI will automatically select best strike based on capital, risk %, and live market conditions.
          <div class="mt-2"><button type="button" class="btn btn-sm btn-primary" id="index-allow-ai-trade-btn">Allow AI to Trade Index</button></div>
        </div>
        <div id="index-no-direction-msg" class="alert alert-secondary border-0 small d-none">
          Market lacks clear direction. Wait for better setup.
        </div>
        <div id="index-nifty-section" class="mb-4 d-none">
          <h6 class="d-flex align-items-center gap-2 mb-2">
            <span class="badge bg-primary bg-opacity-25" id="index-nifty-label">NIFTY ‚Äì Bullish</span>
            <span class="badge bg-success bg-opacity-25" id="index-nifty-confidence">‚Äî%</span>
          </h6>
          <p class="small text-muted mb-2" id="index-nifty-reason">‚Äî</p>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0 index-options-table">
              <thead class="table-dark"><tr><th class="index-select-th">Select</th><th>Option</th><th>Strike</th><th>Premium</th><th>Lot Size</th><th>Total Cost</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="index-nifty-tbody"></tbody>
            </table>
          </div>
        </div>
        <div id="index-banknifty-section" class="d-none">
          <h6 class="d-flex align-items-center gap-2 mb-2">
            <span class="badge bg-primary bg-opacity-25" id="index-banknifty-label">BANK NIFTY ‚Äì Bullish</span>
            <span class="badge bg-success bg-opacity-25" id="index-banknifty-confidence">‚Äî%</span>
          </h6>
          <p class="small text-muted mb-2" id="index-banknifty-reason">‚Äî</p>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0 index-options-table">
              <thead class="table-dark"><tr><th class="index-select-th">Select</th><th>Option</th><th>Strike</th><th>Premium</th><th>Lot Size</th><th>Total Cost</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="index-banknifty-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION 2 ‚Äî AI TRADE CATEGORIES (4 BLOCKS) ‚Äî idea containers only, no checkboxes -->
  <div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card h-100">
        <div class="card-header bg-success-subtle border-0">
          <span class="material-icons-round me-2">trending_up</span>
          Momentum Trades
        </div>
        <div class="card-body p-2" id="block-momentum">
          <div class="text-center text-muted py-4" id="momentum-loading">Loading‚Ä¶</div>
          <div class="list-group list-group-flush" id="momentum-list"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card h-100">
        <div class="card-header bg-warning-subtle border-0">
          <span class="material-icons-round me-2">swap_horiz</span>
          Reversal Trades
        </div>
        <div class="card-body p-2" id="block-reversal">
          <div class="text-center text-muted py-4" id="reversal-loading">Loading‚Ä¶</div>
          <div class="list-group list-group-flush" id="reversal-list"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card h-100">
        <div class="card-header bg-primary bg-opacity-25 border-0 text-primary-custom">
          <span class="material-icons-round me-2">newspaper</span>
          News/Event Trades
        </div>
        <div class="card-body p-2" id="block-news">
          <div class="text-center text-muted py-4" id="news-loading">Loading‚Ä¶</div>
          <div class="list-group list-group-flush" id="news-list"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card h-100">
        <div class="card-header border-0" style="background: rgba(255, 193, 7, 0.2); color: #ffc107;">
          <span class="material-icons-round me-2">diamond</span>
          Gold & Silver ETF
        </div>
        <div class="card-body p-2" id="block-etf">
          <div class="text-center text-muted py-4" id="etf-loading">Loading‚Ä¶</div>
          <div class="list-group list-group-flush" id="etf-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- EXECUTION (Manual mode only: strike-level selection in options popup) -->
  <div class="card mb-4" id="execution-card">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
      <span class="small text-muted" id="execution-hint">Open a stock or index, select strikes in the options view, then execute.</span>
      <button type="button" class="btn btn-primary" id="execution-btn">
        <span class="material-icons-round me-1" style="vertical-align: middle;">send</span>
        <span id="execution-btn-text">Execute Selected Trades</span>
      </button>
    </div>
  </div>

  <!-- OPTIONS PANEL (RIGHT-SIDE OFFCANVAS) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="optionsPanel" aria-labelledby="optionsPanelLabel" style="width: min(100%, 520px);">
    <div class="offcanvas-header border-bottom">
      <h5 class="offcanvas-title d-flex align-items-center gap-2" id="optionsPanelLabel">
        <span class="material-icons-round">options</span>
        <span id="options-panel-stock">‚Äî</span> Options
      </h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column overflow-hidden">
      <!-- AI RECOMMENDATION PANEL -->
      <div class="p-3 border-bottom" style="background: rgba(168, 199, 250, 0.08);">
        <h6 class="text-primary-custom mb-2 d-flex align-items-center gap-2">
          <span class="material-icons-round fs-6">psychology</span>
          AI Suggested Trade
        </h6>
        <div class="small" id="ai-recommendation-content">
          <div class="d-flex flex-wrap gap-2 mb-2">
            <span class="badge bg-primary bg-opacity-25 text-primary-custom" id="rec-direction">‚Äî</span>
            <span class="badge bg-secondary bg-opacity-50" id="rec-strike">‚Äî</span>
            <span class="badge bg-success bg-opacity-25 text-success" id="rec-confidence">‚Äî</span>
            <span class="badge bg-secondary bg-opacity-50" id="rec-holding">‚Äî</span>
          </div>
          <p class="mb-0 text-muted" id="rec-reason">‚Äî</p>
        </div>
      </div>
      <!-- AI SUGGESTED ALGOS (Manual mode only: Detected Market + clickable tags ‚Üí Strategy Library) -->
      <div class="px-3 pt-2 pb-2 border-bottom d-none" id="options-suggested-algos-block" style="background: rgba(168, 199, 250, 0.06);">
        <p class="small mb-1"><strong>Detected Market:</strong> <span id="options-detected-market" class="text-primary-custom">‚Äî</span></p>
        <p class="small text-muted mb-2"><strong>Recommended strategies for <span id="options-suggested-algos-stock">‚Äî</span>:</strong></p>
        <div id="options-suggested-algos-tags" class="d-flex flex-wrap gap-2"></div>
      </div>
      <!-- AI MODE MESSAGE (shown only in AI Mode) -->
      <div class="px-3 pt-2 pb-2 d-none" id="options-ai-mode-msg" style="background: rgba(168, 199, 250, 0.1);">
        <p class="small text-muted mb-2" id="options-ai-mode-desc">AI will automatically select best strike based on capital, risk %, and live market conditions.</p>
        <p class="small mb-2 d-none" id="options-ai-selected-algo-line">ü§ñ AI Active Strategy: <strong id="options-ai-selected-algo-name">‚Äî</strong> <span id="options-ai-selected-algo-group" class="text-muted">(‚Äî)</span></p>
        <button type="button" class="btn btn-sm btn-primary" id="options-allow-ai-trade-btn">Allow AI to Trade This Strategy</button>
      </div>
      <!-- OPTIONS TABLE -->
      <div class="flex-grow-1 overflow-auto px-3 pb-3">
        <div class="alert alert-warning border-0 small d-none" id="no-options-warning">
          No contracts available within your risk. Increase capital or reduce risk %.
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-dark sticky-top">
              <tr>
                <th class="option-select-th">Select</th>
                <th>Type</th>
                <th>Strike</th>
                <th>Premium</th>
                <th>Lot</th>
                <th>Total Cost</th>
                <th>Risk</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="options-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .stock-card { transition: background 0.2s; }
  .stock-card:hover { background: var(--md-surface-2); }
  .ai-score-bar { height: 6px; border-radius: 3px; background: var(--md-surface-2); overflow: hidden; }
  .ai-score-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .row-ai-recommended { background: rgba(168, 199, 250, 0.12) !important; }
  .risk-badge-low { background: rgba(109, 213, 140, 0.2); color: var(--md-success); }
  .risk-badge-medium { background: rgba(253, 196, 0, 0.2); color: var(--md-warning); }
  .risk-badge-high { background: rgba(255, 180, 171, 0.2); color: var(--md-error); }
</style>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const totalCapitalEl = document.getElementById('total-capital');
  const riskPctEl = document.getElementById('risk-pct');
  const maxRiskValueEl = document.getElementById('max-risk-value');
  const optionsPanel = document.getElementById('optionsPanel');
  const optionsPanelStock = document.getElementById('options-panel-stock');
  const optionsTbody = document.getElementById('options-tbody');
  const noOptionsWarning = document.getElementById('no-options-warning');

  // Trading mode: "manual" | "agent" ‚Äî selection exists ONLY at strike level (in options popup / index tables)
  let tradingMode = 'manual';

  function setTradingMode(mode) {
    if (mode === tradingMode) return;
    tradingMode = mode;
    document.querySelectorAll('.trade-child-cb:checked').forEach(cb => { cb.checked = false; });
    updateTradingModeUI();
    refreshOptionsViewForMode();
    loadIndexOpportunities();
  }

  function updateTradingModeUI() {
    const badge = document.getElementById('trading-mode-badge');
    const execCard = document.getElementById('execution-card');
    const execHint = document.getElementById('execution-hint');
    if (tradingMode === 'agent') {
      if (badge) { badge.textContent = 'AI Mode'; badge.className = 'badge px-3 py-2 rounded-pill bg-primary bg-opacity-25 text-primary-custom'; }
      if (execCard) execCard.classList.add('d-none');
      if (execHint) execHint.textContent = 'Selections are made in each strategy\'s options view.';
      document.getElementById('index-ai-mode-msg').classList.remove('d-none');
      toggleIndexSelectColumn(false);
    } else {
      if (badge) { badge.textContent = 'Manual Mode'; badge.className = 'badge px-3 py-2 rounded-pill bg-secondary bg-opacity-50'; }
      if (execCard) execCard.classList.remove('d-none');
      if (execHint) execHint.textContent = 'Open a stock or index, select strikes in the options view, then execute.';
      document.getElementById('index-ai-mode-msg').classList.add('d-none');
      toggleIndexSelectColumn(true);
    }
  }

  function refreshOptionsViewForMode() {
    const stock = optionsPanelStock.textContent;
    if (stock && stock !== '‚Äî') loadOptionsForStock(stock);
  }

  document.getElementById('trading-mode-select').addEventListener('change', function() {
    setTradingMode(this.value);
  });

  document.getElementById('execution-btn').addEventListener('click', function() {
    const selected = getSelectedManualTrades();
    executeManualTrades(selected);
  });

  document.getElementById('options-allow-ai-trade-btn').addEventListener('click', function() {
    alert('Allow AI to Trade This Strategy: ' + (optionsPanelStock.textContent || 'Stock') + '. (Backend integration pending.)');
  });
  document.getElementById('index-allow-ai-trade-btn').addEventListener('click', function() {
    alert('Allow AI to Trade Index. (Backend integration pending.)');
  });

  function getSelectedManualTrades() {
    const trades = [];
    document.querySelectorAll('.trade-child-cb:checked').forEach(cb => {
      trades.push({ stock: cb.dataset.stock, strike: cb.dataset.strike, type: cb.dataset.optType, index: cb.dataset.index, category: cb.dataset.category });
    });
    return trades;
  }

  function executeManualTrades(selectedTrades) {
    if (selectedTrades.length === 0) {
      alert('Select one or more strikes (checkboxes in the options view) first.');
      return;
    }
    console.log('Execute manual trades:', selectedTrades);
    alert('Execute Selected Trades: ' + selectedTrades.length + ' strike(s) selected. (Backend integration pending.)');
  }

  function toggleIndexSelectColumn(show) {
    document.querySelectorAll('.index-select-th, .index-select-cell').forEach(function(el) {
      el.style.display = show ? '' : 'none';
    });
  }

  function getMaxRiskPerTrade() {
    const capital = parseFloat(totalCapitalEl.value) || 0;
    const pct = parseFloat(riskPctEl.value) || 0;
    return (capital * pct) / 100;
  }

  function formatMoney(n) {
    if (n >= 1e5) return '‚Çπ' + (n / 1e5).toFixed(1) + 'L';
    return '‚Çπ' + Math.round(n).toLocaleString('en-IN');
  }

  function updateMaxRiskDisplay() {
    const maxRisk = getMaxRiskPerTrade();
    maxRiskValueEl.textContent = formatMoney(maxRisk);
  }
  totalCapitalEl.addEventListener('input', updateMaxRiskDisplay);
  riskPctEl.addEventListener('input', updateMaxRiskDisplay);
  updateMaxRiskDisplay();

  let noStockFitsBudget = false;

  function getTotalCapital() {
    return parseFloat(totalCapitalEl.value) || 0;
  }

  function refreshIndexOpportunities() {
    loadIndexOpportunities();
  }

  async function loadIndexOpportunities() {
    const loadingEl = document.getElementById('index-opportunities-loading');
    const contentEl = document.getElementById('index-opportunities-content');
    const noDirectionEl = document.getElementById('index-no-direction-msg');
    const niftySection = document.getElementById('index-nifty-section');
    const bankNiftySection = document.getElementById('index-banknifty-section');
    if (loadingEl) loadingEl.classList.remove('d-none');
    if (contentEl) contentEl.classList.add('d-none');
    if (noDirectionEl) noDirectionEl.classList.add('d-none');

    // Index options: use TOTAL CAPITAL as budget (user pays premium √ó lot_size per contract)
    const indexBudget = getTotalCapital() || 5000;
    try {
      const biasRes = await fetch('/api/index-bias');
      const biasData = await biasRes.json();
      const niftyBias = biasData.niftyBias || 'NEUTRAL';
      const bankNiftyBias = biasData.bankNiftyBias || 'NEUTRAL';
      const reasons = (biasData.reasons || []).join('. ');
      const confidence = biasData.confidence != null ? biasData.confidence + '%' : '‚Äî';

      if (loadingEl) loadingEl.classList.add('d-none');
      if (contentEl) contentEl.classList.remove('d-none');

      const bothNeutral = niftyBias === 'NEUTRAL' && bankNiftyBias === 'NEUTRAL';
      const vixLow = (biasData.vixValue || 99) < 11;
      if (bothNeutral && vixLow) {
        if (noDirectionEl) { noDirectionEl.classList.remove('d-none'); noDirectionEl.textContent = 'Market lacks clear direction. Wait for better setup.'; }
        niftySection.classList.add('d-none');
        bankNiftySection.classList.add('d-none');
        return;
      }

      function renderIndexTable(tbodyId, options, budgetRupee, isRecommendedIdx, indexLabel) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        indexLabel = indexLabel || (tbodyId.indexOf('nifty') >= 0 && tbodyId.indexOf('bank') < 0 ? 'NIFTY' : 'BANKNIFTY');
        const isManual = tradingMode === 'manual';
        if (!options || options.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-muted small">No options in range.</td></tr>';
          return;
        }
        const rows = options.map((opt, idx) => {
          const totalCost = opt.totalCost != null ? opt.totalCost : (opt.lotCost != null ? opt.lotCost : (opt.premium * opt.lotSize));
          const canTrade = opt.canTrade != null ? opt.canTrade : (totalCost <= budgetRupee);
          const statusLabel = (opt.status != null ? opt.status : (canTrade ? 'Affordable' : 'Over Budget'));
          const statusHtml = canTrade ? '<span class="text-success-custom">' + statusLabel + '</span>' : '<span class="text-danger-custom">' + statusLabel + '</span>';
          const btnDisabled = isManual ? !canTrade : true;
          const tooltip = (isManual && !canTrade) ? ' title="Requires ' + formatMoney(totalCost) + ', exceeds your budget"' : '';
          const recommended = (isRecommendedIdx >= 0 && idx === isRecommendedIdx);
          const btnText = isManual ? (canTrade ? ('Buy ' + opt.type) : 'Over Budget') : '‚Äî';
          const selectTd = isManual ? '<td class="index-select-cell"><input type="checkbox" class="form-check-input trade-child-cb" data-strike="' + opt.strike + '" data-opt-type="' + opt.type + '" data-index="' + indexLabel + '" data-total-cost="' + totalCost + '" aria-label="Select"></td>' : '<td class="index-select-cell"></td>';
          return '<tr class="' + (recommended ? 'row-ai-recommended' : '') + '">' +
            selectTd +
            '<td><span class="badge ' + (opt.type === 'CE' ? 'bg-success bg-opacity-25' : 'bg-danger bg-opacity-25') + '">' + opt.type + '</span></td>' +
            '<td>' + opt.strike + '</td><td>' + opt.premium + '</td><td>' + opt.lotSize + '</td>' +
            '<td>' + formatMoney(totalCost) + '</td><td>' + statusHtml + '</td>' +
            '<td><button type="button" class="btn btn-sm ' + (opt.type === 'CE' ? 'btn-success' : 'btn-danger') + (btnDisabled ? ' disabled' : '') + '"' + tooltip + '>' + btnText + '</button></td></tr>';
        });
        tbody.innerHTML = rows.join('');
        toggleIndexSelectColumn(isManual);
      }

      if (niftyBias !== 'NEUTRAL') {
        const niftyOptRes = await fetch('/api/index-options/NIFTY?max_risk=' + encodeURIComponent(indexBudget));
        const niftyOptData = await niftyOptRes.json();
        document.getElementById('index-nifty-label').textContent = 'NIFTY ‚Äì ' + (niftyBias === 'BULLISH' ? 'Bullish' : 'Bearish') + ' Intraday Bias';
        document.getElementById('index-nifty-confidence').textContent = confidence;
        document.getElementById('index-nifty-reason').textContent = reasons || 'Above VWAP + breadth';
        niftySection.classList.remove('d-none');
        const opts = niftyOptData.options || [];
        const recIdx = opts.findIndex(o => (niftyOptData.aiRecommendation || {}).direction === 'BUY ' + o.type);
        renderIndexTable('index-nifty-tbody', opts, indexBudget, recIdx === -1 ? 0 : recIdx);
      } else {
        niftySection.classList.add('d-none');
      }

      if (bankNiftyBias !== 'NEUTRAL') {
        const bnOptRes = await fetch('/api/index-options/BANKNIFTY?max_risk=' + encodeURIComponent(indexBudget));
        const bnOptData = await bnOptRes.json();
        document.getElementById('index-banknifty-label').textContent = 'BANK NIFTY ‚Äì ' + (bankNiftyBias === 'BULLISH' ? 'Bullish' : 'Bearish') + ' Intraday Bias';
        document.getElementById('index-banknifty-confidence').textContent = confidence;
        document.getElementById('index-banknifty-reason').textContent = reasons || 'Banks leading / breadth';
        bankNiftySection.classList.remove('d-none');
        const opts = bnOptData.options || [];
        const recIdx = opts.findIndex(o => (bnOptData.aiRecommendation || {}).direction === 'BUY ' + o.type);
        renderIndexTable('index-banknifty-tbody', opts, indexBudget, recIdx === -1 ? 0 : recIdx);
      } else {
        bankNiftySection.classList.add('d-none');
      }

      if (niftyBias === 'NEUTRAL' && bankNiftyBias === 'NEUTRAL') {
        if (noDirectionEl) { noDirectionEl.classList.remove('d-none'); noDirectionEl.textContent = 'Market lacks clear direction. Wait for better setup.'; }
      }
    } catch (e) {
      if (loadingEl) { loadingEl.classList.add('d-none'); loadingEl.textContent = 'Error loading index data.'; }
      if (contentEl) contentEl.classList.remove('d-none');
      if (noDirectionEl) { noDirectionEl.classList.remove('d-none'); noDirectionEl.textContent = 'Could not load index bias.'; }
    }
  }

  totalCapitalEl.addEventListener('input', refreshIndexOpportunities);
  riskPctEl.addEventListener('input', refreshIndexOpportunities);
  // Load index opportunities on page load (block is always visible)
  loadIndexOpportunities();
  // Apply initial trading mode UI (manual by default)
  updateTradingModeUI();

  function renderStockCard(item, listId) {
    const trendIcon = item.trend === 'up' ? '‚Üë' : '‚Üì';
    const trendClass = item.trend === 'up' ? 'text-success-custom' : 'text-danger-custom';
    const score = Math.min(100, Math.max(0, item.score || 0));
    return `
      <div class="list-group-item list-group-item-action stock-card border-0 rounded-3 mb-2" data-stock="${item.stock}">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>${item.stock}</strong>
            <span class="ms-2 ${trendClass}">${trendIcon}</span>
          </div>
          <span class="badge bg-primary bg-opacity-25">${score}</span>
        </div>
        <div class="small text-muted mt-1">${item.signalSummary || '‚Äî'}</div>
        <div class="small mt-1">Volume: ${item.volumeSignal || 'Normal'}</div>
        <div class="ai-score-bar mt-2"><div class="ai-score-fill bg-primary" style="width:${score}%"></div></div>
        <button type="button" class="btn btn-sm btn-primary mt-2 w-100 view-options-btn" data-stock="${item.stock}">
          View Trade Options
        </button>
      </div>
    `;
  }

  function setLoading(blockId, loading) {
    const block = document.getElementById(blockId);
    const loadingEl = document.getElementById(blockId.replace('block-', '').replace('-list', '') + '-loading');
    const listEl = document.getElementById(blockId.replace('block-', '').replace('-list', '') + '-list');
    if (!listEl) return;
    if (loading) {
    } else {
      if (loadingEl) loadingEl.classList.add('d-none');
    }
  }

  const SIGNAL_CATEGORIES = ['momentum', 'reversal', 'news', 'etf'];

  async function loadSignals() {
    SIGNAL_CATEGORIES.forEach(cat => {
      const loadingEl = document.getElementById(cat + '-loading');
      const listEl = document.getElementById(cat + '-list');
      if (loadingEl) loadingEl.classList.remove('d-none');
      if (listEl) listEl.innerHTML = '';
    });
    try {
      const r = await fetch('/api/ai-trade-signals');
      const data = await r.json();
      SIGNAL_CATEGORIES.forEach(cat => {
        const loadingEl = document.getElementById(cat + '-loading');
        const listEl = document.getElementById(cat + '-list');
        const items = data[cat] || [];
        if (loadingEl) loadingEl.classList.add('d-none');
        if (listEl) {
          listEl.innerHTML = items.map(item => renderStockCard(item, cat)).join('');
          listEl.querySelectorAll('.view-options-btn').forEach(btn => {
            btn.addEventListener('click', function() { openOptionsPanel(this.dataset.stock); });
          });
        }
      });
    } catch (e) {
      SIGNAL_CATEGORIES.forEach(cat => {
        const loadingEl = document.getElementById(cat + '-loading');
        const listEl = document.getElementById(cat + '-list');
        if (loadingEl) { loadingEl.classList.add('d-none'); loadingEl.textContent = 'Error loading.'; }
        if (listEl) listEl.innerHTML = '<li class="list-group-item text-muted small">Failed to load.</li>';
      });
    }
  }

  function riskLevel(iv) {
    if (iv <= 18) return { label: 'Low', cls: 'risk-badge-low' };
    if (iv <= 22) return { label: 'Medium', cls: 'risk-badge-medium' };
    return { label: 'High', cls: 'risk-badge-high' };
  }

  function openOptionsPanel(stock) {
    optionsPanelStock.textContent = stock;
    const bsOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(optionsPanel);
    bsOffcanvas.show();
    loadOptionsForStock(stock);
  }

  async function loadOptionsForStock(stock) {
    optionsTbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Loading‚Ä¶</td></tr>';
    noOptionsWarning.classList.add('d-none');
    try {
      const r = await fetch('/api/options/' + encodeURIComponent(stock));
      const data = await r.json();
      const rec = data.aiRecommendation || {};
      document.getElementById('rec-direction').textContent = 'Buy ' + (rec.direction || '‚Äî');
      document.getElementById('rec-strike').textContent = (rec.strikePreference || 'ATM');
      document.getElementById('rec-confidence').textContent = (rec.confidence != null ? rec.confidence + '%' : '‚Äî');
      document.getElementById('rec-holding').textContent = rec.holdingTime || '‚Äî';
      document.getElementById('rec-reason').textContent = rec.reason || '‚Äî';

      const suggestedAlgos = data.suggestedAlgos || [];
      const selectedAlgoName = data.selectedAlgoName || null;
      const selectedAlgoGroup = data.selectedAlgoGroup || '';
      const detectedMarket = data.detectedMarket || [];
      const isManual = tradingMode === 'manual';
      const suggestedBlock = document.getElementById('options-suggested-algos-block');
      const suggestedStockEl = document.getElementById('options-suggested-algos-stock');
      const suggestedTagsEl = document.getElementById('options-suggested-algos-tags');
      const detectedMarketEl = document.getElementById('options-detected-market');
      const aiSelectedLine = document.getElementById('options-ai-selected-algo-line');
      const aiSelectedName = document.getElementById('options-ai-selected-algo-name');
      const aiSelectedGroupEl = document.getElementById('options-ai-selected-algo-group');
      if (isManual) {
        suggestedBlock.classList.remove('d-none');
        suggestedStockEl.textContent = data.stock || stock;
        if (detectedMarketEl) detectedMarketEl.textContent = detectedMarket.length ? detectedMarket.join(' + ') : '‚Äî';
        suggestedTagsEl.innerHTML = suggestedAlgos.length ? suggestedAlgos.map(function(a) {
          return '<a href="/dashboard/algo-library#' + (a.id || '') + '" class="badge bg-primary bg-opacity-25 text-primary-custom text-decoration-none" title="View strategy: ' + (a.name || a.id) + '">' + (a.name || a.id) + '</a>';
        }).join('') : '<span class="small text-muted">No strategies suggested for this setup.</span>';
      } else {
        suggestedBlock.classList.add('d-none');
        if (aiSelectedLine && aiSelectedName) {
          if (selectedAlgoName) {
            aiSelectedLine.classList.remove('d-none');
            aiSelectedName.textContent = selectedAlgoName;
            if (aiSelectedGroupEl) aiSelectedGroupEl.textContent = selectedAlgoGroup ? '(' + selectedAlgoGroup + ')' : '';
          } else {
            aiSelectedLine.classList.add('d-none');
          }
        }
      }

      const options = data.options || [];
      const maxRisk = getMaxRiskPerTrade();
      let anyWithinBudget = false;
      const recommendedDirection = (rec.direction || 'CE').toUpperCase();
      const firstRecommendedIdx = options.findIndex(o => o.type === recommendedDirection);

      const rows = options.map((opt, idx) => {
        const lotCost = (opt.premium || 0) * (opt.lotSize || 0);
        const withinBudget = lotCost <= maxRisk;
        if (withinBudget) anyWithinBudget = true;
        const risk = riskLevel(opt.iv || 18);
        const isRecommended = (idx === firstRecommendedIdx);
        const statusHtml = withinBudget
          ? '<span class="text-success-custom">Within Budget</span>'
          : '<span class="text-danger-custom">Over Budget</span>';
        const btnDisabled = isManual ? !withinBudget : true;
        const tooltip = (isManual && !withinBudget) ? ' title="Requires ' + formatMoney(lotCost) + ', exceeds your risk limit"' : '';
        const btnText = isManual ? (withinBudget ? ('Buy ' + opt.type) : 'Over Budget') : '‚Äî';
        const rowSelectTd = isManual ? '<td class="option-select-cell"><input type="checkbox" class="form-check-input trade-child-cb" data-stock="' + stock + '" data-strike="' + opt.strike + '" data-opt-type="' + opt.type + '" data-category="stock" aria-label="Select"></td>' : '<td class="option-select-cell"></td>';
        return `
          <tr class="${isRecommended ? 'row-ai-recommended' : ''}" data-recommended="${isRecommended}">
            ${rowSelectTd}
            <td><span class="badge ${opt.type === 'CE' ? 'bg-success bg-opacity-25' : 'bg-danger bg-opacity-25'}">${opt.type}</span></td>
            <td>${opt.strike}</td>
            <td>${opt.premium}</td>
            <td>${opt.lotSize}</td>
            <td>${formatMoney(lotCost)}</td>
            <td><span class="badge ${risk.cls}">${risk.label}</span></td>
            <td>${statusHtml}</td>
            <td>
              <button type="button" class="btn btn-sm ${opt.type === 'CE' ? 'btn-success' : 'btn-danger'} ${btnDisabled ? 'disabled' : ''}" ${tooltip}
                ${btnDisabled ? 'aria-disabled="true"' : ''}>${btnText}</button>
            </td>
          </tr>
        `;
      });

      optionsTbody.innerHTML = rows.join('');
      document.querySelectorAll('.option-select-th, .option-select-cell').forEach(function(el) {
        el.style.display = isManual ? '' : 'none';
      });
      const optionsAiMsg = document.getElementById('options-ai-mode-msg');
      if (optionsAiMsg) optionsAiMsg.classList.toggle('d-none', isManual);
      if (!anyWithinBudget && options.length > 0) {
        noOptionsWarning.classList.remove('d-none');
        noStockFitsBudget = true;
      }
      var recommendedRow = optionsTbody.querySelector('tr[data-recommended="true"]');
      if (recommendedRow) recommendedRow.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    } catch (e) {
      optionsTbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading options.</td></tr>';
    }
  }

  document.querySelectorAll('.view-options-btn').forEach(btn => {
    btn.addEventListener('click', function() { openOptionsPanel(this.dataset.stock); });
  });
  document.getElementById('optionsPanel').addEventListener('shown.bs.offcanvas', function() {
    document.querySelectorAll('#options-tbody tr.row-ai-recommended').forEach(function(row) {
      row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    });
  });

  loadSignals();
})();
</script>
{% endblock %}
