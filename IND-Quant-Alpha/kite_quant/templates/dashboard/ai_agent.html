{% extends "base_dashboard.html" %}
{% block content %}
<div class="fade-in ai-agent-dashboard">
  <!-- GLOBAL MODE SELECTOR -->
  <div class="card mb-3">
    <div class="card-body py-3">
      <div class="row align-items-center g-3">
        <div class="col-auto">
          <label class="form-label small text-muted mb-0">Trading Mode</label>
          <select class="form-select form-select-sm" id="trading-mode-select" style="min-width: 280px;">
            <option value="agent">ü§ñ AI Mode (Auto Trade)</option>
            <option value="manual" selected>üßç‚Äç‚ôÇÔ∏è Manual Mode (User Selects Strikes)</option>
          </select>
        </div>
        <div class="col-auto">
          <span class="badge px-3 py-2 rounded-pill bg-secondary bg-opacity-50" id="trading-mode-badge">Manual Mode</span>
        </div>
        <div class="col-auto ms-md-3 border-start ps-md-3">
          <label class="form-label small text-muted mb-0">Execution</label>
          <select class="form-select form-select-sm" id="execution-mode-select" style="min-width: 160px;" title="Paper = simulated orders, Live = real Zerodha orders">
            <option value="PAPER" selected>üìÑ Paper (simulated)</option>
            <option value="LIVE">üî¥ Live (real orders)</option>
          </select>
        </div>
        <div class="col-auto">
          <span class="small text-muted" id="execution-mode-hint">Paper: no real orders</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION 1 ‚Äî USER CAPITAL SETTINGS (TOP BAR) -->
  <div class="card mb-4">
    <div class="card-header d-flex flex-wrap align-items-center gap-3">
      <span class="material-icons-round text-primary-custom">account_balance_wallet</span>
      <span>Capital & Risk</span>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label small text-muted">Total Capital (‚Çπ)</label>
          <input type="number" class="form-control" id="total-capital" placeholder="e.g. 100000" min="0" value="100000" step="1000">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Risk Per Trade (%)</label>
          <input type="number" class="form-control" id="risk-pct" placeholder="2" min="0" max="100" value="2" step="0.5">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted d-block">Mode</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="trade-mode" id="mode-intraday" value="intraday" checked>
            <label class="btn btn-outline-secondary btn-sm" for="mode-intraday">Intraday</label>
            <input type="radio" class="btn-check" name="trade-mode" id="mode-btst" value="btst">
            <label class="btn btn-outline-secondary btn-sm" for="mode-btst">BTST</label>
          </div>
        </div>
        <div class="col-md-3 d-flex align-items-center">
          <div class="metric-item flex-grow-1 py-2 px-3">
            <span class="metric-label">Max Risk Per Trade</span>
            <span class="metric-value d-block" id="max-risk-value">‚Çπ2,000</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INDEX OPPORTUNITIES (Capital Friendly) -->
  <div class="card mb-4" id="index-opportunities-block">
    <div class="card-header d-flex align-items-center gap-2" style="background: rgba(156, 39, 176, 0.2); color: #ce93d8;">
      <span class="material-icons-round">show_chart</span>
      <span>Index Opportunities (Capital Friendly)</span>
    </div>
    <div class="card-body">
      <div id="index-opportunities-loading" class="text-center text-muted py-3">Loading index bias‚Ä¶</div>
      <div id="index-opportunities-content" class="d-none">
        <div id="index-ai-mode-msg" class="alert border-0 small d-none mb-3" style="background: rgba(168, 199, 250, 0.12);">
          AI will automatically select best strike based on capital, risk %, and live market conditions.
          <div class="mt-2"><button type="button" class="btn btn-sm btn-primary" id="index-allow-ai-trade-btn">Allow AI to Trade Index</button></div>
        </div>
        <div id="index-no-direction-msg" class="alert alert-secondary border-0 small d-none">
          Market lacks clear direction. Wait for better setup.
        </div>
        <div class="row g-3" id="index-recommendation-cards">
          <div class="col-md-6 d-none" id="index-nifty-card-wrap">
            <div class="card border-primary border-opacity-50 h-100" id="index-nifty-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge bg-primary bg-opacity-25" id="index-nifty-instrument">NIFTY</span>
                  <span class="badge bg-secondary bg-opacity-50" id="index-nifty-bias">‚Äî</span>
                </div>
                <p class="small mb-1"><strong>Strategy:</strong> <span id="index-nifty-strategy">‚Äî</span></p>
                <p class="small mb-1"><strong>Trade:</strong> <span id="index-nifty-trade">‚Äî</span> ¬∑ <span id="index-nifty-strike">‚Äî</span></p>
                <p class="small mb-1"><strong>Entry:</strong> <span id="index-nifty-entry" class="text-muted">‚Äî</span></p>
                <p class="small mb-1"><strong>Stop:</strong> <span id="index-nifty-stop" class="text-muted">‚Äî</span></p>
                <p class="small mb-2"><strong>Risk:</strong> ‚Çπ<span id="index-nifty-risk">‚Äî</span> ¬∑ <strong>Lots:</strong> <span id="index-nifty-lots">‚Äî</span></p>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-success btn-sm flex-grow-1 index-approve-btn" data-index="NIFTY">Approve & Run</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm index-reject-btn" data-index="NIFTY">Reject</button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 d-none" id="index-banknifty-card-wrap">
            <div class="card border-primary border-opacity-50 h-100" id="index-banknifty-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge bg-primary bg-opacity-25" id="index-banknifty-instrument">BANK NIFTY</span>
                  <span class="badge bg-secondary bg-opacity-50" id="index-banknifty-bias">‚Äî</span>
                </div>
                <p class="small mb-1"><strong>Strategy:</strong> <span id="index-banknifty-strategy">‚Äî</span></p>
                <p class="small mb-1"><strong>Trade:</strong> <span id="index-banknifty-trade">‚Äî</span> ¬∑ <span id="index-banknifty-strike">‚Äî</span></p>
                <p class="small mb-1"><strong>Entry:</strong> <span id="index-banknifty-entry" class="text-muted">‚Äî</span></p>
                <p class="small mb-1"><strong>Stop:</strong> <span id="index-banknifty-stop" class="text-muted">‚Äî</span></p>
                <p class="small mb-2"><strong>Risk:</strong> ‚Çπ<span id="index-banknifty-risk">‚Äî</span> ¬∑ <strong>Lots:</strong> <span id="index-banknifty-lots">‚Äî</span></p>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-success btn-sm flex-grow-1 index-approve-btn" data-index="BANKNIFTY">Approve & Run</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm index-reject-btn" data-index="BANKNIFTY">Reject</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION 2 ‚Äî AI TRADE CATEGORIES (4 BLOCKS) ‚Äî idea containers only, no checkboxes -->
  <div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card h-100">
        <div class="card-header bg-success-subtle border-0">
          <span class="material-icons-round me-2">trending_up</span>
          Momentum Trades
        </div>
        <div class="card-body p-2" id="block-momentum">
          <div class="text-center text-muted py-4" id="momentum-loading">Loading‚Ä¶</div>
          <div class="list-group list-group-flush" id="momentum-list"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card h-100">
        <div class="card-header bg-warning-subtle border-0">
          <span class="material-icons-round me-2">swap_horiz</span>
          Reversal Trades
        </div>
        <div class="card-body p-2" id="block-reversal">
          <div class="text-center text-muted py-4" id="reversal-loading">Loading‚Ä¶</div>
          <div class="list-group list-group-flush" id="reversal-list"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card h-100">
        <div class="card-header bg-primary bg-opacity-25 border-0 text-primary-custom">
          <span class="material-icons-round me-2">newspaper</span>
          News/Event Trades
        </div>
        <div class="card-body p-2" id="block-news">
          <div class="text-center text-muted py-4" id="news-loading">Loading‚Ä¶</div>
          <div class="list-group list-group-flush" id="news-list"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card h-100">
        <div class="card-header border-0" style="background: rgba(255, 193, 7, 0.2); color: #ffc107;">
          <span class="material-icons-round me-2">diamond</span>
          Gold & Silver ETF
        </div>
        <div class="card-body p-2" id="block-etf">
          <div class="text-center text-muted py-4" id="etf-loading">Loading‚Ä¶</div>
          <div class="list-group list-group-flush" id="etf-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- EXECUTION (Manual mode only: strike-level selection in options popup) -->
  <div class="card mb-4" id="execution-card">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
      <span class="small text-muted" id="execution-hint">Open a stock or index, select strikes in the options view, then execute.</span>
      <button type="button" class="btn btn-primary" id="execution-btn">
        <span class="material-icons-round me-1" style="vertical-align: middle;">send</span>
        <span id="execution-btn-text">Execute Selected Trades</span>
      </button>
    </div>
  </div>

  <!-- ACTIVE SESSIONS & ENGINE CONTROL (Live terminal view) -->
  <div class="card mb-4 border-warning border-opacity-50">
    <div class="card-header d-flex align-items-center gap-2" style="background: rgba(255, 193, 7, 0.15);">
      <span class="material-icons-round">settings_input_antenna</span>
      <span>Active Sessions & Engine Control</span>
    </div>
    <div class="card-body">
      <!-- Engine status line: running, market, next scan, session count -->
      <div id="engine-status-line" class="d-flex flex-wrap align-items-center gap-3 mb-3 py-2 px-3 rounded" style="background: rgba(0,0,0,0.04);">
        <span class="small text-muted">Engine:</span>
        <span class="badge bg-success bg-opacity-25 text-success" id="engine-status-badge">Running</span>
        <span class="small text-muted">Market:</span>
        <span class="badge bg-secondary bg-opacity-50" id="engine-market-badge">‚Äî</span>
        <span class="small text-muted">Last tick:</span>
        <span class="badge bg-secondary bg-opacity-50" id="engine-last-tick">‚Äî</span>
        <span class="small text-muted">Next scan in:</span>
        <span class="badge bg-primary bg-opacity-25" id="engine-next-scan">‚Äî</span>
        <span class="small text-muted">Active sessions:</span>
        <span class="badge bg-info bg-opacity-25" id="engine-active-count">0</span>
        <span class="ms-auto">
          <button type="button" class="btn btn-danger btn-sm" id="engine-kill-btn" title="Halt all LIVE/PAPER trading">STOP ALL TRADING</button>
          <button type="button" class="btn btn-success btn-sm" id="engine-start-btn" title="Resume engine">RESUME ENGINE</button>
        </span>
      </div>
      <div class="small text-muted mb-2">Active sessions (live state):</div>
      <div id="active-sessions-list" class="d-flex flex-column gap-3">
        <div class="text-muted small py-2" id="active-sessions-empty">No active sessions.</div>
      </div>
    </div>
  </div>

  <!-- OPTIONS PANEL (RIGHT-SIDE OFFCANVAS) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="optionsPanel" aria-labelledby="optionsPanelLabel" style="width: min(100%, 520px);">
    <div class="offcanvas-header border-bottom">
      <h5 class="offcanvas-title d-flex align-items-center gap-2" id="optionsPanelLabel">
        <span class="material-icons-round">options</span>
        <span id="options-panel-stock">‚Äî</span> Options
      </h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0 d-flex flex-column overflow-hidden">
      <!-- AI RECOMMENDATION PANEL -->
      <div class="p-3 border-bottom" style="background: rgba(168, 199, 250, 0.08);">
        <h6 class="text-primary-custom mb-2 d-flex align-items-center gap-2">
          <span class="material-icons-round fs-6">psychology</span>
          AI Suggested Trade
        </h6>
        <div class="small" id="ai-recommendation-content">
          <div class="d-flex flex-wrap gap-2 mb-2">
            <span class="badge bg-primary bg-opacity-25 text-primary-custom" id="rec-direction">‚Äî</span>
            <span class="badge bg-secondary bg-opacity-50" id="rec-strike">‚Äî</span>
            <span class="badge bg-success bg-opacity-25 text-success" id="rec-confidence">‚Äî</span>
            <span class="badge bg-secondary bg-opacity-50" id="rec-holding">‚Äî</span>
          </div>
          <p class="mb-0 text-muted" id="rec-reason">‚Äî</p>
        </div>
      </div>
      <!-- AI SUGGESTED ALGOS (Manual mode only: Detected Market + clickable tags ‚Üí Strategy Library) -->
      <div class="px-3 pt-2 pb-2 border-bottom d-none" id="options-suggested-algos-block" style="background: rgba(168, 199, 250, 0.06);">
        <p class="small mb-1"><strong>Detected Market:</strong> <span id="options-detected-market" class="text-primary-custom">‚Äî</span></p>
        <p class="small text-muted mb-2"><strong>Recommended strategies for <span id="options-suggested-algos-stock">‚Äî</span>:</strong></p>
        <div id="options-suggested-algos-tags" class="d-flex flex-wrap gap-2"></div>
      </div>
      <!-- AI MODE MESSAGE (shown only in AI Mode) -->
      <div class="px-3 pt-2 pb-2 d-none" id="options-ai-mode-msg" style="background: rgba(168, 199, 250, 0.1);">
        <p class="small text-muted mb-2" id="options-ai-mode-desc">AI will select instrument, strategy, strike, and size, then execute automatically. No approval step.</p>
        <p class="small mb-2 d-none" id="options-ai-selected-algo-line">ü§ñ AI Active Strategy: <strong id="options-ai-selected-algo-name">‚Äî</strong> <span id="options-ai-selected-algo-group" class="text-muted">(‚Äî)</span></p>
        <button type="button" class="btn btn-sm btn-primary" id="options-allow-ai-trade-btn">Allow AI to Trade This Strategy</button>
      </div>
      <!-- AI TRADE RECOMMENDATION CARD (replaces strike selection: AI picks, user Approve/Reject) -->
      <div class="flex-grow-1 overflow-auto px-3 pb-3">
        <div class="text-center text-muted py-4 d-none" id="options-recommendation-loading">Loading AI recommendation‚Ä¶</div>
        <div class="alert alert-warning border-0 small d-none" id="no-recommendation-warning">No recommendation for this instrument (e.g. neutral bias).</div>
        <div class="d-none" id="options-recommendation-card-wrap">
          <div class="card border-primary border-opacity-50 mb-3" id="options-recommendation-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-primary bg-opacity-25" id="rec-card-instrument">‚Äî</span>
                <span class="badge bg-secondary bg-opacity-50" id="rec-card-bias">‚Äî</span>
              </div>
              <p class="small mb-1"><strong>Strategy:</strong> <span id="rec-card-strategy">‚Äî</span></p>
              <p class="small mb-1"><strong>Trade:</strong> <span id="rec-card-trade-type">‚Äî</span> ¬∑ <span id="rec-card-strike">‚Äî</span></p>
              <p class="small mb-1"><strong>Entry:</strong> <span id="rec-card-entry" class="text-muted">‚Äî</span></p>
              <p class="small mb-1"><strong>Stop:</strong> <span id="rec-card-stop" class="text-muted">‚Äî</span></p>
              <p class="small mb-1"><strong>Reward:</strong> <span id="rec-card-reward" class="text-muted">‚Äî</span></p>
              <p class="small mb-2"><strong>Risk:</strong> ‚Çπ<span id="rec-card-risk">‚Äî</span> ¬∑ <strong>Lots:</strong> <span id="rec-card-lots">‚Äî</span></p>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-success flex-grow-1" id="options-approve-trade-btn">Approve & Run Trade</button>
                <button type="button" class="btn btn-outline-secondary" id="options-reject-trade-btn">Reject</button>
              </div>
            </div>
          </div>
          <p class="small text-muted mb-0">AI selected this instrument, strategy, strike, and size. You only approve or reject.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .stock-card { transition: background 0.2s; }
  .stock-card:hover { background: var(--md-surface-2); }
  .ai-score-bar { height: 6px; border-radius: 3px; background: var(--md-surface-2); overflow: hidden; }
  .ai-score-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .row-ai-recommended { background: rgba(168, 199, 250, 0.12) !important; }
  .risk-badge-low { background: rgba(109, 213, 140, 0.2); color: var(--md-success); }
  .risk-badge-medium { background: rgba(253, 196, 0, 0.2); color: var(--md-warning); }
  .risk-badge-high { background: rgba(255, 180, 171, 0.2); color: var(--md-error); }
</style>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const totalCapitalEl = document.getElementById('total-capital');
  const riskPctEl = document.getElementById('risk-pct');
  const maxRiskValueEl = document.getElementById('max-risk-value');
  const optionsPanel = document.getElementById('optionsPanel');
  const optionsPanelStock = document.getElementById('options-panel-stock');
  let currentRecommendation = null;

  // Trading mode: "manual" | "agent" ‚Äî selection exists ONLY at strike level (in options popup / index tables)
  let tradingMode = 'manual';

  function setTradingMode(mode) {
    if (mode === tradingMode) return;
    tradingMode = mode;
    document.querySelectorAll('.trade-child-cb:checked').forEach(cb => { cb.checked = false; });
    updateTradingModeUI();
    refreshOptionsViewForMode();
    loadIndexOpportunities();
  }

  function updateTradingModeUI() {
    const badge = document.getElementById('trading-mode-badge');
    const execCard = document.getElementById('execution-card');
    const execHint = document.getElementById('execution-hint');
    const indexAiMsg = document.getElementById('index-ai-mode-msg');
    const indexCardButtons = document.querySelectorAll('#index-recommendation-cards .d-flex.gap-2');
    if (tradingMode === 'agent') {
      if (badge) { badge.textContent = 'AI Mode'; badge.className = 'badge px-3 py-2 rounded-pill bg-primary bg-opacity-25 text-primary-custom'; }
      if (execCard) execCard.classList.add('d-none');
      if (execHint) execHint.textContent = 'AI selects and executes trades. No approval step.';
      if (indexAiMsg) indexAiMsg.classList.remove('d-none');
      indexCardButtons.forEach(function(el) { el.style.display = 'none'; });
    } else {
      if (badge) { badge.textContent = 'Manual Mode'; badge.className = 'badge px-3 py-2 rounded-pill bg-secondary bg-opacity-50'; }
      if (execCard) execCard.classList.remove('d-none');
      if (execHint) execHint.textContent = 'Open a stock or index; AI shows one recommendation. Approve or reject only.';
      if (indexAiMsg) indexAiMsg.classList.add('d-none');
      indexCardButtons.forEach(function(el) { el.style.display = ''; });
    }
  }

  function refreshOptionsViewForMode() {
    const stock = optionsPanelStock.textContent;
    if (stock && stock !== '‚Äî') loadRecommendationForInstrument(stock);
  }

  document.getElementById('trading-mode-select').addEventListener('change', function() {
    setTradingMode(this.value);
  });
  function getExecutionMode() {
    const sel = document.getElementById('execution-mode-select');
    return (sel && sel.value) ? sel.value.toUpperCase() : 'PAPER';
  }
  document.getElementById('execution-mode-select').addEventListener('change', function() {
    const hint = document.getElementById('execution-mode-hint');
    if (hint) hint.textContent = this.value === 'LIVE' ? 'Live: real Zerodha orders' : 'Paper: no real orders';
  });

  function loadEngineStatus() {
    return fetch('/api/engine/status').then(function(r) { return r.json(); }).then(function(data) {
      var running = data.running !== false && data.engine_enabled !== false;
      var badge = document.getElementById('engine-status-badge');
      if (badge) {
        badge.textContent = running ? 'Running' : 'Paused';
        badge.className = running ? 'badge bg-success bg-opacity-25 text-success' : 'badge bg-danger bg-opacity-25 text-danger';
      }
      var marketBadge = document.getElementById('engine-market-badge');
      if (marketBadge) {
        marketBadge.textContent = data.market_open ? 'Open' : 'Closed';
        marketBadge.className = data.market_open ? 'badge bg-success bg-opacity-25 text-success' : 'badge bg-secondary bg-opacity-50';
      }
      var lastTickEl = document.getElementById('engine-last-tick');
      if (lastTickEl) {
        lastTickEl.textContent = data.last_tick ? (function() { try { var d = new Date(data.last_tick); return d.toLocaleTimeString(); } catch (e) { return '‚Äî'; } })() : '‚Äî';
      }
      var nextScan = document.getElementById('engine-next-scan');
      if (nextScan) {
        var sec = data.next_scan_sec != null ? data.next_scan_sec : data.next_scan_in_seconds;
        nextScan.textContent = sec != null ? (sec + 's') : '‚Äî';
      }
      var activeCount = document.getElementById('engine-active-count');
      if (activeCount) activeCount.textContent = data.active_session_count != null ? data.active_session_count : 0;
    }).catch(function() {});
  }
  function formatTimeInTrade(entryTimeIso) {
    if (!entryTimeIso) return '‚Äî';
    try {
      var entry = new Date(entryTimeIso);
      var sec = Math.floor((Date.now() - entry.getTime()) / 1000);
      if (sec < 60) return sec + 's';
      if (sec < 3600) return Math.floor(sec / 60) + 'm';
      return Math.floor(sec / 3600) + 'h ' + (Math.floor((sec % 3600) / 60)) + 'm';
    } catch (e) { return '‚Äî'; }
  }
  function computeUnrealizedPnl(trade, ltp) {
    if (trade == null || ltp == null) return { pnl: null, pct: null };
    var entry = parseFloat(trade.entry_price);
    var qty = parseInt(trade.qty, 10) || 0;
    var side = (trade.side || 'BUY').toUpperCase();
    if (!entry || !qty) return { pnl: null, pct: null };
    var pnl = (side === 'BUY') ? (ltp - entry) * qty : (entry - ltp) * qty;
    var pct = ((ltp - entry) / entry) * 100;
    if (side === 'SELL') pct = -pct;
    return { pnl: Math.round(pnl * 100) / 100, pct: Math.round(pct * 100) / 100 };
  }
  function fetchLtpAndUpdate(sessionId, symbol, exchange, trade, ltpEl, pnlEl) {
    if (!symbol || !ltpEl) return;
    fetch('/api/quote?symbol=' + encodeURIComponent(symbol) + '&exchange=' + encodeURIComponent(exchange || 'NSE'))
      .then(function(r) { return r.json(); })
      .then(function(q) {
        var ltp = parseFloat(q.last || q.last_price) || 0;
        ltpEl.textContent = ltp > 0 ? ltp.toFixed(2) : '‚Äî';
        if (trade && pnlEl) {
          var u = computeUnrealizedPnl(trade, ltp);
          if (u.pnl != null) {
            pnlEl.textContent = (u.pnl >= 0 ? '+' : '') + u.pnl + ' (' + (u.pct >= 0 ? '+' : '') + u.pct + '%)';
            pnlEl.className = u.pnl >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
          }
        }
      })
      .catch(function() { ltpEl.textContent = '‚Äî'; });
  }
  function renderSessionCard(s) {
    var ct = s.current_trade;
    var isStopped = s.status === 'STOPPED';
    var status = isStopped ? 'STOPPED' : (s.session_status || (ct ? 'IN_TRADE' : 'WAITING_FOR_ENTRY'));
    var statusClass = status === 'STOPPED' ? 'secondary' : (status === 'IN_TRADE' ? 'warning' : (status === 'WAITING_FOR_ENTRY' ? 'info' : 'secondary'));
    var dailyPnl = s.daily_pnl != null ? Number(s.daily_pnl) : 0;
    var dailyPnlClass = dailyPnl >= 0 ? 'text-success' : 'text-danger';
    var card = document.createElement('div');
    card.className = 'card border border-opacity-50 active-session-card' + (isStopped ? ' bg-dark bg-opacity-10' : '');
    var sessionId = s.sessionId || s.session_id || '';
    card.setAttribute('data-session-id', sessionId);
    var actionButton = isStopped ?
      '<div class="d-flex gap-2"><button type="button" class="btn btn-outline-success btn-sm session-resume-btn" data-session-id="' + sessionId + '">Resume</button>' +
      '<button type="button" class="btn btn-outline-danger btn-sm session-delete-btn" data-session-id="' + sessionId + '">Delete</button></div>' :
      '<button type="button" class="btn btn-outline-danger btn-sm session-kill-btn" data-session-id="' + sessionId + '">Stop</button>';
    card.innerHTML =
      '<div class="card-body py-3">' +
        '<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">' +
          '<div class="d-flex flex-wrap align-items-center gap-2">' +
            '<strong>' + (s.instrument || '‚Äî') + '</strong>' +
            '<span class="badge bg-opacity-50 ' + (s.execution_mode === "LIVE" ? "bg-danger" : "bg-secondary") + '">' + (s.execution_mode || 'PAPER') + '</span>' +
            '<span class="badge bg-' + statusClass + ' bg-opacity-25">' + status.replace(/_/g, ' ') + '</span>' +
          '</div>' +
          actionButton +
        '</div>' +
        '<div class="small text-muted mb-2">' +
          (s.ai_mode_enabled ? '<span class="badge bg-primary bg-opacity-25 text-primary me-1" title="AI auto-selects strategies every ' + (s.ai_check_interval_minutes || 15) + ' min">ü§ñ AI Mode</span> ' : '') +
          'Strategy: <strong>' + (s.ai_recommended_strategy || s.strategy_name || '‚Äî') + '</strong>' + 
          (s.ai_recommendation_confidence ? ' <span class="badge bg-success bg-opacity-25 text-success-custom" title="' + (s.ai_recommendation_reasoning || '') + '">' + s.ai_recommendation_confidence + '</span>' : '') + 
          ' &nbsp;|&nbsp; Trades: ' + (s.trades_taken_today ?? 0) + '/' + (s.max_trades_allowed ?? 10) + ' &nbsp;|&nbsp; Cutoff: ' + (s.cutoff_time || '‚Äî') + ' &nbsp;|&nbsp; <span class="' + dailyPnlClass + '">Daily P&L: ' + (dailyPnl >= 0 ? '+' : '') + dailyPnl + '</span></div>' +
        (isStopped ? '<div class="border-top pt-2 mt-2 small text-muted">Session is stopped. Resume to continue trading.</div>' : 
        (ct ? (
          '<div class="border-top pt-2 mt-2 small">' +
            '<div class="text-success fw-bold mb-2">IN TRADE</div>' +
            '<div class="row g-2">' +
              '<div class="col-6 col-md-4">Entry price: ' + (ct.entry_price != null ? '‚Çπ' + Number(ct.entry_price).toFixed(2) : '‚Äî') + '</div>' +
              '<div class="col-6 col-md-4">Current price: <span class="session-ltp fw-bold">‚Äî</span></div>' +
              '<div class="col-6 col-md-4">Stop loss: ' + (ct.stop_loss != null ? '‚Çπ' + Number(ct.stop_loss).toFixed(2) : '‚Äî') + '</div>' +
              '<div class="col-6 col-md-4">Target: ' + (ct.target != null ? '‚Çπ' + Number(ct.target).toFixed(2) : '‚Äî') + '</div>' +
              '<div class="col-6 col-md-4">Qty: ' + (ct.qty ?? '‚Äî') + '</div>' +
              '<div class="col-6 col-md-4">Entry time: ' + (ct.entry_time ? new Date(ct.entry_time).toLocaleTimeString() : '‚Äî') + '</div>' +
              '<div class="col-6 col-md-4">Time in trade: <span class="session-time-in-trade" data-entry-time="' + (ct.entry_time || '') + '">' + formatTimeInTrade(ct.entry_time) + '</span></div>' +
              '<div class="col-6 col-md-4">Unrealized P&L: <span class="session-unrealized-pnl">‚Äî</span></div>' +
            '</div>' +
          '</div>'
        ) : (
          (function() {
            var ed = s.entry_diagnostics || {};
            var lec = s.last_entry_check || {};
            var ts = (ed.last_check || lec.timestamp) ? new Date(ed.last_check || lec.timestamp).toLocaleTimeString() : '‚Äî';
            var strategy = ed.strategy || lec.strategy || s.strategy_name || '‚Äî';
            var ltp = ed.ltp != null ? Number(ed.ltp) : (s.current_ltp != null ? Number(s.current_ltp) : null);
            var livePriceStr = (ltp != null && !isNaN(ltp)) ? ('‚Çπ' + ltp.toFixed(2)) : '‚ö† Unable to fetch price';
            var entryPriceVal = ed.entry_price != null ? ed.entry_price : lec.entry_price;
            var entryPriceStr = entryPriceVal != null ? '‚Çπ' + Number(entryPriceVal).toFixed(2) : '‚Äî';
            var blockedReason = ed.blocked_reason || lec.block_reason || '';
            var conditions = ed.conditions || {};
            var canEnter = lec.can_enter;
            var riskApproved = lec.risk_approved;
            var riskReason = lec.risk_reason || '';
            var lots = lec.calculated_lots != null ? lec.calculated_lots : '';
            var statusLine = '';
            var statusClass = 'text-muted';
            if (canEnter && riskApproved) {
              statusLine = 'Ready ‚Äî entry possible' + (lots !== '' ? ' (lots: ' + lots + ')' : '');
              statusClass = 'text-success';
            } else if (blockedReason) {
              statusLine = 'Blocked: ' + blockedReason;
              statusClass = 'text-warning';
            } else if (canEnter && riskReason) {
              statusLine = 'Risk rejected: ' + riskReason;
              statusClass = 'text-danger';
            } else {
              statusLine = 'Waiting for next scan';
            }
            var conditionsHtml = '';
            if (Object.keys(conditions).length > 0) {
              conditionsHtml = '<div class="mt-2"><span class="text-muted small">Conditions:</span><ul class="small mb-0 mt-1 list-unstyled">';
              for (var k in conditions) {
                var v = conditions[k];
                var ok = v === true || v === 'true' || v === 1;
                conditionsHtml += '<li>' + (ok ? '‚úî' : '‚úñ') + ' ' + k.replace(/_/g, ' ') + '</li>';
              }
              conditionsHtml += '</ul></div>';
            }
            return '<div class="border-top pt-2 mt-2 small">' +
              '<div class="text-muted mb-2">Entry diagnostics (last check: ' + ts + ')</div>' +
              '<div class="row g-2 mb-1">' +
                '<div class="col-6 col-md-4">Live Price: ' + livePriceStr + '</div>' +
                '<div class="col-6 col-md-4">Entry Price: ' + entryPriceStr + '</div>' +
                '<div class="col-6 col-md-4">Strategy: ' + strategy + '</div>' +
              '</div>' +
              '<div class="' + statusClass + ' fw-bold">' + statusLine + '</div>' +
              (riskReason && !riskApproved && canEnter ? '<div class="text-danger small mt-1">Risk reason: ' + riskReason + '</div>' : '') +
              conditionsHtml +
              '<div class="text-muted small mt-1">Last scan: ' + (s.last_scan ? new Date(s.last_scan).toLocaleTimeString() : '‚Äî') + '</div>' +
            '</div>';
          })()
        ))) +
      '</div>';
    return card;
  }
  function loadActiveSessions() {
    return fetch('/api/trade-sessions').then(function(r) { return r.json(); }).then(function(data) {
      var list = document.getElementById('active-sessions-list');
      var empty = document.getElementById('active-sessions-empty');
      if (!list) return;
      var sessions = data.sessions || [];
      list.querySelectorAll('.active-session-card').forEach(function(el) { el.remove(); });
      if (sessions.length === 0) {
        empty.classList.remove('d-none');
        return;
      }
      empty.classList.add('d-none');
      sessions.forEach(function(s) {
        var card = renderSessionCard(s);
        list.appendChild(card);
        var killBtn = card.querySelector('.session-kill-btn');
        var resumeBtn = card.querySelector('.session-resume-btn');
        if (killBtn) {
          killBtn.addEventListener('click', function() {
            var id = this.getAttribute('data-session-id');
            if (!id || !confirm('Close open trade (if any) and stop this session?')) return;
            fetch('/api/trade-sessions/' + encodeURIComponent(id) + '/kill', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
              .then(function(r) { return r.json(); }).then(function(res) {
                if (res.ok) { loadActiveSessions(); loadEngineStatus(); } else { alert(res.error || 'Failed'); }
              }).catch(function() { alert('Failed to kill session'); });
          });
        }
        if (resumeBtn) {
          resumeBtn.addEventListener('click', function() {
            var id = this.getAttribute('data-session-id');
            if (!id || !confirm('Resume this stopped session?')) return;
            fetch('/api/trade-sessions/' + encodeURIComponent(id) + '/resume', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
              .then(function(r) { return r.json(); }).then(function(res) {
                if (res.ok) { loadActiveSessions(); loadEngineStatus(); } else { alert(res.error || 'Failed to resume'); }
              }).catch(function() { alert('Failed to resume session'); });
          });
        }
        var deleteBtn = card.querySelector('.session-delete-btn');
        var sessionId = s.sessionId || s.session_id || '';
        console.log('Looking for delete button, found:', deleteBtn, 'for session:', sessionId, 'status:', s.status);
        if (deleteBtn) {
          console.log('Attaching delete handler for:', sessionId);
          deleteBtn.addEventListener('click', function() {
            console.log('Delete button clicked for:', this.getAttribute('data-session-id'));
            var id = this.getAttribute('data-session-id');
            if (!id || !confirm('Permanently delete this session? This cannot be undone.')) return;
            fetch('/api/trade-sessions/' + encodeURIComponent(id) + '/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
              .then(function(r) { return r.json(); }).then(function(res) {
                if (res.ok) { 
                  console.log('Session deleted successfully:', id);
                  loadActiveSessions(); 
                  loadEngineStatus(); 
                } else { 
                  alert(res.error || 'Failed to delete'); 
                }
              }).catch(function(err) { 
                console.error('Delete error:', err);
                alert('Failed to delete session'); 
              });
          });
        } else {
          console.log('Delete button NOT found for session:', sessionId, 'Is stopped?', s.status === 'STOPPED');
        }
        if (s.status === "ACTIVE" && s.current_trade) {
          var exchange = (s.exchange || 'NSE').toUpperCase();
          var symbol = (exchange === 'NFO' ? s.tradingsymbol : null) || s.current_trade.symbol || s.tradingsymbol || s.instrument;
          var ltpEl = card.querySelector('.session-ltp');
          var pnlEl = card.querySelector('.session-unrealized-pnl');
          fetchLtpAndUpdate(sessionId, symbol, exchange, s.current_trade, ltpEl, pnlEl);
        }
      });
    }).catch(function() { return {}; });
  }
  setInterval(function() {
    document.querySelectorAll('.session-time-in-trade').forEach(function(el) {
      var t = el.getAttribute('data-entry-time');
      if (t) el.textContent = formatTimeInTrade(t);
    });
  }, 1000);
  document.getElementById('engine-kill-btn').addEventListener('click', function() {
    if (!confirm('Stop all LIVE and PAPER trading immediately?')) return;
    fetch('/api/engine/kill', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
      .then(function(r) { return r.json(); }).then(function(res) {
        if (res.ok) { loadEngineStatus(); }
      }).catch(function() {});
  });
  document.getElementById('engine-start-btn').addEventListener('click', function() {
    fetch('/api/engine/start', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
      .then(function(r) { return r.json(); }).then(function(res) {
        if (res.ok) { loadEngineStatus(); }
      }).catch(function() {});
  });
  setInterval(loadActiveSessions, 8000);
  setInterval(loadEngineStatus, 8000);

  document.getElementById('execution-btn').addEventListener('click', function() {
    document.getElementById('optionsPanel').querySelector('.offcanvas-title') && document.getElementById('optionsPanel').querySelector('.offcanvas-title').click();
    alert('Open a stock or index from the cards above; use Approve & Run Trade on the AI recommendation card.');
  });

  document.getElementById('options-allow-ai-trade-btn').addEventListener('click', function() {
    alert('Allow AI to Trade This Strategy: ' + (optionsPanelStock.textContent || 'Stock') + '. (Backend integration pending.)');
  });
  document.getElementById('index-allow-ai-trade-btn').addEventListener('click', function() {
    alert('Allow AI to Trade Index. (Backend integration pending.)');
  });

  function getMaxRiskPerTrade() {
    const capital = parseFloat(totalCapitalEl.value) || 0;
    const pct = parseFloat(riskPctEl.value) || 0;
    return (capital * pct) / 100;
  }

  function formatMoney(n) {
    if (n >= 1e5) return '‚Çπ' + (n / 1e5).toFixed(1) + 'L';
    return '‚Çπ' + Math.round(n).toLocaleString('en-IN');
  }

  function updateMaxRiskDisplay() {
    const maxRisk = getMaxRiskPerTrade();
    maxRiskValueEl.textContent = formatMoney(maxRisk);
  }
  totalCapitalEl.addEventListener('input', updateMaxRiskDisplay);
  riskPctEl.addEventListener('input', updateMaxRiskDisplay);
  updateMaxRiskDisplay();

  function getTotalCapital() {
    return parseFloat(totalCapitalEl.value) || 0;
  }

  function refreshIndexOpportunities() {
    loadIndexOpportunities();
  }

  let indexRecommendations = {};
  function fillIndexCard(prefix, rec) {
    if (!rec) return;
    const id = prefix;
    document.getElementById(id + '-instrument').textContent = rec.instrument || id;
    document.getElementById(id + '-bias').textContent = rec.marketBias || '‚Äî';
    document.getElementById(id + '-strategy').textContent = rec.strategyName || '‚Äî';
    document.getElementById(id + '-trade').textContent = rec.tradeType || '‚Äî';
    document.getElementById(id + '-strike').textContent = rec.suggestedStrike || '‚Äî';
    document.getElementById(id + '-entry').textContent = rec.entryCondition || '‚Äî';
    document.getElementById(id + '-stop').textContent = rec.stopLossLogic || '‚Äî';
    document.getElementById(id + '-risk').textContent = (rec.riskPerTrade != null ? Math.round(rec.riskPerTrade).toLocaleString('en-IN') : '‚Äî');
    document.getElementById(id + '-lots').textContent = rec.positionSizeLots != null ? rec.positionSizeLots : '‚Äî';
  }

  function loadIndexOpportunities() {
    var loadingEl = document.getElementById('index-opportunities-loading');
    var contentEl = document.getElementById('index-opportunities-content');
    var noDirectionEl = document.getElementById('index-no-direction-msg');
    var niftyWrap = document.getElementById('index-nifty-card-wrap');
    var bankNiftyWrap = document.getElementById('index-banknifty-card-wrap');
    if (loadingEl) loadingEl.classList.remove('d-none');
    if (contentEl) contentEl.classList.add('d-none');
    if (noDirectionEl) noDirectionEl.classList.add('d-none');
    var capital = getTotalCapital() || 5000;
    return fetch('/api/ai-trade-recommendations-index?capital=' + capital)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (loadingEl) loadingEl.classList.add('d-none');
        if (contentEl) contentEl.classList.remove('d-none');
        indexRecommendations = {};
        if (data.nifty) {
          indexRecommendations.NIFTY = data.nifty;
          fillIndexCard('index-nifty', data.nifty);
          if (niftyWrap) niftyWrap.classList.remove('d-none');
        } else { if (niftyWrap) niftyWrap.classList.add('d-none'); }
        if (data.banknifty) {
          indexRecommendations.BANKNIFTY = data.banknifty;
          fillIndexCard('index-banknifty', data.banknifty);
          if (bankNiftyWrap) bankNiftyWrap.classList.remove('d-none');
        } else { if (bankNiftyWrap) bankNiftyWrap.classList.add('d-none'); }
        if (!data.nifty && !data.banknifty) {
          if (noDirectionEl) { noDirectionEl.classList.remove('d-none'); noDirectionEl.textContent = 'Market lacks clear direction. Wait for better setup.'; }
        }
      })
      .catch(function() {
        if (loadingEl) loadingEl.classList.add('d-none');
        if (contentEl) contentEl.classList.remove('d-none');
        if (noDirectionEl) { noDirectionEl.classList.remove('d-none'); noDirectionEl.textContent = 'Could not load index recommendations.'; }
      });
  }

  document.getElementById('index-recommendation-cards').addEventListener('click', function(e) {
    const approveBtn = e.target.closest('.index-approve-btn');
    const rejectBtn = e.target.closest('.index-reject-btn');
    if (approveBtn) {
      const index = approveBtn.getAttribute('data-index');
      const rec = indexRecommendations[index];
      if (!rec) return;
      const executionMode = getExecutionMode();
      fetch('/api/approve-trade', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recommendation: rec, execution_mode: executionMode }) })
        .then(function(r) { return r.json(); }).then(function(res) {
          if (res.ok) { alert('Trade session created (' + executionMode + '). Strategy engine will monitor entry and exit.'); loadActiveSessions(); }
          else alert(res.error || 'Failed.');
        }).catch(function() { alert('Failed to approve.'); });
    }
    if (rejectBtn) {
      const index = rejectBtn.getAttribute('data-index');
      const wrap = document.getElementById('index-' + (index === 'BANKNIFTY' ? 'banknifty' : 'nifty') + '-card-wrap');
      if (wrap) wrap.classList.add('d-none');
    }
  });

  totalCapitalEl.addEventListener('input', refreshIndexOpportunities);
  riskPctEl.addEventListener('input', refreshIndexOpportunities);
  // Run all initial data loads in parallel for faster page load
  Promise.all([loadEngineStatus(), loadActiveSessions(), loadIndexOpportunities(), loadSignals()]);
  // Apply initial trading mode UI (manual by default)
  updateTradingModeUI();

  function renderStockCard(item, listId) {
    const trendIcon = item.trend === 'up' ? '‚Üë' : '‚Üì';
    const trendClass = item.trend === 'up' ? 'text-success-custom' : 'text-danger-custom';
    const score = Math.min(100, Math.max(0, item.score || 0));
    return `
      <div class="list-group-item list-group-item-action stock-card border-0 rounded-3 mb-2" data-stock="${item.stock}">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>${item.stock}</strong>
            <span class="ms-2 ${trendClass}">${trendIcon}</span>
          </div>
          <span class="badge bg-primary bg-opacity-25">${score}</span>
        </div>
        <div class="small text-muted mt-1">${item.signalSummary || '‚Äî'}</div>
        <div class="small mt-1">Volume: ${item.volumeSignal || 'Normal'}</div>
        <div class="ai-score-bar mt-2"><div class="ai-score-fill bg-primary" style="width:${score}%"></div></div>
        <button type="button" class="btn btn-sm btn-primary mt-2 w-100 view-options-btn" data-stock="${item.stock}">
          View Trade Options
        </button>
      </div>
    `;
  }

  function setLoading(blockId, loading) {
    const block = document.getElementById(blockId);
    const loadingEl = document.getElementById(blockId.replace('block-', '').replace('-list', '') + '-loading');
    const listEl = document.getElementById(blockId.replace('block-', '').replace('-list', '') + '-list');
    if (!listEl) return;
    if (loading) {
    } else {
      if (loadingEl) loadingEl.classList.add('d-none');
    }
  }

  const SIGNAL_CATEGORIES = ['momentum', 'reversal', 'news', 'etf'];

  async function loadSignals() {
    SIGNAL_CATEGORIES.forEach(cat => {
      const loadingEl = document.getElementById(cat + '-loading');
      const listEl = document.getElementById(cat + '-list');
      if (loadingEl) loadingEl.classList.remove('d-none');
      if (listEl) listEl.innerHTML = '';
    });
    try {
      const r = await fetch('/api/ai-trade-signals');
      const data = await r.json();
      SIGNAL_CATEGORIES.forEach(cat => {
        const loadingEl = document.getElementById(cat + '-loading');
        const listEl = document.getElementById(cat + '-list');
        const items = data[cat] || [];
        if (loadingEl) loadingEl.classList.add('d-none');
        if (listEl) {
          listEl.innerHTML = items.map(item => renderStockCard(item, cat)).join('');
          listEl.querySelectorAll('.view-options-btn').forEach(btn => {
            btn.addEventListener('click', function() { openOptionsPanel(this.dataset.stock); });
          });
        }
      });
    } catch (e) {
      SIGNAL_CATEGORIES.forEach(cat => {
        const loadingEl = document.getElementById(cat + '-loading');
        const listEl = document.getElementById(cat + '-list');
        if (loadingEl) { loadingEl.classList.add('d-none'); loadingEl.textContent = 'Error loading.'; }
        if (listEl) listEl.innerHTML = '<li class="list-group-item text-muted small">Failed to load.</li>';
      });
    }
  }

  function riskLevel(iv) {
    if (iv <= 18) return { label: 'Low', cls: 'risk-badge-low' };
    if (iv <= 22) return { label: 'Medium', cls: 'risk-badge-medium' };
    return { label: 'High', cls: 'risk-badge-high' };
  }

  function openOptionsPanel(stock) {
    optionsPanelStock.textContent = stock;
    const bsOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(optionsPanel);
    bsOffcanvas.show();
    loadRecommendationForInstrument(stock);
  }

  async function loadRecommendationForInstrument(instrument) {
    const loadingEl = document.getElementById('options-recommendation-loading');
    const noRecEl = document.getElementById('no-recommendation-warning');
    const cardWrap = document.getElementById('options-recommendation-card-wrap');
    if (loadingEl) loadingEl.classList.remove('d-none');
    if (noRecEl) noRecEl.classList.add('d-none');
    if (cardWrap) cardWrap.classList.add('d-none');
    currentRecommendation = null;
    const capital = getTotalCapital() || 100000;
    const riskPct = parseFloat(document.getElementById('risk-pct').value) || 2;
    try {
      const r = await fetch('/api/ai-trade-recommendation?instrument=' + encodeURIComponent(instrument) + '&capital=' + capital + '&risk_pct=' + riskPct);
      const data = await r.json();
      if (loadingEl) loadingEl.classList.add('d-none');
      const rec = data.recommendation;
      if (!rec) {
        if (noRecEl) noRecEl.classList.remove('d-none');
        return;
      }
      currentRecommendation = rec;
      document.getElementById('rec-direction').textContent = 'Buy ' + (rec.optionType || rec.tradeType || '‚Äî');
      document.getElementById('rec-strike').textContent = rec.suggestedStrike || '‚Äî';
      document.getElementById('rec-confidence').textContent = (rec.confidence != null ? rec.confidence + '%' : '‚Äî');
      document.getElementById('rec-holding').textContent = '30-90 min';
      document.getElementById('rec-reason').textContent = rec.entryCondition || '‚Äî';
      const suggestedAlgos = rec.suggestedAlgos || [];
      const detectedMarket = rec.detectedMarket || [];
      const isManual = tradingMode === 'manual';
      const suggestedBlock = document.getElementById('options-suggested-algos-block');
      const suggestedStockEl = document.getElementById('options-suggested-algos-stock');
      const suggestedTagsEl = document.getElementById('options-suggested-algos-tags');
      const detectedMarketEl = document.getElementById('options-detected-market');
      const aiSelectedLine = document.getElementById('options-ai-selected-algo-line');
      const aiSelectedName = document.getElementById('options-ai-selected-algo-name');
      const aiSelectedGroupEl = document.getElementById('options-ai-selected-algo-group');
      if (isManual) {
        suggestedBlock.classList.remove('d-none');
        suggestedStockEl.textContent = rec.instrument || instrument;
        if (detectedMarketEl) detectedMarketEl.textContent = detectedMarket.length ? detectedMarket.join(' + ') : '‚Äî';
        suggestedTagsEl.innerHTML = suggestedAlgos.length ? suggestedAlgos.map(function(a) {
          return '<a href="/dashboard/algo-library#' + (a.id || '') + '" class="badge bg-primary bg-opacity-25 text-primary-custom text-decoration-none" title="View strategy: ' + (a.name || a.id) + '">' + (a.name || a.id) + '</a>';
        }).join('') : '<span class="small text-muted">No strategies suggested.</span>';
      } else {
        suggestedBlock.classList.add('d-none');
        if (aiSelectedLine && aiSelectedName) {
          if (rec.selectedAlgoName) {
            aiSelectedLine.classList.remove('d-none');
            aiSelectedName.textContent = rec.selectedAlgoName;
            if (aiSelectedGroupEl) aiSelectedGroupEl.textContent = rec.selectedAlgoGroup ? '(' + rec.selectedAlgoGroup + ')' : '';
          } else { aiSelectedLine.classList.add('d-none'); }
        }
      }
      document.getElementById('rec-card-instrument').textContent = rec.instrument || instrument;
      document.getElementById('rec-card-bias').textContent = rec.marketBias || '‚Äî';
      document.getElementById('rec-card-strategy').textContent = rec.strategyName || '‚Äî';
      document.getElementById('rec-card-trade-type').textContent = rec.tradeType || '‚Äî';
      document.getElementById('rec-card-strike').textContent = rec.suggestedStrike || '‚Äî';
      document.getElementById('rec-card-entry').textContent = rec.entryCondition || '‚Äî';
      document.getElementById('rec-card-stop').textContent = rec.stopLossLogic || '‚Äî';
      document.getElementById('rec-card-reward').textContent = rec.rewardLogic || '‚Äî';
      document.getElementById('rec-card-risk').textContent = (rec.riskPerTrade != null ? Math.round(rec.riskPerTrade).toLocaleString('en-IN') : '‚Äî');
      document.getElementById('rec-card-lots').textContent = rec.positionSizeLots != null ? rec.positionSizeLots : '‚Äî';
      const optionsAiMsg = document.getElementById('options-ai-mode-msg');
      if (optionsAiMsg) optionsAiMsg.classList.toggle('d-none', isManual);
      if (cardWrap) cardWrap.classList.remove('d-none');
    } catch (e) {
      if (loadingEl) loadingEl.classList.add('d-none');
      if (noRecEl) { noRecEl.classList.remove('d-none'); noRecEl.textContent = 'Error loading recommendation.'; }
    }
  }

  document.getElementById('options-approve-trade-btn').addEventListener('click', function() {
    if (!currentRecommendation) return;
    const executionMode = getExecutionMode();
    fetch('/api/approve-trade', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recommendation: currentRecommendation, execution_mode: executionMode })
    }).then(function(r) { return r.json(); }).then(function(res) {
      if (res.ok) { alert('Trade session created (' + executionMode + '). Strategy engine will monitor entry and manage stop/exit.'); loadActiveSessions(); }
      else alert(res.error || 'Failed to approve.');
    }).catch(function() { alert('Failed to approve trade.'); });
  });
  document.getElementById('options-reject-trade-btn').addEventListener('click', function() {
    document.getElementById('options-recommendation-card-wrap').classList.add('d-none');
    document.getElementById('no-recommendation-warning').classList.remove('d-none');
    document.getElementById('no-recommendation-warning').textContent = 'Recommendation rejected.';
  });

  document.querySelectorAll('.view-options-btn').forEach(btn => {
    btn.addEventListener('click', function() { openOptionsPanel(this.dataset.stock); });
  });
  document.getElementById('optionsPanel').addEventListener('shown.bs.offcanvas', function() {});

})();
</script>
{% endblock %}
