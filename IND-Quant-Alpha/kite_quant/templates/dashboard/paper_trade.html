{% extends "base_dashboard.html" %}
{% block content %}
<div class="fade-in">
  <div class="alert alert-info border-0 mb-4" style="background: rgba(168, 199, 250, 0.12);">
    <div class="d-flex align-items-start gap-2">
      <span class="material-icons-round text-primary">edit_note</span>
      <div>
        <strong>Paper &amp; Live Trading (NIFTY / BANKNIFTY):</strong>
        <ul class="mb-0 mt-2 small">
          <li>One page for both: switch between <strong>Paper money</strong> (no real orders) and <strong>Real money</strong> (live Zerodha orders). Same engine as Backtest.</li>
          <li>Zerodha balance and execution list refresh every 5 seconds.</li>
          <li>Select money mode, index, capital, and click Trade to place an order.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- AI & Strategy (same as Backtest) -->
  <div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="material-icons-round text-primary-custom">smart_toy</span>
        AI &amp; Strategy
      </div>
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" type="checkbox" id="paper-enable-ai-switching" checked>
        <label class="form-check-label" for="paper-enable-ai-switching">Enable AI Auto-Switching</label>
      </div>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label small">Strategy (disabled when AI ON)</label>
          <select class="form-select form-select-sm" id="paper-strategy" disabled>
            <option value="AI_AUTO">AI Auto-Select</option>
            <option value="Index Momentum">Index Momentum</option>
            <option value="Momentum Breakout">Momentum Breakout</option>
            <option value="VWAP Trend Ride">VWAP Trend Ride</option>
            <option value="RSI Reversal Fade">RSI Reversal Fade</option>
            <option value="Opening Range Breakout">Opening Range Breakout</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center gap-2">
          <span class="material-icons-round text-primary-custom">account_balance</span>
          Zerodha Balance
        </div>
        <div class="card-body">
          <div class="d-flex align-items-baseline gap-2">
            <span class="metric-value" id="zerodha-balance">—</span>
            <span class="text-muted small" id="zerodha-balance-status"></span>
          </div>
          <p class="text-muted small mb-0 mt-1">Before investment (live)</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center gap-2">
          <span class="material-icons-round text-primary-custom">savings</span>
          Investment Amount
        </div>
        <div class="card-body">
          <input type="number" class="form-control" id="investment-amount" value="100000" min="1000" step="5000" placeholder="e.g. 100000">
          <p class="text-muted small mb-0 mt-1">Capital for today</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center gap-2">
          <span class="material-icons-round text-primary-custom">shield</span>
          Risk Limits
        </div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label small mb-1">Risk Per Trade (%)</label>
            <input type="number" class="form-control form-control-sm" id="paper-risk-pct" value="2" min="0.5" max="10" step="0.5" placeholder="2">
          </div>
          <div class="small mb-1"><strong>Max Risk Per Trade:</strong> <span id="max-risk-trade">—</span></div>
          <div class="small mb-0"><strong>Daily Loss Limit:</strong> <span id="daily-loss-limit">—</span></div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center gap-2">
          <span class="material-icons-round text-primary-custom">candlestick_chart</span>
          Instrument &amp; Trade
        </div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label small mb-1">Money mode</label>
            <select class="form-select form-select-sm" id="money-mode">
              <option value="PAPER">Paper money (no real orders)</option>
              <option value="LIVE">Real money (live Zerodha orders)</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label small mb-1">Index</label>
            <select class="form-select" id="paper-instrument">
              <option value="NIFTY">NIFTY 50</option>
              <option value="BANKNIFTY">BANK NIFTY</option>
            </select>
          </div>
          <button type="button" class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2" id="paper-trade-btn">
            <span class="material-icons-round">trending_up</span> Trade
          </button>
          <div id="paper-trade-status" class="mt-2 small"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body py-2 px-3 d-flex flex-wrap align-items-center gap-3 gap-md-4">
      <span class="text-muted small" id="refresh-countdown">Next refresh in 5s</span>
      <span class="text-muted small d-flex align-items-center gap-1" id="engine-status-wrap">
        <span class="rounded-circle d-inline-block" id="engine-dot" style="width: 8px; height: 8px; background: var(--bs-secondary);"></span>
        <span id="engine-status-text">Engine: —</span>
      </span>
      <span class="text-muted small" id="engine-scan-countdown">Next engine scan: —</span>
      <span class="text-muted small" id="engine-last-scan">Last scan: —</span>
      <span class="text-muted small" id="session-active-badge" style="display: none;"></span>
    </div>
  </div>

  <!-- Paper trades (today) -->
  <div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2">
        <span class="material-icons-round text-primary-custom">edit_note</span>
        Paper trades (today)
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-primary bg-opacity-10 text-primary-custom" id="paper-executions-count">0</span>
        <button type="button" class="btn btn-sm btn-outline-danger" id="paper-stop-btn" style="display: none;">
          <span class="material-icons-round" style="font-size: 1rem;">stop_circle</span> Stop Paper
        </button>
      </div>
    </div>
    <div id="paper-sessions-waiting-msg" class="alert alert-secondary border-0 mb-0 rounded-0 small py-2 px-3" style="display: none;"></div>
    <div class="card-body p-0">
      <div class="table-responsive overflow-x-auto" style="min-width: 1200px;">
        <table class="table table-sm table-dark table-hover mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>CE/PE</th>
              <th>Strike</th>
              <th>Strategy</th>
              <th>Entry Time</th>
              <th>Exit Time</th>
              <th>Entry Price</th>
              <th>Exit Price</th>
              <th>Current price</th>
              <th>Qty</th>
              <th>Price/Lot</th>
              <th>Capital Used</th>
              <th>Balance Left</th>
              <th>Gross P&L</th>
              <th>Charges</th>
              <th>Net P&L</th>
              <th>Status</th>
              <th>Exit Reason</th>
            </tr>
          </thead>
          <tbody id="paper-executions-tbody">
            <tr><td colspan="19" class="text-center text-muted py-4">No paper trades today.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Live trades (today) -->
  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2">
        <span class="material-icons-round text-primary-custom">show_chart</span>
        Live trades (today)
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-primary bg-opacity-10 text-primary-custom" id="live-executions-count">0</span>
        <button type="button" class="btn btn-sm btn-outline-danger" id="live-stop-btn" style="display: none;">
          <span class="material-icons-round" style="font-size: 1rem;">stop_circle</span> Stop Live
        </button>
      </div>
    </div>
    <div id="live-sessions-waiting-msg" class="alert alert-secondary border-0 mb-0 rounded-0 small py-2 px-3" style="display: none;"></div>
    <div class="card-body p-0">
      <div class="table-responsive overflow-x-auto" style="min-width: 1200px;">
        <table class="table table-sm table-dark table-hover mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>CE/PE</th>
              <th>Strike</th>
              <th>Strategy</th>
              <th>Entry Time</th>
              <th>Exit Time</th>
              <th>Entry Price</th>
              <th>Exit Price</th>
              <th>Current price</th>
              <th>Qty</th>
              <th>Price/Lot</th>
              <th>Capital Used</th>
              <th>Balance Left</th>
              <th>Gross P&L</th>
              <th>Charges</th>
              <th>Net P&L</th>
              <th>Status</th>
              <th>Exit Reason</th>
            </tr>
          </thead>
          <tbody id="live-executions-tbody">
            <tr><td colspan="19" class="text-center text-muted py-4">No live trades today.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
  let countdownSecs = 5;
  let countdownTimer = null;
  let optimisticRows = [];
  let activePaperSessionId = null;
  let activeLiveSessionId = null;
  let engineNextScanSecs = null;
  let engineRunning = true;  // Default to Running until API says otherwise (avoids "—" on load)
  let engineLastTickIso = null;

  function getTradeMode() {
    return (document.getElementById('money-mode') && document.getElementById('money-mode').value) || 'PAPER';
  }

  function formatTime(iso) {
    if (!iso) return '—';
    try {
      const d = new Date(iso);
      return d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    } catch (e) { return iso; }
  }
  function formatDate(iso) {
    if (!iso) return '—';
    try {
      return (iso + '').slice(0, 10);
    } catch (e) { return iso; }
  }
  function fmtNum(v) {
    if (v == null || v === '' || v === '—') return '—';
    const n = Number(v);
    if (isNaN(n)) return '—';
    return '₹' + n.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function fetchRiskConfig() {
    const amt = parseFloat(document.getElementById('investment-amount').value) || 100000;
    const riskPct = parseFloat(document.getElementById('paper-risk-pct').value) || 2;
    fetch('/api/paper-trade/risk-config?investment_amount=' + encodeURIComponent(amt) + '&risk_percent=' + encodeURIComponent(riskPct))
      .then(r => r.json())
      .then(data => {
        document.getElementById('max-risk-trade').textContent = data.max_risk_per_trade != null ? fmtNum(data.max_risk_per_trade) : '—';
        document.getElementById('daily-loss-limit').textContent = data.daily_loss_limit != null ? fmtNum(data.daily_loss_limit) : '—';
      })
      .catch(() => {
        document.getElementById('max-risk-trade').textContent = '—';
        document.getElementById('daily-loss-limit').textContent = '—';
      });
  }

  function fetchBalance() {
    fetch('/api/account-balance?mode=LIVE')
      .then(r => r.json())
      .then(data => {
        const el = document.getElementById('zerodha-balance');
        const status = document.getElementById('zerodha-balance-status');
        if (data.balance != null) {
          el.textContent = '₹' + Number(data.balance).toLocaleString('en-IN', { minimumFractionDigits: 2 });
          status.textContent = data.mode || '';
        } else {
          el.textContent = '—';
          status.textContent = 'Not connected';
        }
      })
      .catch(() => {
        document.getElementById('zerodha-balance').textContent = '—';
        document.getElementById('zerodha-balance-status').textContent = 'Error';
      });
  }

  function runRefresh() {
    countdownSecs = 5;
    const el = document.getElementById('refresh-countdown');
    if (el) el.textContent = 'Next refresh in 5s';
    fetchBalance();
    fetchExecutions();
  }

  function safeJson(r) {
    if (!r.ok) throw new Error('API ' + r.status);
    return r.json().catch(function() { throw new Error('Invalid JSON'); });
  }

  function fetchExecutions() {
    Promise.all([
      fetch('/api/trade-history?mode=PAPER&today=1').then(safeJson),
      fetch('/api/trade-history?mode=LIVE&today=1').then(safeJson),
      fetch('/api/trade-sessions').then(safeJson)
    ]).then(([paperData, liveData, sessionsData]) => {
      try {
        const paperTrades = (paperData && paperData.trades) ? paperData.trades : [];
        const liveTrades = (liveData && liveData.trades) ? liveData.trades : [];
        const sessions = (sessionsData && sessionsData.sessions) ? sessionsData.sessions : [];
        var modeKey = function(s) { return (s.execution_mode || s.mode || '').toUpperCase(); };
        const paperOpen = sessions.filter(s => modeKey(s) === 'PAPER' && s.status === 'ACTIVE' && s.current_trade);
        const paperWaiting = sessions.filter(s => modeKey(s) === 'PAPER' && s.status === 'ACTIVE' && !s.current_trade);
        const paperActive = sessions.filter(s => modeKey(s) === 'PAPER' && s.status === 'ACTIVE');
        const liveOpen = sessions.filter(s => modeKey(s) === 'LIVE' && s.status === 'ACTIVE' && s.current_trade);
        const liveWaiting = sessions.filter(s => modeKey(s) === 'LIVE' && s.status === 'ACTIVE' && !s.current_trade);
        const liveActive = sessions.filter(s => modeKey(s) === 'LIVE' && s.status === 'ACTIVE');
        
        if (paperOpen.length > 0) optimisticRows = optimisticRows.filter(o => (o.mode || 'PAPER') !== 'PAPER');
        if (liveOpen.length > 0) optimisticRows = optimisticRows.filter(o => (o.mode || 'PAPER') !== 'LIVE');
        // Engine status: defensive so UI never shows "—" when server is up
        if (sessionsData != null) {
          engineRunning = sessionsData.engine_running !== false;
          engineNextScanSecs = typeof sessionsData.next_scan === 'number' ? sessionsData.next_scan : null;
          engineLastTickIso = sessionsData.last_tick || null;
        }
        updateEngineStatusUI();
        var paperActiveCount = paperActive.length;
        var liveActiveCount = liveActive.length;
        var badgeEl = document.getElementById('session-active-badge');
        if (badgeEl) {
          if (paperActiveCount > 0 && liveActiveCount > 0) {
            badgeEl.style.display = '';
            badgeEl.textContent = paperActiveCount + ' Paper, ' + liveActiveCount + ' Live session(s) active';
          } else if (paperActiveCount > 0) {
            badgeEl.style.display = '';
            badgeEl.textContent = paperActiveCount + ' Paper session(s) active';
          } else if (liveActiveCount > 0) {
            badgeEl.style.display = '';
            badgeEl.textContent = liveActiveCount + ' Live session(s) active';
          } else {
            badgeEl.style.display = 'none';
          }
        }
        renderModeExecutions('PAPER', paperTrades, paperOpen, paperWaiting.length, paperActive);
        renderModeExecutions('LIVE', liveTrades, liveOpen, liveWaiting.length, liveActive);
      } catch (e) {
        renderModeExecutions('PAPER', [], [], 0, []);
        renderModeExecutions('LIVE', [], [], 0, []);
      }
    }).catch(function() {
      var txt = document.getElementById('engine-status-text');
      var dot = document.getElementById('engine-dot');
      if (txt) txt.textContent = 'Engine: reconnecting…';
      if (dot) { dot.style.background = 'orange'; }
      document.getElementById('engine-scan-countdown').textContent = 'Next engine scan: —';
      var lastEl = document.getElementById('engine-last-scan');
      if (lastEl) lastEl.textContent = 'Last scan: —';
      renderModeExecutions('PAPER', [], [], 0, []);
      renderModeExecutions('LIVE', [], [], 0, []);
    });
  }

  function updateEngineStatusUI() {
    var txt = document.getElementById('engine-status-text');
    var dot = document.getElementById('engine-dot');
    var scanEl = document.getElementById('engine-scan-countdown');
    if (txt) {
      if (engineRunning === true) txt.textContent = 'Engine: Running';
      else if (engineRunning === false) txt.textContent = 'Engine: Stopped';
      else txt.textContent = 'Engine: —';
    }
    if (dot) {
      dot.style.background = engineRunning === true ? 'var(--bs-success)' : (engineRunning === false ? '#dc3545' : 'var(--bs-secondary)');
    }
    if (scanEl) {
      if (engineNextScanSecs != null) {
        if (engineNextScanSecs <= 0) {
          scanEl.textContent = 'Next engine scan: due now';
        } else {
          scanEl.textContent = 'Next engine scan in ' + engineNextScanSecs + 's';
        }
      } else {
        scanEl.textContent = 'Next engine scan: —';
      }
    }
    var lastEl = document.getElementById('engine-last-scan');
    if (lastEl) {
      if (engineLastTickIso) {
        try {
          var lastMs = new Date(engineLastTickIso).getTime();
          var agoSec = Math.floor((Date.now() - lastMs) / 1000);
          if (agoSec < 60) lastEl.textContent = 'Last scan: ' + agoSec + 's ago';
          else if (agoSec < 3600) lastEl.textContent = 'Last scan: ' + Math.floor(agoSec / 60) + 'm ago';
          else lastEl.textContent = 'Last scan: ' + Math.floor(agoSec / 3600) + 'h ago';
        } catch (e) { lastEl.textContent = 'Last scan: —'; }
      } else {
        lastEl.textContent = 'Last scan: —';
      }
    }
  }

  function statusBadge(status) {
    if (status === 'OPEN') return '<span class="badge bg-warning text-dark">OPEN</span>';
    if (status === 'Waiting to enter') return '<span class="badge bg-info text-dark">Waiting to enter</span>';
    if (status === 'Placing…') return '<span class="badge bg-info text-dark">Placing…</span>';
    return '<span class="badge bg-secondary">CLOSED</span>';
  }

  function rowToBacktest(r) {
    const statusHtml = r.status_badge || statusBadge(r.status);
    return `
      <tr>
        <td>${r.date}</td>
        <td>${r.ce_pe}</td>
        <td>${r.strike}</td>
        <td>${r.strategy}</td>
        <td>${r.entry_time}</td>
        <td>${r.exit_time}</td>
        <td>${r.entry_price}</td>
        <td>${r.exit_price}</td>
        <td>${r.current_price}</td>
        <td>${r.qty}</td>
        <td>${r.price_per_lot}</td>
        <td>${r.capital_used}</td>
        <td>${r.balance_left}</td>
        <td>${r.gross_pnl}</td>
        <td>${r.charges}</td>
        <td>${r.net_pnl}</td>
        <td>${statusHtml}</td>
        <td>${r.exit_reason}</td>
      </tr>
    `;
  }

  function buildRowsForMode(mode, closedTrades, openSessions, waitingCount, allActiveSessions) {
    const rows = [];
    
    // Add sessions waiting to enter (no current_trade yet)
    allActiveSessions.forEach(s => {
      const sessionMode = (s.execution_mode || s.mode || '').toUpperCase();
      if (sessionMode !== mode) return;
      if (s.current_trade) return; // Skip - will be handled by openSessions below
      
      const rec = s.recommendation || {};
      rows.push({
        date: new Date().toISOString().split('T')[0],
        ce_pe: rec.optionType || rec.ce_pe || rec.direction || '—',
        strike: rec.strike != null ? rec.strike : '—',
        strategy: rec.strategyName || rec.strategy || '—',
        entry_time: '—',
        exit_time: '—',
        entry_price: rec.premium != null ? '₹' + rec.premium.toFixed(2) : '—',
        exit_price: '—',
        current_price: rec.premium != null ? '₹' + rec.premium.toFixed(2) : '—',
        qty: rec.lotSize || '—',
        price_per_lot: '—',
        capital_used: '—',
        balance_left: s.virtual_balance != null ? '₹' + s.virtual_balance.toFixed(2) : '—',
        gross_pnl: '—',
        charges: '—',
        net_pnl: '—',
        exit_reason: '—',
        status_badge: '<span class="badge bg-info text-dark">Waiting to enter</span>'
      });
    });
    
    // Add open trades
    openSessions.forEach(s => {
      const t = s.current_trade;
      if (!t) return;
      
      const rec = s.recommendation || {};
      const entryPrice = t.entry_price;
      const qty = t.qty;
      const lotSize = s.lot_size || rec.lot_size || rec.lotSize || 25;
      const currentLtp = (s.current_ltp != null && s.current_ltp > 0) ? s.current_ltp : entryPrice;
      const side = (t.side || 'BUY').toUpperCase();
      
      let grossPnl = null;
      if (entryPrice != null && currentLtp != null && qty != null) {
        if (side === 'BUY') grossPnl = (currentLtp - entryPrice) * qty;
        else grossPnl = (entryPrice - currentLtp) * qty;
      }
      
      rows.push({
        date: String(t.entry_time || '').slice(0, 10),
        ce_pe: rec.optionType || (rec.tradeType === 'CALL' ? 'CE' : 'PE') || '—',
        strike: rec.strike != null ? rec.strike : '—',
        strategy: t.strategy_name || rec.strategyName || '—',
        entry_time: formatTime(t.entry_time),
        exit_time: '—',
        entry_price: entryPrice != null ? fmtNum(entryPrice) : '—',
        exit_price: '—',
        current_price: currentLtp != null ? fmtNum(currentLtp) : '—',
        qty: qty || 0,
        price_per_lot: entryPrice != null && lotSize ? fmtNum(entryPrice * lotSize) : '—',
        capital_used: entryPrice != null && qty ? fmtNum(entryPrice * qty) : '—',
        balance_left: s.virtual_balance != null ? fmtNum(s.virtual_balance) : '—',
        gross_pnl: grossPnl != null ? (grossPnl >= 0 ? fmtNum(grossPnl) : '-' + fmtNum(Math.abs(grossPnl))) : '—',
        charges: '—',
        net_pnl: grossPnl != null ? (grossPnl >= 0 ? fmtNum(grossPnl) : '-' + fmtNum(Math.abs(grossPnl))) : '—',
        exit_reason: '—',
        status_badge: '<span class="badge bg-warning text-dark">OPEN</span>'
      });
    });
    
    // Add closed trades
    closedTrades.forEach(t => {
      const entryPrice = t.entry_price;
      const exitPrice = t.exit_price;
      const qty = t.qty || 0;
      const pnl = t.pnl != null ? Number(t.pnl) : null;
      rows.push({
        date: formatDate(t.entry_time),
        ce_pe: t.option_type || '—',
        strike: t.strike != null ? t.strike : '—',
        strategy: t.strategy || '—',
        entry_time: formatTime(t.entry_time),
        exit_time: formatTime(t.exit_time),
        entry_price: fmtNum(entryPrice),
        exit_price: fmtNum(exitPrice),
        current_price: '—',
        qty: qty,
        price_per_lot: '—',
        capital_used: '—',
        balance_left: '—',
        gross_pnl: pnl != null ? fmtNum(pnl) : '—',
        charges: t.charges != null ? fmtNum(t.charges) : '—',
        net_pnl: pnl != null ? fmtNum(pnl) : '—',
        exit_reason: t.exit_reason || '—',
        status_badge: '<span class="badge bg-secondary">CLOSED</span>'
      });
    });
    
    rows.sort((a, b) => {
      const at = (a.entry_time === '—' ? '' : a.entry_time) + (a.date || '');
      const bt = (b.entry_time === '—' ? '' : b.entry_time) + (b.date || '');
      return bt.localeCompare(at);
    });
    return rows;
  }

  function renderModeExecutions(mode, closedTrades, openSessions, waitingCount, activeSessions) {
    const isPaper = mode === 'PAPER';
    const tbody = document.getElementById(isPaper ? 'paper-executions-tbody' : 'live-executions-tbody');
    const countEl = document.getElementById(isPaper ? 'paper-executions-count' : 'live-executions-count');
    const waitingEl = document.getElementById(isPaper ? 'paper-sessions-waiting-msg' : 'live-sessions-waiting-msg');
    const prefix = isPaper ? 'Paper' : 'Live';
    if (waitingEl) {
      waitingEl.style.display = waitingCount > 0 ? 'block' : 'none';
      waitingEl.textContent = waitingCount + ' ' + prefix.toLowerCase() + ' session(s) active — engine will place trade when conditions are met.';
    }
    const rows = buildRowsForMode(mode, closedTrades, openSessions, waitingCount, activeSessions);
    if (isPaper) {
      activePaperSessionId = (activeSessions.length > 0 && (activeSessions[0].sessionId || activeSessions[0].session_id)) || null;
      const stopBtn = document.getElementById('paper-stop-btn');
      if (stopBtn) stopBtn.style.display = activePaperSessionId ? '' : 'none';
    } else {
      activeLiveSessionId = (activeSessions.length > 0 && (activeSessions[0].sessionId || activeSessions[0].session_id)) || null;
      const stopBtn = document.getElementById('live-stop-btn');
      if (stopBtn) stopBtn.style.display = activeLiveSessionId ? '' : 'none';
    }
    countEl.textContent = rows.length;
    if (rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="19" class="text-center text-muted py-4">No ' + prefix.toLowerCase() + ' trades today.</td></tr>';
      return;
    }
    tbody.innerHTML = rows.map(rowToBacktest).join('');
  }

  function startCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    countdownSecs = 5;
    const el = document.getElementById('refresh-countdown');
    function tick() {
      if (countdownSecs > 0) {
        el.textContent = 'Next refresh in ' + countdownSecs + 's';
        countdownSecs--;
      } else {
        runRefresh();
      }
      if (typeof engineNextScanSecs === 'number' && engineNextScanSecs > 0) {
        engineNextScanSecs--;
        updateEngineStatusUI();
      } else if (typeof engineNextScanSecs === 'number' && engineNextScanSecs === 0) {
        updateEngineStatusUI();
      }
    }
    tick();
    countdownTimer = setInterval(tick, 1000);
  }

  document.getElementById('investment-amount').addEventListener('input', fetchRiskConfig);
  document.getElementById('investment-amount').addEventListener('change', fetchRiskConfig);
  document.getElementById('paper-risk-pct').addEventListener('input', fetchRiskConfig);
  document.getElementById('paper-risk-pct').addEventListener('change', fetchRiskConfig);

  document.getElementById('paper-enable-ai-switching').addEventListener('change', function() {
    var strategySelect = document.getElementById('paper-strategy');
    strategySelect.disabled = this.checked;
    if (this.checked) strategySelect.value = 'AI_AUTO';
  });

  function stopSession(sessionId, statusElId, label, btn) {
    if (!sessionId) return;
    if (btn) btn.disabled = true;
    fetch('/api/trade-sessions/' + encodeURIComponent(sessionId) + '/kill', { method: 'POST' })
      .then(r => r.json())
      .then(data => {
        const el = document.getElementById(statusElId);
        if (el) el.innerHTML = data.ok ? '<span class="text-success">' + label + ' stopped.</span>' : '<span class="text-danger">' + (data.error || 'Failed to stop') + '</span>';
        if (data.ok) runRefresh();
      })
      .catch(() => {
        const el = document.getElementById(statusElId);
        if (el) el.innerHTML = '<span class="text-danger">Request failed</span>';
      })
      .finally(() => { if (btn) btn.disabled = false; });
  }

  document.getElementById('paper-stop-btn').addEventListener('click', function() {
    stopSession(activePaperSessionId, 'paper-trade-status', 'Paper', this);
  });
  document.getElementById('live-stop-btn').addEventListener('click', function() {
    stopSession(activeLiveSessionId, 'paper-trade-status', 'Live', this);
  });

  document.getElementById('paper-trade-btn').addEventListener('click', function() {
    const btn = this;
    const status = document.getElementById('paper-trade-status');
    const instrument = document.getElementById('paper-instrument').value;
    const investmentAmount = parseFloat(document.getElementById('investment-amount').value) || 100000;
    const mode = getTradeMode();
    const isLive = mode === 'LIVE';
    const today = new Date().toISOString().slice(0, 10);
    btn.disabled = true;
    status.innerHTML = '<span class="text-primary">Starting session...</span>';
    const aiEnabled = document.getElementById('paper-enable-ai-switching') && document.getElementById('paper-enable-ai-switching').checked;
    const apiUrl = isLive ? '/api/live-trade/execute' : '/api/paper-trade/execute';
    fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        instrument: instrument,
        investment_amount: investmentAmount,
        ai_auto_switching_enabled: aiEnabled
      })
    })
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          status.innerHTML = '<span class="text-success">' + (data.message || 'Session started.') + '</span>';
          var rec = data.recommendation || {};
          var premium = rec.premium != null ? Number(rec.premium) : null;
          var lotSize = rec.lot_size != null ? Number(rec.lot_size) : 25;
          var balance = data.virtual_balance != null ? Number(data.virtual_balance) : null;
          var now = new Date();
          var timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          var dateStr = now.toISOString().slice(0, 10);
          optimisticRows.push({
            mode: mode,
            date: dateStr,
            ce_pe: rec.optionType || '—',
            strike: rec.strike != null ? rec.strike : '—',
            strategy: rec.strategyName || '—',
            entry_time: timeStr,
            entry_price: premium != null ? fmtNum(premium) : '—',
            price_per_lot: premium != null && lotSize ? fmtNum(premium * lotSize) : '—',
            qty: '—',
            capital_used: '—',
            balance_left: balance != null ? fmtNum(balance) : '—',
            exit_reason: '—',
            status: 'Waiting to enter'
          });
          fetchExecutions();
        } else {
          status.innerHTML = '<span class="text-danger">' + (data.error || 'Failed') + '</span>';
        }
      })
      .catch(err => {
        status.innerHTML = '<span class="text-danger">Request failed</span>';
        fetchExecutions();
      })
      .finally(() => { btn.disabled = false; });
  });

  document.getElementById('money-mode').addEventListener('change', function() {
    fetchExecutions();
  });

  fetchRiskConfig();
  fetchBalance();
  fetchExecutions();
  startCountdown();
})();
</script>
{% endblock %}
