{% extends "base_dashboard.html" %}
{% block content %}
<div class="fade-in">
  <p class="text-muted mb-4">Offline historical replay. Same strategies and risk manager as Manual Mode. No live or paper sessions.</p>

  <div class="card mb-4">
    <div class="card-header d-flex align-items-center">
      <span class="material-icons-round me-2 text-primary-custom">play_circle</span>
      Run Backtest
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Instrument</label>
          <select class="form-select" id="backtest-instrument">
            <option value="RELIANCE">RELIANCE</option>
            <option value="HDFCBANK">HDFCBANK</option>
            <option value="TCS">TCS</option>
            <option value="NIFTY">NIFTY</option>
            <option value="BANKNIFTY">BANKNIFTY</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Strategy</label>
          <select class="form-select" id="backtest-strategy">
            <option value="Momentum Breakout">Momentum Breakout</option>
            <option value="VWAP Trend Ride">VWAP Trend Ride</option>
            <option value="RSI Reversal Fade">RSI Reversal Fade</option>
            <option value="Opening Range Breakout">Opening Range Breakout</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">From</label>
          <input type="date" class="form-control" id="backtest-from">
        </div>
        <div class="col-md-2">
          <label class="form-label">To</label>
          <input type="date" class="form-control" id="backtest-to">
        </div>
        <div class="col-md-2">
          <label class="form-label">Timeframe</label>
          <select class="form-select" id="backtest-timeframe">
            <option value="5minute">5 min</option>
            <option value="15minute">15 min</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Capital (₹)</label>
          <input type="number" class="form-control" id="backtest-capital" value="100000" min="1000" step="1000">
        </div>
        <div class="col-md-2">
          <label class="form-label">Risk %</label>
          <input type="number" class="form-control" id="backtest-risk" value="1" min="0.1" max="5" step="0.1">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" class="btn btn-primary w-100" id="backtest-run-btn">
            <span class="material-icons-round fs-6 me-1">play_arrow</span> Run Backtest
          </button>
        </div>
      </div>
      <div id="backtest-run-status" class="mt-3 small text-muted d-none"></div>
    </div>
  </div>

  <div class="card mb-4 d-none" id="backtest-last-result-card">
    <div class="card-header">Last run summary</div>
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col"><span class="text-muted">Net P&L</span><div id="bt-net-pnl" class="fw-bold">—</div></div>
        <div class="col"><span class="text-muted">Win rate</span><div id="bt-win-rate">—</div></div>
        <div class="col"><span class="text-muted">Max drawdown</span><div id="bt-max-dd">—</div></div>
        <div class="col"><span class="text-muted">Trades</span><div id="bt-trades">—</div></div>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-borderless">
          <thead><tr><th>Entry</th><th>Exit</th><th>Entry price</th><th>Exit price</th><th>Qty</th><th>P&L</th><th>Reason</th></tr></thead>
          <tbody id="backtest-trades-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">Past runs</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-dark table-borderless">
          <thead><tr><th>Run</th><th>Instrument</th><th>Strategy</th><th>Period</th><th>Net P&L</th><th>Win %</th><th>Drawdown %</th></tr></thead>
          <tbody id="backtest-runs-tbody"></tbody>
        </table>
      </div>
      <p class="text-muted small mb-0" id="backtest-runs-empty">Load past runs below.</p>
    </div>
  </div>
</div>

<script>
(function() {
  var fromEl = document.getElementById('backtest-from');
  var toEl = document.getElementById('backtest-to');
  var t = new Date();
  toEl.value = t.toISOString().slice(0, 10);
  var p = new Date(t);
  p.setDate(p.getDate() - 30);
  fromEl.value = p.toISOString().slice(0, 10);

  function loadResults() {
    fetch('/api/backtest/results').then(function(r) { return r.json(); }).then(function(data) {
      var runs = data.runs || [];
      var tbody = document.getElementById('backtest-runs-tbody');
      var empty = document.getElementById('backtest-runs-empty');
      tbody.innerHTML = '';
      if (runs.length === 0) {
        empty.classList.remove('d-none');
        return;
      }
      empty.classList.add('d-none');
      runs.slice().reverse().slice(0, 20).forEach(function(r) {
        var tr = document.createElement('tr');
        var pnl = r.net_pnl != null ? r.net_pnl : 0;
        var pnlClass = pnl >= 0 ? 'text-success-custom' : 'text-danger-custom';
        tr.innerHTML = '<td>' + (r.run_id || '—') + '</td><td>' + (r.instrument || '—') + '</td><td>' + (r.strategy || '—') + '</td><td>' + (r.from_date || '') + ' to ' + (r.to_date || '') + '</td><td class="' + pnlClass + '">' + pnl + '</td><td>' + (r.win_rate != null ? r.win_rate + '%' : '—') + '</td><td>' + (r.max_drawdown != null ? r.max_drawdown + '%' : '—') + '</td>';
        tbody.appendChild(tr);
      });
    }).catch(function() {});
  }
  loadResults();

  document.getElementById('backtest-run-btn').addEventListener('click', function() {
    var btn = this;
    var status = document.getElementById('backtest-run-status');
    btn.disabled = true;
    status.classList.remove('d-none');
    status.textContent = 'Running…';
    var payload = {
      instrument: document.getElementById('backtest-instrument').value,
      strategy: document.getElementById('backtest-strategy').value,
      from_date: fromEl.value,
      to_date: toEl.value,
      timeframe: document.getElementById('backtest-timeframe').value,
      initial_capital: parseFloat(document.getElementById('backtest-capital').value) || 100000,
      risk_percent_per_trade: parseFloat(document.getElementById('backtest-risk').value) || 1
    };
    fetch('/api/backtest/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(function(r) { return r.json(); }).then(function(data) {
      btn.disabled = false;
      if (data.ok && data.result) {
        status.textContent = 'Done.';
        var r = data.result;
        document.getElementById('backtest-last-result-card').classList.remove('d-none');
        var pnlEl = document.getElementById('bt-net-pnl');
        pnlEl.textContent = (r.net_pnl != null ? r.net_pnl : 0);
        pnlEl.className = (r.net_pnl >= 0 ? 'fw-bold text-success-custom' : 'fw-bold text-danger-custom');
        document.getElementById('bt-win-rate').textContent = (r.win_rate != null ? r.win_rate + '%' : '—');
        document.getElementById('bt-max-dd').textContent = (r.max_drawdown != null ? r.max_drawdown + '%' : '—');
        document.getElementById('bt-trades').textContent = (r.total_trades != null ? r.total_trades : 0);
        var tbody = document.getElementById('backtest-trades-tbody');
        tbody.innerHTML = '';
        (r.trades || []).forEach(function(t) {
          var tr = document.createElement('tr');
          var pnl = t.pnl != null ? t.pnl : 0;
          tr.innerHTML = '<td>' + (t.entry_time || '') + '</td><td>' + (t.exit_time || '') + '</td><td>' + (t.entry_price || '') + '</td><td>' + (t.exit_price || '') + '</td><td>' + (t.qty || '') + '</td><td class="' + (pnl >= 0 ? 'text-success-custom' : 'text-danger-custom') + '">' + pnl + '</td><td>' + (t.exit_reason || '') + '</td>';
          tbody.appendChild(tr);
        });
        loadResults();
      } else {
        status.textContent = 'Error: ' + (data.error || 'Unknown');
      }
    }).catch(function(e) {
      btn.disabled = false;
      status.textContent = 'Request failed.';
    });
  });
})();
</script>
{% endblock %}
