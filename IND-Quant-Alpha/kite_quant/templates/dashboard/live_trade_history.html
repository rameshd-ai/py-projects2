{% extends "base_dashboard.html" %}
{% block content %}
<div class="fade-in">
  <div class="alert alert-info border-0 mb-4" style="background: rgba(168, 199, 250, 0.12);">
    <div class="d-flex align-items-start gap-2">
      <span class="material-icons-round text-primary">show_chart</span>
      <div>
        <strong>Live Trade History</strong>
        <p class="mb-0 mt-1 small">Broker-only live order history (executed, rejected, cancelled, open order states).</p>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body py-2 px-3 d-flex flex-wrap align-items-center gap-3 gap-md-4">
      <label class="d-flex align-items-center gap-2 mb-0 small">
        <input type="checkbox" id="filter-today" class="form-check-input">
        <span>Today only</span>
      </label>
      <div class="d-flex align-items-center gap-2 small">
        <label class="mb-0 text-muted">From</label>
        <input type="date" id="filter-from-date" class="form-control form-control-sm" style="width: auto;">
      </div>
      <div class="d-flex align-items-center gap-2 small">
        <label class="mb-0 text-muted">To</label>
        <input type="date" id="filter-to-date" class="form-control form-control-sm" style="width: auto;">
      </div>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="filter-apply">Apply</button>
      <span class="badge bg-primary bg-opacity-10 text-primary-custom" id="live-history-count">0</span>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2">
        <span class="material-icons-round text-primary-custom">history</span>
        Broker live orders
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive overflow-x-auto" style="min-width: 1200px;">
        <table class="table table-sm table-dark table-hover mb-0">
          <thead>
            <tr>
              <th>Time</th>
              <th>Mode</th>
              <th>Instrument</th>
              <th>Symbol</th>
              <th>Strategy</th>
              <th>Status</th>
              <th>Entry</th>
              <th>Exit</th>
              <th>Qty</th>
              <th>Gross P&L</th>
              <th>Net P&L</th>
              <th>Exit Reason</th>
            </tr>
          </thead>
          <tbody id="live-history-tbody">
            <tr><td colspan="12" class="text-center text-muted py-4">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
  let todayOnly = false;

  function formatTime(iso) {
    if (!iso) return '—';
    try {
      const d = new Date(iso);
      return d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    } catch (e) { return iso; }
  }
  function fmtNum(v) {
    if (v == null || v === '' || v === '—') return '—';
    const n = Number(v);
    if (isNaN(n)) return '—';
    return '₹' + n.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function fetchHistory() {
    const fromVal = (document.getElementById('filter-from-date').value || '').trim();
    const toVal = (document.getElementById('filter-to-date').value || '').trim();
    const params = new URLSearchParams();
    if (todayOnly) {
      params.set('today', '1');
    } else {
      if (fromVal) params.set('from_date', fromVal);
      if (toVal) params.set('to_date', toVal);
    }
    const url = '/api/live-executions-today?' + params.toString();
    fetch(url, { cache: 'no-store' })
      .then(r => r.ok ? r.json() : Promise.reject(new Error('API ' + r.status)))
      .then((brokerData) => {
        const orders = (brokerData && brokerData.orders) ? brokerData.orders : [];
        renderTable(orders);
      })
      .catch(() => {
        document.getElementById('live-history-tbody').innerHTML =
          '<tr><td colspan="12" class="text-center text-muted py-4">Failed to load. Check connection.</td></tr>';
        document.getElementById('live-history-count').textContent = '0';
      });
  }

  function renderTable(brokerOrders) {
    const tbody = document.getElementById('live-history-tbody');
    const countEl = document.getElementById('live-history-count');
    function esc(v) {
      return String(v == null ? '' : v).replace(/&/g, '&amp;').replace(/</g, '&lt;');
    }
    function tsOf(iso) {
      const n = Number(new Date(iso || 0));
      return isNaN(n) ? 0 : n;
    }
    const rows = [];

    (brokerOrders || []).forEach(o => {
      const side = String(o.side || '').toUpperCase();
      const status = String(o.status || '').toUpperCase();
      const avg = o.average_price != null ? Number(o.average_price) : null;
      rows.push({
        ts: tsOf(o.order_timestamp),
        time: formatTime(o.order_timestamp),
        mode: 'LIVE',
        instrument: String(o.exchange || '—').toUpperCase(),
        symbol: o.symbol || '—',
        strategy: 'Broker Order',
        status: (status === 'COMPLETE' || Number(o.filled_quantity || 0) > 0)
          ? '<span class="badge bg-success">EXECUTED</span>'
          : '<span class="badge bg-secondary">' + esc(status || 'ORDER') + '</span>',
        entry: side === 'BUY' ? fmtNum(avg) : '—',
        exit: side === 'SELL' ? fmtNum(avg) : '—',
        qty: Number(o.filled_quantity || o.quantity || 0) || '—',
        gross: '—',
        net: '—',
        reason: o.status_message || status || '—'
      });
    });

    rows.sort((a, b) => b.ts - a.ts);
    countEl.textContent = String(rows.length);
    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-4">No live trades.</td></tr>';
      return;
    }
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${esc(r.time)}</td>
        <td>${esc(r.mode)}</td>
        <td>${esc(r.instrument)}</td>
        <td>${esc(r.symbol)}</td>
        <td>${esc(r.strategy)}</td>
        <td>${r.status}</td>
        <td>${r.entry}</td>
        <td>${r.exit}</td>
        <td>${esc(r.qty)}</td>
        <td>${r.gross}</td>
        <td>${r.net}</td>
        <td>${esc(r.reason)}</td>
      </tr>
    `).join('');
  }

  document.getElementById('filter-today').addEventListener('change', function() {
    todayOnly = this.checked;
    if (todayOnly) {
      const fromEl = document.getElementById('filter-from-date');
      const toEl = document.getElementById('filter-to-date');
      if (fromEl) fromEl.value = '';
      if (toEl) toEl.value = '';
    }
    fetchHistory();
  });

  document.getElementById('filter-apply').addEventListener('click', function() {
    todayOnly = false;
    document.getElementById('filter-today').checked = false;
    fetchHistory();
  });
  fetchHistory();
})();
</script>
{% endblock %}
