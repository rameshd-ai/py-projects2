<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kite Quant — Settings</title>
  <link href="{{ url_for('static', filename='css/roboto.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <style>
    :root {
      --md-bg: #121212;
      --md-surface: #1e1e1e;
      --md-surface-2: #252525;
      --md-primary: #a8c7fa;
      --md-border: #444746;
      --md-text: #e2e2e2;
      --md-muted: #c4c7c5;
      --md-success: #6dd58c;
      --md-error: #ffb4ab;
    }
    body { font-family: 'Roboto', sans-serif; background: var(--md-bg); color: var(--md-text); min-height: 100vh; }
    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--md-border);
      background: var(--md-surface);
    }
    .settings-header h1 { font-size: 1.25rem; font-weight: 600; margin: 0; color: var(--md-primary); }
    .settings-header a { color: var(--md-muted); text-decoration: none; font-size: 0.875rem; }
    .settings-header a:hover { color: var(--md-primary); }
    .settings-main {
      max-width: 640px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    .nav-tabs {
      border-bottom: 1px solid var(--md-border);
      gap: 0.25rem;
      margin-bottom: 1.5rem;
    }
    .nav-tabs .nav-link {
      color: var(--md-muted);
      border: 1px solid transparent;
      border-radius: 8px 8px 0 0;
      padding: 0.6rem 1rem;
      font-weight: 500;
    }
    .nav-tabs .nav-link:hover { color: var(--md-text); border-color: var(--md-border); background: var(--md-surface-2); }
    .nav-tabs .nav-link.active {
      color: var(--md-primary);
      background: var(--md-surface);
      border-color: var(--md-border) var(--md-border) var(--md-bg);
      border-bottom-color: var(--md-bg);
    }
    .tab-pane { padding-top: 0.5rem; }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label {
      display: block;
      font-size: 0.8125rem;
      color: var(--md-muted);
      margin-bottom: 0.35rem;
      font-weight: 500;
    }
    .form-group input {
      width: 100%;
      padding: 0.6rem 0.85rem;
      background: var(--md-surface-2);
      border: 1px solid var(--md-border);
      border-radius: 8px;
      color: var(--md-text);
      font-size: 0.9375rem;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--md-primary);
      box-shadow: 0 0 0 2px rgba(168, 199, 250, 0.2);
    }
    .form-group .hint {
      font-size: 0.75rem;
      color: var(--md-muted);
      margin-top: 0.35rem;
      line-height: 1.4;
    }
    .form-group .hint a { color: var(--md-primary); }
    .info-box {
      padding: 1rem;
      background: rgba(168, 199, 250, 0.08);
      border: 1px solid rgba(168, 199, 250, 0.2);
      border-radius: 10px;
      font-size: 0.875rem;
      margin-top: 1rem;
      line-height: 1.5;
    }
    .info-box strong { color: var(--md-primary); }
    .info-box a { color: var(--md-primary); }
    .btn-save {
      padding: 0.65rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      background: var(--md-primary);
      color: #062e6f;
      border: none;
      margin-top: 0.5rem;
    }
    .btn-save:hover { background: #8ab4f8; color: #062e6f; }
    .msg {
      padding: 0.85rem 1rem;
      border-radius: 10px;
      font-size: 0.9375rem;
      margin-bottom: 1.25rem;
      font-weight: 500;
      display: none;
    }
    .msg.show { display: block; }
    .msg.success { background: rgba(109, 213, 140, 0.15); color: var(--md-success); border: 1px solid var(--md-success); }
    .msg.error { background: rgba(255, 180, 171, 0.15); color: var(--md-error); border: 1px solid var(--md-error); }
    .tab-section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--md-muted); margin-bottom: 1rem; }
  </style>
</head>
<body>
  <header class="settings-header">
    <h1>Settings</h1>
    <a href="{{ url_for('dashboard') }}">← Dashboard</a>
  </header>

  <div class="settings-main">
    <div id="msg" class="msg"></div>

    <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="zerodha-tab" data-bs-toggle="tab" data-bs-target="#zerodha-pane" type="button" role="tab">Zerodha</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading-pane" type="button" role="tab">Trading</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="apis-tab" data-bs-toggle="tab" data-bs-target="#apis-pane" type="button" role="tab">APIs & AI</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="app-tab" data-bs-toggle="tab" data-bs-target="#app-pane" type="button" role="tab">App</button>
      </li>
    </ul>

    <form id="settingsForm">
      <div class="tab-content" id="settingsTabContent">
        <!-- Zerodha -->
        <div class="tab-pane fade show active" id="zerodha-pane" role="tabpanel">
          <div class="tab-section-title">Kite Connect credentials</div>
          <div class="form-group">
            <label for="ZERODHA_API_KEY">API Key</label>
            <input type="password" id="ZERODHA_API_KEY" name="ZERODHA_API_KEY" value="{{ config.get('ZERODHA_API_KEY', '') }}" placeholder="Leave blank to keep current">
            <div class="hint">From <a href="https://kite.trade/apps/" target="_blank">kite.trade/apps</a></div>
          </div>
          <div class="form-group">
            <label for="ZERODHA_API_SECRET">API Secret</label>
            <input type="password" id="ZERODHA_API_SECRET" name="ZERODHA_API_SECRET" value="{{ config.get('ZERODHA_API_SECRET', '') }}" placeholder="Leave blank to keep current">
          </div>
          <div class="form-group">
            <label for="ZERODHA_ACCESS_TOKEN">Access Token</label>
            <input type="password" id="ZERODHA_ACCESS_TOKEN" name="ZERODHA_ACCESS_TOKEN" value="{{ config.get('ZERODHA_ACCESS_TOKEN', '') }}" placeholder="Leave blank to keep current">
            <div class="hint">From Kite Connect login flow. Valid until logout.</div>
          </div>
          <div class="info-box">
            <strong>Get Access Token:</strong><br>
            1. Create app at <a href="https://kite.trade/apps/" target="_blank">kite.trade/apps</a><br>
            2. Use API Key & Secret to login via Kite Connect<br>
            3. Paste the token here after login.
          </div>
        </div>

        <!-- Trading -->
        <div class="tab-pane fade" id="trading-pane" role="tabpanel">
          <div class="tab-section-title">Daily limits & schedule</div>
          <div class="form-group">
            <label for="MAX_TRADES_PER_DAY">Max trades per day</label>
            <input type="number" id="MAX_TRADES_PER_DAY" name="MAX_TRADES_PER_DAY" value="{{ config.get('MAX_TRADES_PER_DAY', '3') }}" placeholder="3" min="1" max="20">
            <div class="hint">Maximum trades allowed per day (1–20).</div>
          </div>
          <div class="form-group">
            <label for="AUTO_CLOSE_TIME">Auto-close time (HH:MM)</label>
            <input type="text" id="AUTO_CLOSE_TIME" name="AUTO_CLOSE_TIME" value="{{ config.get('AUTO_CLOSE_TIME', '14:30') }}" placeholder="14:30">
            <div class="hint">Trading stops at this time (IST).</div>
          </div>
          <div class="form-group">
            <label for="TRADING_AMOUNT">Trading amount (₹)</label>
            <input type="text" id="TRADING_AMOUNT" name="TRADING_AMOUNT" value="{{ config.get('TRADING_AMOUNT', '') }}" placeholder="e.g. 50000">
            <div class="hint">Capital used for risk calculations. Can also set from dashboard.</div>
          </div>
        </div>

        <!-- APIs & AI -->
        <div class="tab-pane fade" id="apis-pane" role="tabpanel">
          <div class="tab-section-title">External API keys</div>
          <div class="form-group">
            <label for="NEWS_API_KEY">News API Key</label>
            <input type="password" id="NEWS_API_KEY" name="NEWS_API_KEY" value="{{ config.get('NEWS_API_KEY', '') }}" placeholder="Leave blank to keep current">
            <div class="hint">For news headlines and sentiment.</div>
          </div>
          <div class="form-group">
            <label for="OPENAI_API_KEY">OpenAI API Key (optional)</label>
            <input type="password" id="OPENAI_API_KEY" name="OPENAI_API_KEY" value="{{ config.get('OPENAI_API_KEY', '') }}" placeholder="For AI suggestions">
            <div class="hint">If set, GPT is used for “best to trade” suggestions. Otherwise rule-based.</div>
          </div>
        </div>

        <!-- App -->
        <div class="tab-pane fade" id="app-pane" role="tabpanel">
          <div class="tab-section-title">Server & environment</div>
          <div class="form-group">
            <label for="FLASK_SECRET_KEY">Flask secret key</label>
            <input type="password" id="FLASK_SECRET_KEY" name="FLASK_SECRET_KEY" value="{{ config.get('FLASK_SECRET_KEY', '') }}" placeholder="Leave blank to keep current">
          </div>
          <div class="form-group">
            <label for="FLASK_ENV">Flask env</label>
            <input type="text" id="FLASK_ENV" name="FLASK_ENV" value="{{ config.get('FLASK_ENV', 'development') }}" placeholder="development or production">
          </div>
          <div class="form-group">
            <label for="TZ">Timezone</label>
            <input type="text" id="TZ" name="TZ" value="{{ config.get('TZ', 'Asia/Kolkata') }}" placeholder="Asia/Kolkata">
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-save">Save settings</button>
    </form>
  </div>

  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script>
    (function() {
      var form = document.getElementById('settingsForm');
      var msgEl = document.getElementById('msg');
      var keys = [
        'ZERODHA_API_KEY', 'ZERODHA_API_SECRET', 'ZERODHA_ACCESS_TOKEN',
        'NEWS_API_KEY', 'OPENAI_API_KEY', 'FLASK_SECRET_KEY', 'FLASK_ENV',
        'TZ', 'AUTO_CLOSE_TIME', 'MAX_TRADES_PER_DAY', 'TRADING_AMOUNT'
      ];

      function showMsg(text, type) {
        msgEl.textContent = text;
        msgEl.className = 'msg show ' + type;
        if (type === 'success') setTimeout(function() { msgEl.classList.remove('show'); }, 4000);
      }

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var data = {};
        keys.forEach(function(k) {
          var el = document.getElementById(k);
          if (el && el.value !== null && el.value !== undefined) {
            var v = String(el.value).trim();
            if (v) data[k] = v;
          }
        });
        if (Object.keys(data).length === 0) {
          showMsg('Enter at least one value to save.', 'error');
          return;
        }
        fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(function(r) {
            return r.json().then(function(data) { return { ok: r.ok, data: data }; }).catch(function() { return { ok: r.ok, data: {} }; });
          })
          .then(function(result) {
            if (result.ok && result.data && result.data.ok) {
              showMsg('Settings saved.', 'success');
            } else {
              showMsg((result.data && result.data.error) ? result.data.error : 'Failed to save.', 'error');
            }
          })
          .catch(function(err) {
            showMsg('Failed to save: ' + (err.message || 'network error'), 'error');
          });
      });
    })();
  </script>
</body>
</html>
