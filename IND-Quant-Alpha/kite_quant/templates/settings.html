<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kite Quant — Settings</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --success: #3fb950;
      --danger: #f85149;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
    }
    .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .top h1 { font-size: 1.125rem; margin: 0; font-weight: 600; }
    .top a {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.875rem;
      margin-left: 1rem;
    }
    .top a:hover { color: var(--accent); }
    .main {
      padding: 1.5rem;
      max-width: 560px;
      margin: 0 auto;
    }
    .main h2 { font-size: 1rem; margin: 0 0 1rem 0; color: var(--muted); }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      font-size: 0.875rem;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }
    .form-group input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9375rem;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group .hint {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }
    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      background: var(--accent);
      color: #fff;
    }
    .btn:hover { opacity: 0.9; }
    .msg {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 1rem;
      font-weight: 500;
      border: 1px solid;
    }
    .msg.success {
      background: rgba(63, 185, 80, 0.25);
      color: var(--success);
      border-color: var(--success);
    }
    .msg.error {
      background: rgba(248, 81, 73, 0.25);
      color: var(--danger);
      border-color: var(--danger);
    }
    .section { margin-bottom: 1.5rem; }
  </style>
</head>
<body>
  <header class="top">
    <h1>Settings</h1>
    <div>
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
    </div>
  </header>
  <div class="main">
    <div id="msg"></div>
    <form id="settingsForm">
      <div class="section">
        <h2>Zerodha Kite Connect API</h2>
        <div class="form-group">
          <label for="ZERODHA_API_KEY">Zerodha API Key</label>
          <input type="password" id="ZERODHA_API_KEY" name="ZERODHA_API_KEY" value="{{ config.get('ZERODHA_API_KEY', '') }}" placeholder="Leave blank to keep current">
          <div class="hint">Get from Zerodha Kite Connect developer console: <a href="https://kite.trade/apps/" target="_blank" style="color: var(--accent);">kite.trade/apps</a></div>
        </div>
        <div class="form-group">
          <label for="ZERODHA_API_SECRET">Zerodha API Secret</label>
          <input type="password" id="ZERODHA_API_SECRET" name="ZERODHA_API_SECRET" value="{{ config.get('ZERODHA_API_SECRET', '') }}" placeholder="Leave blank to keep current">
          <div class="hint">API Secret from Kite Connect app settings.</div>
        </div>
        <div class="form-group">
          <label for="ZERODHA_ACCESS_TOKEN">Zerodha Access Token</label>
          <input type="password" id="ZERODHA_ACCESS_TOKEN" name="ZERODHA_ACCESS_TOKEN" value="{{ config.get('ZERODHA_ACCESS_TOKEN', '') }}" placeholder="Leave blank to keep current">
          <div class="hint">Access token obtained after login. Generate using Kite Connect login flow. Token is valid until logout.</div>
        </div>
        <div class="info-box" style="margin-top: 1rem; padding: 0.75rem; background: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.3); border-radius: 6px; font-size: 0.875rem;">
          <strong>How to get Access Token:</strong><br>
          1. Create app at <a href="https://kite.trade/apps/" target="_blank" style="color: var(--accent);">kite.trade/apps</a><br>
          2. Use API Key & Secret to login via Kite Connect<br>
          3. After successful login, you'll receive an access token<br>
          4. Paste the access token here. It remains valid until you logout.
        </div>
      </div>
      <div class="section">
        <h2>News API</h2>
        <div class="form-group">
          <label for="NEWS_API_KEY">News API Key</label>
          <input type="password" id="NEWS_API_KEY" name="NEWS_API_KEY" value="{{ config.get('NEWS_API_KEY', '') }}" placeholder="Leave blank to keep current">
        </div>
      </div>
      <div class="section">
        <h2>AI (optional)</h2>
        <div class="form-group">
          <label for="OPENAI_API_KEY">OpenAI API Key</label>
          <input type="password" id="OPENAI_API_KEY" name="OPENAI_API_KEY" value="{{ config.get('OPENAI_API_KEY', '') }}" placeholder="For AI 'Best to trade' suggestion on Intraday Picks">
          <div class="hint">If set, Intraday Picks will use GPT to suggest best 1–3 stocks. Otherwise rule-based suggestion is used.</div>
        </div>
      </div>
      <div class="section">
        <h2>App</h2>
        <div class="form-group">
          <label for="FLASK_SECRET_KEY">Flask Secret Key</label>
          <input type="password" id="FLASK_SECRET_KEY" name="FLASK_SECRET_KEY" value="{{ config.get('FLASK_SECRET_KEY', '') }}" placeholder="Leave blank to keep current">
        </div>
        <div class="form-group">
          <label for="FLASK_ENV">Flask Env</label>
          <input type="text" id="FLASK_ENV" name="FLASK_ENV" value="{{ config.get('FLASK_ENV', 'development') }}" placeholder="development or production">
        </div>
        <div class="form-group">
          <label for="TZ">Timezone</label>
          <input type="text" id="TZ" name="TZ" value="{{ config.get('TZ', 'Asia/Kolkata') }}" placeholder="Asia/Kolkata">
        </div>
        <div class="form-group">
          <label for="AUTO_CLOSE_TIME">Auto-close time (HH:MM)</label>
          <input type="text" id="AUTO_CLOSE_TIME" name="AUTO_CLOSE_TIME" value="{{ config.get('AUTO_CLOSE_TIME', '14:30') }}" placeholder="14:30">
          <div class="hint">Trading stops at this time (IST).</div>
        </div>
        <div class="form-group">
          <label for="MAX_TRADES_PER_DAY">Max Trades Per Day</label>
          <input type="number" id="MAX_TRADES_PER_DAY" name="MAX_TRADES_PER_DAY" value="{{ config.get('MAX_TRADES_PER_DAY', '3') }}" placeholder="3" min="1" max="20">
          <div class="hint">Maximum number of trades allowed per day (1-20). Use trade suggestions in dashboard for optimal value.</div>
        </div>
      </div>
      <button type="submit" class="btn">Save settings</button>
    </form>
  </div>
  <script>
    const form = document.getElementById('settingsForm');
    const msgEl = document.getElementById('msg');

    function showMsg(text, type, alsoAlert) {
      msgEl.textContent = text;
      msgEl.className = 'msg ' + type;
      msgEl.style.display = 'block';
      if (alsoAlert !== false) alert(text);
      if (type === 'success') {
        setTimeout(function() { msgEl.style.display = 'none'; }, 5000);
      }
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const data = {};
      ['ZERODHA_API_KEY', 'ZERODHA_API_SECRET', 'ZERODHA_ACCESS_TOKEN', 'NEWS_API_KEY', 'OPENAI_API_KEY',
       'FLASK_SECRET_KEY', 'FLASK_ENV', 'TZ', 'AUTO_CLOSE_TIME', 'MAX_TRADES_PER_DAY'].forEach(function(k) {
        const el = document.getElementById(k);
        if (el && el.value !== null && el.value !== undefined) {
          const v = String(el.value).trim();
          if (v) data[k] = v;
        }
      });
      if (Object.keys(data).length === 0) {
        showMsg('Enter at least one value to save.', 'error', true);
        return;
      }
      fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(function(r) {
          return r.text().then(function(text) {
            var d;
            try { d = text ? JSON.parse(text) : {}; } catch (e) { d = {}; }
            return { ok: r.ok, status: r.status, data: d };
          });
        })
        .then(function(result) {
          if (result.ok && result.data && result.data.ok) {
            showMsg('Settings saved.', 'success', true);
          } else {
            var err = (result.data && result.data.error) ? result.data.error : 'Failed to save (status ' + result.status + ')';
            showMsg(err, 'error', true);
          }
        })
        .catch(function(err) {
          var errText = 'Failed to save: ' + (err.message || 'network error');
          showMsg(errText, 'error', true);
        });
    });
  </script>
</body>
</html>
