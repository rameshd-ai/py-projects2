<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kite Quant — Settings</title>
  <link href="{{ url_for('static', filename='css/roboto.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <style>
    :root {
      --md-bg: #121212;
      --md-surface: #1e1e1e;
      --md-surface-2: #252525;
      --md-primary: #a8c7fa;
      --md-border: #444746;
      --md-text: #e2e2e2;
      --md-muted: #c4c7c5;
      --md-success: #6dd58c;
      --md-error: #ffb4ab;
    }
    body { font-family: 'Roboto', sans-serif; background: var(--md-bg); color: var(--md-text); min-height: 100vh; }
    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--md-border);
      background: var(--md-surface);
    }
    .settings-header h1 { font-size: 1.25rem; font-weight: 600; margin: 0; color: var(--md-primary); }
    .settings-header a { color: var(--md-muted); text-decoration: none; font-size: 0.875rem; }
    .settings-header a:hover { color: var(--md-primary); }
    .settings-main {
      max-width: 640px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    .nav-tabs {
      border-bottom: 1px solid var(--md-border);
      gap: 0.25rem;
      margin-bottom: 1.5rem;
    }
    .nav-tabs .nav-link {
      color: var(--md-muted);
      border: 1px solid transparent;
      border-radius: 8px 8px 0 0;
      padding: 0.6rem 1rem;
      font-weight: 500;
    }
    .nav-tabs .nav-link:hover { color: var(--md-text); border-color: var(--md-border); background: var(--md-surface-2); }
    .nav-tabs .nav-link.active {
      color: var(--md-primary);
      background: var(--md-surface);
      border-color: var(--md-border) var(--md-border) var(--md-bg);
      border-bottom-color: var(--md-bg);
    }
    .tab-pane { padding-top: 0.5rem; }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label {
      display: block;
      font-size: 0.8125rem;
      color: var(--md-muted);
      margin-bottom: 0.35rem;
      font-weight: 500;
    }
    .form-group input {
      width: 100%;
      padding: 0.6rem 0.85rem;
      background: var(--md-surface-2);
      border: 1px solid var(--md-border);
      border-radius: 8px;
      color: var(--md-text);
      font-size: 0.9375rem;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--md-primary);
      box-shadow: 0 0 0 2px rgba(168, 199, 250, 0.2);
    }
    .form-group .hint {
      font-size: 0.75rem;
      color: var(--md-muted);
      margin-top: 0.35rem;
      line-height: 1.4;
    }
    .form-group .hint a { color: var(--md-primary); }
    .info-box {
      padding: 1rem;
      background: rgba(168, 199, 250, 0.08);
      border: 1px solid rgba(168, 199, 250, 0.2);
      border-radius: 10px;
      font-size: 0.875rem;
      margin-top: 1rem;
      line-height: 1.5;
    }
    .info-box strong { color: var(--md-primary); }
    .info-box a { color: var(--md-primary); }
    .btn-save {
      padding: 0.65rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      background: var(--md-primary);
      color: #062e6f;
      border: none;
      margin-top: 0.5rem;
    }
    .btn-save:hover { background: #8ab4f8; color: #062e6f; }
    .msg {
      padding: 0.85rem 1rem;
      border-radius: 10px;
      font-size: 0.9375rem;
      margin-bottom: 1.25rem;
      font-weight: 500;
      display: none;
    }
    .msg.show { display: block; }
    .msg.success { background: rgba(109, 213, 140, 0.15); color: var(--md-success); border: 1px solid var(--md-success); }
    .msg.error { background: rgba(255, 180, 171, 0.15); color: var(--md-error); border: 1px solid var(--md-error); }
    .tab-section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--md-muted); margin-bottom: 1rem; }
  </style>
</head>
<body>
  <header class="settings-header">
    <h1>Settings</h1>
    <a href="{{ url_for('dashboard') }}">← Dashboard</a>
  </header>

  <div class="settings-main">
    <div id="msg" class="msg"></div>

    <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="zerodha-tab" data-bs-toggle="tab" data-bs-target="#zerodha-pane" type="button" role="tab">Zerodha</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading-pane" type="button" role="tab">Trading</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="frequency-tab" data-bs-toggle="tab" data-bs-target="#frequency-pane" type="button" role="tab">Trade Frequency</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="apis-tab" data-bs-toggle="tab" data-bs-target="#apis-pane" type="button" role="tab">APIs & AI</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="app-tab" data-bs-toggle="tab" data-bs-target="#app-pane" type="button" role="tab">App</button>
      </li>
    </ul>

    <form id="settingsForm">
      <div class="tab-content" id="settingsTabContent">
        <!-- Zerodha -->
        <div class="tab-pane fade show active" id="zerodha-pane" role="tabpanel">
          <div class="tab-section-title">Kite Connect credentials</div>
          <div class="form-group">
            <label for="ZERODHA_API_KEY">API Key</label>
            <input type="password" id="ZERODHA_API_KEY" name="ZERODHA_API_KEY" value="{{ config.get('ZERODHA_API_KEY', '') }}" placeholder="Leave blank to keep current">
            <div class="hint">From <a href="https://kite.trade/apps/" target="_blank">kite.trade/apps</a></div>
          </div>
          <div class="form-group">
            <label for="ZERODHA_API_SECRET">API Secret</label>
            <input type="password" id="ZERODHA_API_SECRET" name="ZERODHA_API_SECRET" value="{{ config.get('ZERODHA_API_SECRET', '') }}" placeholder="Leave blank to keep current">
          </div>
          <div class="form-group">
            <label for="ZERODHA_ACCESS_TOKEN">Access Token</label>
            <input type="password" id="ZERODHA_ACCESS_TOKEN" name="ZERODHA_ACCESS_TOKEN" value="{{ config.get('ZERODHA_ACCESS_TOKEN', '') }}" placeholder="Leave blank to keep current">
            <div class="hint">From Kite Connect login flow. Valid until logout.</div>
          </div>
          <div class="info-box">
            <strong>Get Access Token:</strong><br>
            1. Create app at <a href="https://kite.trade/apps/" target="_blank">kite.trade/apps</a><br>
            2. Use API Key & Secret to login via Kite Connect<br>
            3. Paste the token here after login.
          </div>
        </div>

        <!-- Trading -->
        <div class="tab-pane fade" id="trading-pane" role="tabpanel">
          <div class="tab-section-title">Trading Schedule</div>
          <div class="info-box mb-3">
            <strong>Trade Frequency:</strong> Controlled by the <strong>Trade Frequency</strong> tab (dynamic hourly limits based on capital and drawdown).
            <br><strong>Position Sizing:</strong> Set per session when approving trades (virtual balance for paper mode, live balance for live mode).
          </div>
          <div class="form-group">
            <label for="AUTO_CLOSE_TIME">Auto-close time (HH:MM)</label>
            <input type="text" id="AUTO_CLOSE_TIME" name="AUTO_CLOSE_TIME" value="{{ config.get('AUTO_CLOSE_TIME', '14:30') }}" placeholder="14:30">
            <div class="hint">Trading stops at this time (IST).</div>
          </div>
        </div>

        <!-- Trade Frequency -->
        <div class="tab-pane fade" id="frequency-pane" role="tabpanel">
          <div class="tab-section-title">Dynamic Trade Frequency</div>
          <div class="info-box mb-3">
            <strong>Capital-Based Frequency:</strong> Automatically adjusts trades per hour based on your capital size and daily P&L. 
            Reduces frequency during drawdowns to protect capital.
          </div>

          <div class="mb-4">
            <h6 class="text-muted mb-3">Capital Slabs & Frequency</h6>
            <table class="table table-sm table-dark table-hover" id="frequency-rules-table">
              <thead>
                <tr>
                  <th>Min Capital (₹)</th>
                  <th>Max Capital (₹)</th>
                  <th>Trades per Hour</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="frequency-rules-tbody">
                <!-- Populated by JS -->
              </tbody>
            </table>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="add-frequency-rule-btn">
              <span>+</span> Add Slab
            </button>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <div class="form-group">
                <label for="max-hourly-cap">Max Hourly Cap</label>
                <input type="number" class="form-control" id="max-hourly-cap" min="1" max="10" value="5">
                <div class="hint">Maximum trades per hour (safety limit)</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="drawdown-reduce-percent">Drawdown Reduction %</label>
                <input type="number" class="form-control" id="drawdown-reduce-percent" min="0.1" max="1" step="0.1" value="0.5">
                <div class="hint">Reduce frequency by this factor during drawdown (0.5 = 50%)</div>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <div class="form-group">
                <label for="drawdown-trigger">Soft Drawdown Trigger (%)</label>
                <input type="number" class="form-control" id="drawdown-trigger" min="0.5" max="10" step="0.5" value="2">
                <div class="hint">When daily loss hits this %, reduce frequency</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="hard-drawdown-trigger">Hard Drawdown Trigger (%)</label>
                <input type="number" class="form-control" id="hard-drawdown-trigger" min="1" max="20" step="0.5" value="5">
                <div class="hint">When daily loss hits this %, limit to 1 trade/hour</div>
              </div>
            </div>
          </div>

          <div class="alert alert-warning border-0 small" style="background: rgba(253, 196, 0, 0.15);">
            <strong>⚠ Example:</strong> With ₹100,000 capital, 2% soft trigger = ₹2,000 loss. Frequency reduces by 50%. 
            5% hard trigger = ₹5,000 loss. Only 1 trade/hour allowed.
          </div>

          <button type="button" class="btn btn-primary" id="save-frequency-btn">
            Save Frequency Settings
          </button>
        </div>

        <!-- APIs & AI -->
        <div class="tab-pane fade" id="apis-pane" role="tabpanel">
          <div class="tab-section-title">External API keys</div>
          <div class="form-group">
            <label for="NEWS_API_KEY">News API Key</label>
            <input type="password" id="NEWS_API_KEY" name="NEWS_API_KEY" value="{{ config.get('NEWS_API_KEY', '') }}" placeholder="Leave blank to keep current">
            <div class="hint">For news headlines and sentiment.</div>
          </div>
          <div class="form-group">
            <label for="OPENAI_API_KEY">OpenAI API Key (optional)</label>
            <input type="password" id="OPENAI_API_KEY" name="OPENAI_API_KEY" value="{{ config.get('OPENAI_API_KEY', '') }}" placeholder="For AI suggestions">
            <div class="hint">If set, GPT is used for “best to trade” suggestions. Otherwise rule-based.</div>
          </div>
        </div>

        <!-- App -->
        <div class="tab-pane fade" id="app-pane" role="tabpanel">
          <div class="tab-section-title">Server & environment</div>
          <div class="form-group">
            <label for="FLASK_SECRET_KEY">Flask secret key</label>
            <input type="password" id="FLASK_SECRET_KEY" name="FLASK_SECRET_KEY" value="{{ config.get('FLASK_SECRET_KEY', '') }}" placeholder="Leave blank to keep current">
          </div>
          <div class="form-group">
            <label for="FLASK_ENV">Flask env</label>
            <input type="text" id="FLASK_ENV" name="FLASK_ENV" value="{{ config.get('FLASK_ENV', 'development') }}" placeholder="development or production">
          </div>
          <div class="form-group">
            <label for="TZ">Timezone</label>
            <input type="text" id="TZ" name="TZ" value="{{ config.get('TZ', 'Asia/Kolkata') }}" placeholder="Asia/Kolkata">
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-save" id="general-save-btn">Save settings</button>
    </form>
  </div>

  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script>
    (function() {
      var form = document.getElementById('settingsForm');
      var msgEl = document.getElementById('msg');
      var generalSaveBtn = document.getElementById('general-save-btn');
      var keys = [
        'ZERODHA_API_KEY', 'ZERODHA_API_SECRET', 'ZERODHA_ACCESS_TOKEN',
        'NEWS_API_KEY', 'OPENAI_API_KEY', 'FLASK_SECRET_KEY', 'FLASK_ENV',
        'TZ', 'AUTO_CLOSE_TIME'
      ];

      function showMsg(text, type) {
        msgEl.textContent = text;
        msgEl.className = 'msg show ' + type;
        if (type === 'success') setTimeout(function() { msgEl.classList.remove('show'); }, 4000);
      }

      // Hide general save button on Trade Frequency tab
      function updateSaveButtonVisibility() {
        var frequencyTab = document.getElementById('frequency-pane');
        if (frequencyTab && frequencyTab.classList.contains('show')) {
          generalSaveBtn.style.display = 'none';
        } else {
          generalSaveBtn.style.display = 'block';
        }
      }

      // Listen for tab changes
      var tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
      tabButtons.forEach(function(btn) {
        btn.addEventListener('shown.bs.tab', updateSaveButtonVisibility);
      });

      // Initial check
      updateSaveButtonVisibility();

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var data = {};
        keys.forEach(function(k) {
          var el = document.getElementById(k);
          if (el && el.value !== null && el.value !== undefined) {
            var v = String(el.value).trim();
            if (v) data[k] = v;
          }
        });
        if (Object.keys(data).length === 0) {
          showMsg('Enter at least one value to save.', 'error');
          return;
        }
        fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(function(r) {
            return r.json().then(function(data) { return { ok: r.ok, data: data }; }).catch(function() { return { ok: r.ok, data: {} }; });
          })
          .then(function(result) {
            if (result.ok && result.data && result.data.ok) {
              showMsg('Settings saved.', 'success');
            } else {
              showMsg((result.data && result.data.error) ? result.data.error : 'Failed to save.', 'error');
            }
          })
          .catch(function(err) {
            showMsg('Failed to save: ' + (err.message || 'network error'), 'error');
          });
      });

      // Trade Frequency Management
      var frequencyRules = [];
      
      function loadFrequencySettings() {
        fetch('/api/settings/trade-frequency')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.ok && data.config) {
              var config = data.config;
              frequencyRules = config.rules || [];
              
              // Populate settings
              document.getElementById('max-hourly-cap').value = config.max_hourly_cap || 5;
              document.getElementById('drawdown-trigger').value = (config.drawdown_trigger_percent || 0.02) * 100;
              document.getElementById('hard-drawdown-trigger').value = (config.hard_drawdown_trigger_percent || 0.05) * 100;
              document.getElementById('drawdown-reduce-percent').value = config.drawdown_reduce_percent || 0.5;
              
              // Render rules table
              renderFrequencyRules();
            }
          })
          .catch(function(e) {
            console.error('Failed to load frequency settings:', e);
          });
      }
      
      function renderFrequencyRules() {
        var tbody = document.getElementById('frequency-rules-tbody');
        tbody.innerHTML = '';
        
        frequencyRules.forEach(function(rule, idx) {
          var tr = document.createElement('tr');
          tr.innerHTML = 
            '<td><input type="number" class="form-control form-control-sm" value="' + (rule.min_capital || 0) + '" data-idx="' + idx + '" data-field="min_capital"></td>' +
            '<td><input type="number" class="form-control form-control-sm" value="' + (rule.max_capital || '') + '" data-idx="' + idx + '" data-field="max_capital" placeholder="None"></td>' +
            '<td><input type="number" class="form-control form-control-sm" value="' + (rule.max_trades_per_hour || 2) + '" data-idx="' + idx + '" data-field="max_trades_per_hour" min="1" max="10"></td>' +
            '<td><button type="button" class="btn btn-sm btn-outline-danger remove-rule-btn" data-idx="' + idx + '">Remove</button></td>';
          tbody.appendChild(tr);
        });
        
        // Attach listeners
        tbody.querySelectorAll('input').forEach(function(input) {
          input.addEventListener('change', function() {
            var idx = parseInt(this.getAttribute('data-idx'));
            var field = this.getAttribute('data-field');
            var value = this.value;
            
            if (field === 'min_capital' || field === 'max_capital') {
              frequencyRules[idx][field] = value ? parseInt(value) : (field === 'max_capital' ? null : 0);
            } else if (field === 'max_trades_per_hour') {
              frequencyRules[idx][field] = parseInt(value) || 2;
            }
          });
        });
        
        tbody.querySelectorAll('.remove-rule-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var idx = parseInt(this.getAttribute('data-idx'));
            frequencyRules.splice(idx, 1);
            renderFrequencyRules();
          });
        });
      }
      
      document.getElementById('add-frequency-rule-btn').addEventListener('click', function() {
        frequencyRules.push({
          min_capital: 0,
          max_capital: null,
          max_trades_per_hour: 2
        });
        renderFrequencyRules();
      });
      
      document.getElementById('save-frequency-btn').addEventListener('click', function() {
        var config = {
          rules: frequencyRules,
          max_hourly_cap: parseInt(document.getElementById('max-hourly-cap').value) || 5,
          drawdown_trigger_percent: parseFloat(document.getElementById('drawdown-trigger').value) / 100 || 0.02,
          hard_drawdown_trigger_percent: parseFloat(document.getElementById('hard-drawdown-trigger').value) / 100 || 0.05,
          drawdown_reduce_percent: parseFloat(document.getElementById('drawdown-reduce-percent').value) || 0.5
        };
        
        fetch('/api/settings/trade-frequency', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config: config })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            showMsg('Trade frequency settings saved!', 'success');
          } else {
            showMsg('Failed to save: ' + (data.error || 'Unknown error'), 'error');
          }
        })
        .catch(function(e) {
          showMsg('Failed to save: ' + e.message, 'error');
        });
      });
      
      // Load frequency settings on page load
      loadFrequencySettings();
      
    })();
  </script>
</body>
</html>
