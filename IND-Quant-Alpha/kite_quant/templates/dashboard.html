<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kite Quant — Dashboard</title>
  
  <!-- Fonts: Roboto (Material standard) -->
  <link href="{{ url_for('static', filename='css/roboto.css') }}" rel="stylesheet">
  
  <!-- Icons: Material Icons -->
  <link href="{{ url_for('static', filename='css/material-icons.css') }}" rel="stylesheet">
  
  <!-- Bootstrap 5 CSS -->
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  
  <style>
    :root {
      /* Material Dark Palette */
      --md-bg: #121212;
      --md-surface: #1e1e1e;
      --md-surface-2: #252525;
      --md-primary: #a8c7fa;
      --md-on-primary: #062e6f;
      --md-secondary: #c2c7cf;
      --md-error: #ffb4ab;
      --md-success: #6dd58c;
      --md-warning: #fdc400;
      --md-text: #e2e2e2;
      --md-text-muted: #c4c7c5;
      --md-border: #444746;
      
      --bs-body-bg: var(--md-bg);
      --bs-body-color: var(--md-text);
      --bs-border-color: var(--md-border);
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--md-bg);
      overflow-x: hidden;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 260px;
      background-color: var(--md-surface);
      border-right: 1px solid var(--md-border);
      padding-top: 1rem;
      z-index: 1000;
      transition: transform 0.3s ease-in-out;
    }

    .sidebar-brand {
      padding: 0 1.5rem 1.5rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--md-primary);
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--md-border);
    }

    .nav-link {
      color: var(--md-text-muted);
      padding: 0.85rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      border-radius: 0 50px 50px 0;
      margin-right: 1rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      background-color: rgba(168, 199, 250, 0.08);
      color: var(--md-text);
    }

    .nav-link.active {
      background-color: rgba(168, 199, 250, 0.16);
      color: var(--md-primary);
    }

    .nav-link .material-icons-round {
      font-size: 24px;
    }

    /* Main Content */
    .main-content {
      margin-left: 260px;
      padding: 2rem;
    }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .main-content { margin-left: 0; }
      .sidebar.show { transform: translateX(0); }
    }

    /* Cards */
    .card {
      background-color: var(--md-surface);
      border: 1px solid var(--md-border);
      border-radius: 16px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .card-header {
      background-color: transparent;
      border-bottom: 1px solid var(--md-border);
      padding: 1.25rem 1.5rem;
      font-weight: 500;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Metrics */
    .metric-item {
      background-color: var(--md-surface-2);
      padding: 1.25rem;
      border-radius: 12px;
      height: 100%;
    }
    
    .metric-label {
      color: var(--md-text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 400;
      color: var(--md-text);
    }

    /* Text Colors */
    .text-success-custom { color: var(--md-success) !important; }
    .text-danger-custom { color: var(--md-error) !important; }
    .text-warning-custom { color: var(--md-warning) !important; }
    .text-primary-custom { color: var(--md-primary) !important; }

    /* Buttons */
    .btn {
      border-radius: 50px;
      padding: 0.5rem 1.25rem;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background-color: var(--md-primary);
      color: var(--md-on-primary);
      border: none;
    }
    .btn-primary:hover {
      background-color: #8ab4f8; /* Lighter shade */
      color: var(--md-on-primary);
    }

    .btn-outline-secondary {
      color: var(--md-text-muted);
      border-color: var(--md-border);
    }
    .btn-outline-secondary:hover {
      background-color: var(--md-surface-2);
      color: var(--md-text);
      border-color: var(--md-text);
    }

    /* Chips/Badges */
    .badge-material {
      padding: 0.5em 1em;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.75rem;
    }
    .bg-success-subtle { background-color: rgba(109, 213, 140, 0.15) !important; color: var(--md-success) !important; }
    .bg-danger-subtle { background-color: rgba(255, 180, 171, 0.15) !important; color: var(--md-error) !important; }
    .bg-warning-subtle { background-color: rgba(253, 196, 0, 0.15) !important; color: var(--md-warning) !important; }

    /* Prediction Block */
    .prediction-value {
      font-size: 3rem;
      font-weight: 700;
      margin: 1rem 0;
    }

    /* Info Tooltip */
    .info-icon {
      font-size: 18px;
      color: var(--md-text-muted);
      cursor: help;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .info-icon:hover { color: var(--md-primary); }

    /* Inputs */
    .form-control {
      background-color: var(--md-surface-2);
      border: 1px solid var(--md-border);
      color: var(--md-text);
      border-radius: 8px;
      padding: 0.75rem;
    }
    .form-control:focus {
      background-color: var(--md-surface-2);
      border-color: var(--md-primary);
      color: var(--md-text);
      box-shadow: 0 0 0 2px rgba(168, 199, 250, 0.25);
    }

    /* Animations */
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Live indicator dot */
    .live-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #6dd58c;
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .section { display: none; }
    .section.active { display: block; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar d-flex flex-column">
    <div class="sidebar-brand">
      <span class="material-icons-round text-primary-custom">trending_up</span> Kite Quant
    </div>
    <ul class="nav flex-column mt-3">
      <li class="nav-item mb-2">
        <a href="{{ url_for('dashboard') }}#overview" class="nav-link active" data-section="overview" onclick="showSection('overview', this); return false;">
          <span class="material-icons-round">dashboard</span> Overview
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="{{ url_for('dashboard') }}#testing" class="nav-link" data-section="testing" onclick="showSection('testing', this); return false;">
          <span class="material-icons-round">science</span> Testing
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="{{ url_for('dashboard') }}#live" class="nav-link" data-section="live" onclick="showSection('live', this); return false;">
          <span class="material-icons-round">flash_on</span> Live Trading
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="{{ url_for('dashboard') }}#analytics" class="nav-link" data-section="analytics" onclick="showSection('analytics', this); return false;">
          <span class="material-icons-round">insights</span> Analytics
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="{{ url_for('dashboard') }}#zerodha" class="nav-link" data-section="zerodha" onclick="showSection('zerodha', this); return false;">
          <span class="material-icons-round">account_balance</span> My Zerodha
        </a>
      </li>
      <li class="nav-item mt-auto mb-3">
        <a href="{{ url_for('settings') }}" class="nav-link">
          <span class="material-icons-round">settings</span> Settings
        </a>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="mb-0 fw-bold" id="page-title">Overview</h4>
      <div class="d-flex align-items-center gap-3">
        <button type="button" class="btn btn-sm btn-outline-secondary d-flex align-items-center" id="gpt-status-btn" onclick="checkGptStatus()" title="Check if OpenAI (GPT) token is working">
          <span class="material-icons-round fs-6 me-1">smart_toy</span>
          <span id="gpt-status-text">GPT: Check</span>
        </button>
        <span class="badge bg-primary bg-opacity-10 text-primary-custom px-3 py-2 rounded-pill d-flex align-items-center">
          <span class="material-icons-round fs-6 me-2">schedule</span>
          <span id="current-time">—</span>
        </span>
      </div>
      </div>
      
    <!-- OVERVIEW SECTION -->
    <div id="section-overview" class="section active fade-in">
      
      <!-- Zerodha Authentication Status -->
      <div class="alert border-0 mb-4 d-flex align-items-center justify-content-between" id="zerodha-auth-alert" style="background: rgba(168, 199, 250, 0.1);">
        <div class="d-flex align-items-center">
          <span class="material-icons-round me-2" style="color: #a8c7fa;">vpn_key</span>
          <div>
            <strong id="auth-status-text">Checking Zerodha authentication...</strong>
            <div class="small text-muted" id="auth-status-details"></div>
          </div>
        </div>
        <button class="btn btn-sm btn-primary" id="generate-token-btn" onclick="generateZerodhaToken()">
          <span class="material-icons-round fs-6 me-1">refresh</span> Generate Token
        </button>
      </div>
      
      <!-- Metrics Grid -->
      <div class="row g-3 mb-4">
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Status <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Trading Status</strong><br/>Shows if your bot is:<br/>• Running - Actively trading<br/>• Stopped - Paused by you<br/>• Auto-Closed - Market closed">info</span></div>
            <div class="metric-value" id="overview-status">—</div>
        </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Mode <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Trading Mode</strong><br/>• <strong>Backtest:</strong> Test strategy with past data (no real money)<br/>• <strong>Live:</strong> Real trading with actual money">info</span></div>
            <div class="metric-value" id="overview-mode">BACKTEST</div>
        </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">USA Bias <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>USA Market Influence</strong><br/>How yesterday's US market (S&P 500) affects today's Indian market<br/>• Bullish ↗: US went up (positive for India)<br/>• Bearish ↘: US went down (negative for India)<br/>• Neutral →: No strong impact">info</span></div>
            <div class="metric-value" id="overview-usBias">—</div>
            <div class="small text-muted mt-1" id="overview-usBiasDate" style="font-size: 0.7rem;"></div>
        </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">USA Live (Fut) <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>S&P 500 Futures (Real-time)</strong><br/>Live US market sentiment during trading hours<br/>Futures = Contract to buy/sell index later<br/>Helps predict how US market will open">info</span></div>
            <div class="metric-value" id="overview-usFutures">—</div>
            <div class="small text-muted mt-1" id="overview-usFuturesDate" style="font-size: 0.7rem;"></div>
        </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Nifty 50 Index (India) <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Nifty 50</strong> - India's benchmark stock index<br/>Tracks top 50 companies on NSE<br/>Real-time market performance indicator">info</span></div>
            <div class="metric-value" id="overview-niftyLive">—</div>
            <div class="small text-muted mt-1" id="overview-niftyLiveDate" style="font-size: 0.7rem;"></div>
        </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Bank Nifty <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Bank Nifty Index</strong><br/>Tracks top banking stocks on NSE<br/>Important for banking sector sentiment<br/>Shows live price and trend">info</span></div>
            <div class="metric-value" id="overview-bankNifty">—</div>
            <div class="small text-muted mt-1" id="overview-bankNiftyDate" style="font-size: 0.7rem;"></div>
        </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">India VIX <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>India VIX (Volatility Index)</strong><br/>Fear gauge of Indian market<br/>• Low (<15): Calm market<br/>• Medium (15-25): Normal volatility<br/>• High (>25): High fear/uncertainty<br/>Higher VIX = Higher risk">info</span></div>
            <div class="metric-value" id="overview-indiaVix">—</div>
        </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Market Status <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Market Condition</strong><br/>Current market behavior:<br/>• Trending: Clear direction (bullish/bearish)<br/>• Sideways: Range-bound, no clear trend<br/>• Volatile: High fluctuations, unpredictable<br/>Helps choose right trading strategy">info</span></div>
            <div class="metric-value" id="overview-marketStatus">—</div>
        </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Sentiment <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>News Sentiment Score</strong><br/>AI analyzes recent news articles<br/>• Positive (>0): Good news, market optimism<br/>• Negative (<0): Bad news, market pessimism<br/>• Range: -1 (very negative) to +1 (very positive)">info</span></div>
            <div class="metric-value" id="overview-sentiment">—</div>
        </div>
      </div>
      
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Stock Price <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Current Stock Price</strong><br/>Live price of the selected stock<br/>Updates every second during market hours">info</span></div>
            <div class="metric-value" id="overview-price">—</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Available Balance <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Trading Balance</strong><br/>Available funds in your Zerodha account<br/>Money you can use for new trades<br/>Updates in real-time from Zerodha">info</span></div>
            <div class="metric-value" id="overview-balance">—</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Today's P&L <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Today's Profit & Loss</strong><br/>Profit or loss for today's trading session only<br/>• Green (+): Today's profit<br/>• Red (-): Today's loss<br/>Resets at market open each day">info</span></div>
            <div class="metric-value" id="overview-todayPnl">₹0.00</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Total P&L <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Total Profit & Loss</strong><br/>Cumulative profit or loss from all your trades<br/>• Green (+): Overall making profit<br/>• Red (-): Overall in loss<br/>Includes realized + unrealized gains">info</span></div>
            <div class="metric-value" id="overview-pnl">—</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Trades Today <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Daily Trade Count</strong><br/>Number of trades executed today vs maximum allowed<br/>Example: 2/5 means 2 trades done, 3 remaining<br/>Prevents overtrading">info</span></div>
            <div class="metric-value" id="overview-tradesToday">0 / 3</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Max Trades/Day <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>Daily Trade Limit</strong><br/>Maximum trades allowed per day<br/>Risk management feature<br/>Prevents overtrading and excessive losses<br/>Configure in Settings">info</span></div>
            <div class="metric-value" id="overview-maxTrades">3</div>
          </div>
      </div>
    </div>
    
      <div class="row g-4 mb-4">
        <!-- Prediction Card -->
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header">
              <span>Today's Market Prediction</span>
              <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>AI Market Prediction</strong><br/>Predicts if market will go up (Bullish ↗) or down (Bearish ↘) today<br/><br/>Based on:<br/>• USA market impact<br/>• News sentiment analysis<br/>• Technical indicators (RSI, EMA, VWAP)<br/><br/>Generated after US market closes">info</span>
            </div>
            <div class="card-body text-center d-flex flex-column justify-content-center">
              <div class="d-flex justify-content-center align-items-center gap-2">
                <div id="market-prediction" class="prediction-value text-muted">—</div>
                <span class="material-icons-round info-icon" id="prediction-reasoning-icon" style="display: none; font-size: 24px;" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="Loading factors...">
                  help_outline
                </span>
              </div>
              <div id="prediction-confidence" class="text-muted small">Confidence: —</div>
              <div id="prediction-factors" class="mt-3 text-start bg-body-tertiary p-3 rounded small text-muted">
                Loading factors...
              </div>
            </div>
          </div>
      </div>
      
        <!-- Prediction vs Actual -->
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header">
              <span>Prediction Accuracy</span>
              <span class="material-icons-round info-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<strong>How Accurate Was the Prediction?</strong><br/><br/>Compares morning prediction with actual market movement<br/><br/>• <strong>Predicted:</strong> What AI forecasted<br/>• <strong>Actual:</strong> What really happened<br/>• <strong>Change %:</strong> How much market moved<br/>• <strong>Overall Accuracy:</strong> Success rate of all predictions">info</span>
            </div>
            <div class="card-body">
              <div class="row text-center my-3">
                <div class="col-6 border-end border-secondary">
                  <div class="metric-label justify-content-center">Predicted</div>
                  <div id="predicted-direction" class="fs-3 fw-normal text-white">—</div>
        </div>
                <div class="col-6">
                  <div class="metric-label justify-content-center">Actual</div>
                  <div id="actual-direction" class="fs-3 fw-normal text-white">—</div>
        </div>
            </div>
              <div class="text-center mb-4">
                <span id="prediction-result" class="badge bg-secondary p-2 fw-normal">Waiting for close...</span>
          </div>
              <div class="d-flex justify-content-between px-3 text-muted small">
                <span>Change: <span id="price-change-pct" class="text-white fw-bold">—</span></span>
                <span>Accuracy: <span id="overall-accuracy" class="text-white fw-bold">—</span></span>
        </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row g-4">
        <!-- News -->
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header">
              <span class="d-flex align-items-center gap-2"><span class="material-icons-round fs-5 text-warning-custom">newspaper</span> Headlines</span>
            </div>
            <ul class="list-group list-group-flush" id="overview-newsList" style="max-height: 400px; overflow-y: auto;">
              <li class="list-group-item bg-transparent text-muted text-center py-4">Loading news...</li>
            </ul>
          </div>
      </div>
      
        <!-- History -->
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header">
              <span class="d-flex align-items-center gap-2"><span class="material-icons-round fs-5 text-primary-custom">history</span> History</span>
              <div>
                <button class="btn btn-sm btn-outline-secondary py-1" onclick="loadPredictionHistory()">Refresh</button>
                <button class="btn btn-sm btn-outline-secondary py-1" id="excel-download-btn" onclick="downloadPredictionHistoryExcel()" style="display: none;">CSV</button>
          </div>
          </div>
            <div class="card-body p-0">
              <div id="history-loading" class="text-center py-4 d-none">
                <div class="spinner-border text-primary" role="status"></div>
          </div>
              <div id="prediction-history" style="display: none;">
                <div class="table-responsive">
                  <table class="table table-dark table-hover mb-0 align-middle small">
                    <thead>
                      <tr class="border-bottom border-secondary border-opacity-25 text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                        <th class="fw-medium py-3">Date</th>
                        <th class="fw-medium py-3">Pred</th>
                        <th class="fw-medium py-3">USA Bias</th>
                        <th class="fw-medium py-3">Actual</th>
                        <th class="fw-medium py-3">Res</th>
                        <th class="fw-medium py-3">Day Δ%</th>
                        <th class="fw-medium py-3">Analysis</th>
                      </tr>
                    </thead>
                    <tbody id="prediction-history-body"></tbody>
                  </table>
                </div>
                <div class="d-flex justify-content-between align-items-center p-3">
                  <span class="text-muted small" id="pagination-info">0-0 of 0</span>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" id="prev-page-btn" onclick="changePredictionHistoryPage(-1)">&lt;</button>
                    <button class="btn btn-outline-secondary" id="next-page-btn" onclick="changePredictionHistoryPage(1)">&gt;</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TESTING SECTION -->
    <div id="section-testing" class="section fade-in">
      <div class="alert bg-warning-subtle border-0 d-flex align-items-center mb-4" role="alert">
        <span class="material-icons-round me-2 text-warning-custom">warning</span>
        <div class="text-warning-custom small">Testing Mode - No real trades will be executed.</div>
      </div>

      <div class="row g-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">Config</div>
            <div class="card-body d-grid gap-3">
              <div>
                <label class="form-label small text-muted">Symbol</label>
                <input type="text" class="form-control" id="backtestSymbol" value="RELIANCE">
          </div>
              <div>
                <label class="form-label small text-muted">Days</label>
                <input type="number" class="form-control" id="backtestDays" value="60">
        </div>
              <button class="btn btn-outline-secondary w-100 justify-content-center" onclick="loadTradeSuggestions()">Get Suggestions</button>
              <button class="btn btn-primary w-100 justify-content-center" onclick="runBacktest()">Run Backtest</button>
      </div>
    </div>
    
          <div id="tradeSuggestions" class="card bg-primary bg-opacity-10 border-0 mt-3" style="display: none;">
            <div class="card-body">
              <h6 class="text-primary-custom fw-bold mb-3">Suggestions for <span id="suggestionSymbol"></span></h6>
              <div class="d-flex justify-content-between small mb-2"><span>Min:</span> <strong id="suggestionMin">—</strong></div>
              <div class="d-flex justify-content-between small mb-2"><span>Max:</span> <strong id="suggestionMax">—</strong></div>
              <div class="d-flex justify-content-between small mb-3"><span>Current:</span> <strong id="suggestionCurrent">—</strong></div>
              <div class="text-muted small fst-italic border-top border-secondary pt-2" id="suggestionReasoning">—</div>
            </div>
          </div>
      </div>
      
        <div class="col-md-8">
          <div class="card h-100">
            <div class="card-header">Results</div>
            <div class="card-body">
              <div id="backtestResultsPane" style="display: none;">
                <div id="backtestResults" style="max-height: 400px; overflow-y: auto;"></div>
          </div>
              <div id="backtestPlaceholder" class="text-center py-5 text-muted">
                <span class="material-icons-round fs-1 opacity-25">bar_chart</span>
                <p>Run a backtest to see results</p>
          </div>
        </div>
            </div>
              </div>
            </div>
          </div>

    <!-- LIVE SECTION -->
    <div id="section-live" class="section fade-in">
      <div class="alert bg-danger-subtle border-0 d-flex align-items-center mb-4" role="alert">
        <span class="material-icons-round me-2 text-danger-custom">dangerous</span>
        <div class="text-danger-custom small">Live Trading Mode - Real money will be used. Ensure stop-losses are set.</div>
        </div>

      <div class="row g-4">
        <!-- Controls -->
        <div class="col-lg-4">
          <div class="card mb-4">
            <div class="card-header">Controls</div>
            <div class="card-body d-grid gap-3">
              <!-- 1. Amount to use (first) — saved locally -->
              <div>
                <label class="form-label small text-muted">Amount to use for trade (₹)</label>
                <input type="number" class="form-control" id="liveAmountToUse" placeholder="e.g. 50000" min="0" step="1000" title="Capital for this trade — use with suggestions below">
              <div id="liveAmountSaveMsg" class="small mt-1 d-none"></div>
              </div>
              <button class="btn btn-sm btn-outline-primary" type="button" onclick="saveTradingAmount()">Save amount</button>

              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 py-2 border-bottom border-secondary border-opacity-25">
                <span class="small text-muted">Available balance (Zerodha)</span>
                <span class="fw-bold" id="live-balance">—</span>
              </div>
              <div class="position-relative">
                <label class="form-label small text-muted">Trading Symbol <span class="text-muted">(type to search from Zerodha)</span></label>
                <input type="text" class="form-control" id="liveSymbol" value="RELIANCE" placeholder="Type 2+ letters to search NSE symbols" autocomplete="off" oninput="onLiveSymbolSearchInput()" onchange="updateLiveSymbol()" onfocus="onLiveSymbolSearchInput()">
                <div id="liveSymbolDropdown" class="position-absolute top-100 start-0 end-0 mt-1 border border-secondary rounded bg-dark overflow-auto d-none" style="max-height: 320px; z-index: 1050;"></div>
              </div>
              <button class="btn btn-outline-secondary justify-content-center" onclick="loadLiveTradeSuggestions()">Get Suggestions</button>
              
              <div id="liveTradeSuggestions" class="bg-primary bg-opacity-10 p-3 rounded" style="display: none;">
                <div class="d-flex justify-content-between small mb-2">
                  <span>Suggested Max:</span> <strong id="liveSuggestionMax" class="text-primary-custom">—</strong>
        </div>
                <button class="btn btn-sm btn-primary w-100 justify-content-center" onclick="applySuggestedMax()">Apply</button>
      </div>
      
              <div class="d-grid gap-2 pt-3 border-top border-secondary">
                <button class="btn btn-success justify-content-center text-white" id="btnStart" onclick="startTrading()">
                  <span class="material-icons-round fs-5">play_arrow</span> Start
                </button>
                <button class="btn btn-warning justify-content-center text-dark" id="btnStop" onclick="stopTrading()" disabled>
                  <span class="material-icons-round fs-5">stop</span> Stop
                </button>
                <button class="btn btn-danger justify-content-center" id="btnKill" onclick="killSwitch()">
                  <span class="material-icons-round fs-5">cancel</span> Kill Switch
                </button>
          </div>
              
              <div class="text-center mt-2 small">
                <div class="text-muted">Auto-close: <span class="text-white" id="auto-close-time-display">2:30 PM</span> IST</div>
                <div class="text-primary-custom fw-bold" id="live-countdown">—</div>
          </div>
          </div>
          </div>
          </div>

        <!-- Live Data -->
        <div class="col-lg-8">
          <!-- Mini Metrics -->
          <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
              <div class="metric-item py-2">
                <div class="metric-label">Status</div>
                <div class="metric-value fs-5" id="live-status">—</div>
          </div>
          </div>
            <div class="col-6 col-md-3">
              <div class="metric-item py-2">
                <div class="metric-label">Price</div>
                <div class="metric-value fs-5" id="live-price">—</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-item py-2">
                <div class="metric-label">P&L</div>
                <div class="metric-value fs-5" id="live-pnl">—</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="metric-item py-2">
                <div class="metric-label">Trades</div>
                <div class="metric-value fs-5" id="live-tradesToday">0 / 3</div>
          </div>
        </div>
      </div>

          <!-- Intraday Picks for Trading (with checkboxes to select for trading) -->
          <div class="card mb-4">
            <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
              <span>Suggestions in sequence (use with amount above)</span>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" id="livePicksLoadBtn" onclick="loadLiveIntradayPicks()">Load Picks</button>
                <button type="button" class="btn btn-sm btn-primary" id="livePicksApplyBtn" onclick="applySelectedPicksToTrading()" disabled title="Set first selected as trading symbol">Use selected</button>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="live-picks-loading" class="p-3 text-muted small text-center d-none">Loading…</div>
              <div id="live-picks-error" class="p-3 text-warning small d-none"></div>
              <div class="table-responsive" id="live-picks-wrap" style="display: none;">
                <table class="table table-dark table-hover mb-0 align-middle">
                  <thead>
                    <tr class="text-muted text-uppercase" style="font-size: 0.7rem;">
                      <th class="ps-3" style="width: 2.5rem;">Trade</th>
                      <th>Symbol</th>
                      <th>Prediction</th>
                      <th class="text-end">Score</th>
                    </tr>
                  </thead>
                  <tbody id="live-picks-tbody">
                  </tbody>
                </table>
              </div>
              <div id="live-picks-empty" class="p-3 text-muted small text-center">Click &quot;Load Picks&quot; to load intraday picks, then check symbols you want to trade.</div>
            </div>
          </div>
      
          <div class="card mb-4">
            <div class="card-header">Open Positions</div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 align-middle">
          <thead>
                    <tr><th class="ps-4">Symbol</th><th>Qty</th><th>P&L</th></tr>
          </thead>
          <tbody id="live-positionsBody">
                    <tr><td colspan="3" class="ps-4 text-muted">No positions</td></tr>
          </tbody>
        </table>
              </div>
            </div>
      </div>
      </div>
    </div>
  </div>

    <!-- Analytics Section -->
    <div id="section-analytics" class="section fade-in">
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Profit Analysis</h5>
            <div class="d-flex gap-2">
              <select class="form-select form-select-sm" id="analyticsTimeRange" onchange="loadAnalytics()" style="width: auto;">
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="all">All Time</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <!-- Profit by Weekday Chart -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header d-flex align-items-center">
              <span class="material-icons-round me-2">calendar_today</span>
              Profit by Weekday
            </div>
            <div class="card-body">
              <canvas id="chartWeekday" style="max-height: 300px;"></canvas>
            </div>
          </div>
        </div>

        <!-- Profit by Time of Day Chart -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header d-flex align-items-center">
              <span class="material-icons-round me-2">schedule</span>
              Profit by Time of Day
            </div>
            <div class="card-body">
              <canvas id="chartTimeOfDay" style="max-height: 300px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Stats -->
      <div class="row g-4 mb-5">
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Best Day</div>
            <div class="metric-value text-success-custom" id="analytics-bestDay">—</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Worst Day</div>
            <div class="metric-value text-danger-custom" id="analytics-worstDay">—</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Best Time</div>
            <div class="metric-value text-success-custom" id="analytics-bestTime">—</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="metric-item">
            <div class="metric-label">Total Trades</div>
            <div class="metric-value" id="analytics-totalTrades">—</div>
          </div>
        </div>
      </div>

      <!-- Backtest vs Live Comparison -->
      <div class="row mb-3">
        <div class="col-12">
          <h5 class="mb-3">Backtest vs Live Performance</h5>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <!-- Comparison Chart -->
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header d-flex align-items-center">
              <span class="material-icons-round me-2">compare_arrows</span>
              Performance Comparison
            </div>
            <div class="card-body">
              <canvas id="chartComparison" style="max-height: 300px;"></canvas>
            </div>
          </div>
        </div>

        <!-- Win Rate Comparison -->
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header">Win Rate</div>
            <div class="card-body d-flex flex-column justify-content-center">
              <div class="mb-4 text-center">
                <div class="small text-muted mb-1">Backtest</div>
                <div class="display-6 text-primary-custom" id="comparison-backtestWinRate">—</div>
              </div>
              <div class="text-center">
                <div class="small text-muted mb-1">Live Trading</div>
                <div class="display-6 text-success-custom" id="comparison-liveWinRate">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Comparison Table -->
      <div class="row g-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">Detailed Metrics Comparison</div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-dark table-hover">
                  <thead>
                    <tr>
                      <th>Metric</th>
                      <th class="text-center">Backtest</th>
                      <th class="text-center">Live</th>
                      <th class="text-center">Difference</th>
                    </tr>
                  </thead>
                  <tbody id="comparisonTableBody">
                    <tr>
                      <td>Total P&L</td>
                      <td class="text-center" id="comparison-backtest-pnl">—</td>
                      <td class="text-center" id="comparison-live-pnl">—</td>
                      <td class="text-center" id="comparison-diff-pnl">—</td>
                    </tr>
                    <tr>
                      <td>Avg Profit/Trade</td>
                      <td class="text-center" id="comparison-backtest-avgProfit">—</td>
                      <td class="text-center" id="comparison-live-avgProfit">—</td>
                      <td class="text-center" id="comparison-diff-avgProfit">—</td>
                    </tr>
                    <tr>
                      <td>Total Trades</td>
                      <td class="text-center" id="comparison-backtest-trades">—</td>
                      <td class="text-center" id="comparison-live-trades">—</td>
                      <td class="text-center" id="comparison-diff-trades">—</td>
                    </tr>
                    <tr>
                      <td>Max Drawdown</td>
                      <td class="text-center" id="comparison-backtest-drawdown">—</td>
                      <td class="text-center" id="comparison-live-drawdown">—</td>
                      <td class="text-center" id="comparison-diff-drawdown">—</td>
                    </tr>
                    <tr>
                      <td>Sharpe Ratio</td>
                      <td class="text-center" id="comparison-backtest-sharpe">—</td>
                      <td class="text-center" id="comparison-live-sharpe">—</td>
                      <td class="text-center" id="comparison-diff-sharpe">—</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="alert bg-info-subtle border-0 mt-3 d-flex align-items-start">
                <span class="material-icons-round me-2 text-info">info</span>
                <small class="text-muted">
                  <strong>Note:</strong> Live trading data will populate once you start real trading. 
                  Backtest data is based on historical strategy performance. Differences help identify slippage, fees, and execution challenges.
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- My Zerodha Section -->
    <div id="section-zerodha" class="section fade-in">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">Account & trading info from Zerodha</h5>
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadZerodhaProfile()">
          <span class="material-icons-round align-middle me-1" style="font-size: 1rem;">refresh</span> Refresh
        </button>
      </div>
      <div id="zerodha-profile-error" class="alert alert-warning border-0 d-none mb-4"></div>
      <div id="zerodha-profile-content">
        <!-- Profile card -->
        <div class="card mb-4">
          <div class="card-header d-flex align-items-center">
            <span class="material-icons-round me-2">person</span> Profile
          </div>
          <div class="card-body">
            <div class="row g-3" id="zerodha-profile-fields"></div>
          </div>
        </div>
        <!-- Margins card -->
        <div class="card mb-4">
          <div class="card-header d-flex align-items-center">
            <span class="material-icons-round me-2">account_balance_wallet</span> Equity margins
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-12"><strong class="text-primary-custom">Available</strong></div>
              <div class="col-md-6 col-lg-4 mt-2">
                <span class="text-muted small">Cash</span>
                <div class="fw-bold" id="z-margin-cash">—</div>
              </div>
              <div class="col-md-6 col-lg-4 mt-2">
                <span class="text-muted small">Live balance</span>
                <div class="fw-bold" id="z-margin-live-balance">—</div>
              </div>
              <div class="col-md-6 col-lg-4 mt-2">
                <span class="text-muted small">Opening balance</span>
                <div class="fw-bold" id="z-margin-opening">—</div>
              </div>
              <div class="col-md-6 col-lg-4 mt-2">
                <span class="text-muted small">Collateral</span>
                <div class="fw-bold" id="z-margin-collateral">—</div>
              </div>
              <div class="col-md-6 col-lg-4 mt-2">
                <span class="text-muted small">Adhoc margin</span>
                <div class="fw-bold" id="z-margin-adhoc">—</div>
              </div>
              <div class="col-md-6 col-lg-4 mt-2">
                <span class="text-muted small">Intraday pay-in</span>
                <div class="fw-bold" id="z-margin-intraday-payin">—</div>
              </div>
            </div>
            <hr class="my-3">
            <div class="row">
              <div class="col-12"><strong class="text-primary-custom">Utilised</strong></div>
              <div class="col-md-6 col-lg-3 mt-2">
                <span class="text-muted small">Debits</span>
                <div class="fw-bold" id="z-margin-debits">—</div>
              </div>
              <div class="col-md-6 col-lg-3 mt-2">
                <span class="text-muted small">SPAN</span>
                <div class="fw-bold" id="z-margin-span">—</div>
              </div>
              <div class="col-md-6 col-lg-3 mt-2">
                <span class="text-muted small">Exposure</span>
                <div class="fw-bold" id="z-margin-exposure">—</div>
              </div>
              <div class="col-md-6 col-lg-3 mt-2">
                <span class="text-muted small">M2M (unrealised)</span>
                <div class="fw-bold" id="z-margin-m2m-unrealised">—</div>
              </div>
              <div class="col-md-6 col-lg-3 mt-2">
                <span class="text-muted small">M2M (realised)</span>
                <div class="fw-bold" id="z-margin-m2m-realised">—</div>
              </div>
              <div class="col-md-6 col-lg-3 mt-2">
                <span class="text-muted small">Delivery</span>
                <div class="fw-bold" id="z-margin-delivery">—</div>
              </div>
            </div>
            <hr class="my-3">
            <div class="row">
              <div class="col-12">
                <span class="text-muted small">Net</span>
                <div class="fw-bold fs-5 text-primary-custom" id="z-margin-net">—</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Positions summary -->
        <div class="card mb-4">
          <div class="card-header d-flex align-items-center">
            <span class="material-icons-round me-2">list_alt</span> Open positions
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span>Count: <strong id="z-positions-count">0</strong></span>
              <span>Total P&L: <strong id="z-positions-pnl" class="text-white">₹0.00</strong></span>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-hover table-sm">
                <thead>
                  <tr>
                    <th>Symbol</th>
                    <th class="text-end">Qty</th>
                    <th class="text-end">Avg price</th>
                    <th class="text-end">Last</th>
                    <th class="text-end">P&L</th>
                  </tr>
                </thead>
                <tbody id="zerodha-positions-tbody">
                  <tr><td colspan="5" class="text-muted text-center">No open positions</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

<!-- Chart.js -->
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<!-- Bootstrap Bundle JS -->
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script>
    // Helper function to convert 24-hour time to 12-hour format with AM/PM
    function convertTo12Hour(time24) {
        if (!time24) return time24;
        const [hours24, minutes] = time24.split(':');
        let hours = parseInt(hours24);
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        return `${hours}:${minutes} ${ampm}`;
    }
    
    // Update current time clock (12-hour format with AM/PM)
    function updateClock() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const milliseconds = now.getMilliseconds().toString().padStart(3, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        
        // Convert to 12-hour format
        hours = hours % 12;
        hours = hours ? hours : 12; // 0 should be 12
        hours = hours.toString().padStart(2, '0'); // Zero-pad hours
        
        const timeString = `${hours}:${minutes}:${seconds}.${milliseconds} ${ampm} IST`;
        const clockEl = document.getElementById('current-time');
        if (clockEl) clockEl.textContent = timeString;
    }
    
    // Update live market timestamps
    function updateLiveTimestamps() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const milliseconds = now.getMilliseconds().toString().padStart(3, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        
        // Convert to 12-hour format
        hours = hours % 12;
        hours = hours ? hours : 12;
        hours = hours.toString().padStart(2, '0');
        
        const timeStr = `${hours}:${minutes}:${seconds}.${milliseconds} ${ampm}`;
        
        // Update Nifty timestamp if market is live
        if (niftyIsLive) {
            const niftyDateEl = document.getElementById('overview-niftyLiveDate');
            if (niftyDateEl) {
                niftyDateEl.innerHTML = `<span class="live-dot"></span>Live: ${timeStr}`;
            }
        }
        
        // Update USA Futures timestamp if market is live
        if (usaFuturesIsLive) {
            const futDateEl = document.getElementById('overview-usFuturesDate');
            if (futDateEl) {
                futDateEl.innerHTML = `<span class="live-dot"></span>Live: ${timeStr}`;
            }
        }
    }
    
    // Update clock every 10ms to show milliseconds
    updateClock();
    setInterval(updateClock, 10);
    
    // Update live market timestamps every 10ms
    setInterval(updateLiveTimestamps, 10);
    
    // Logic Scripts
    const POLL_MS = 1000; // 1 second for real-time updates
    let pollTimer = null;
    let currentMode = 'backtest';
    let currentSymbol = 'RELIANCE';
    let niftyIsLive = false;
    let usaFuturesIsLive = false;

    // Global pagination data
    let allHistoryData = [];
    let currentHistoryPage = 1;
    const HISTORY_PER_PAGE = 5;

    // Page Navigation
    function showSection(sectionName, clickedElement) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        
      document.getElementById('section-' + sectionName).classList.add('active');
        if(clickedElement) clickedElement.classList.add('active');
      
        const titles = { 'overview': 'Overview', 'testing': 'Testing', 'live': 'Live Trading', 'analytics': 'Analytics', 'zerodha': 'My Zerodha' };
        document.getElementById('page-title').textContent = titles[sectionName] || 'Dashboard';

      // Update URL to /dashboard#section so the address bar reflects current section
      var baseUrl = '{{ url_for("dashboard") }}' || '/dashboard';
      history.pushState(null, '', baseUrl + '#' + sectionName);

      if (sectionName === 'zerodha') {
        loadZerodhaProfile();
      } else if (sectionName === 'live') {
        currentMode = 'live';
            if(document.getElementById('liveSymbol')) document.getElementById('liveSymbol').value = currentSymbol;
            loadTradingAmount();
            if (!pollTimer) { poll(); pollTimer = setInterval(poll, POLL_MS); }
      } else if (sectionName === 'overview') {
        currentMode = 'backtest';
            // Start continuous polling for Overview section too (for real-time Nifty data)
            if (!pollTimer) { poll(); pollTimer = setInterval(poll, POLL_MS); }
      } else if (sectionName === 'analytics') {
        // Load analytics data when switching to analytics section
        loadAnalytics();
      } else {
        currentMode = 'backtest';
            if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
            poll();
      }
    }

    // On load: if URL has a hash (#overview, #live, etc.), show that section
    function applyHashToSection() {
      var hash = window.location.hash.replace('#', '');
      var valid = ['overview', 'testing', 'live', 'analytics', 'zerodha'];
      if (hash && valid.indexOf(hash) !== -1) {
        var link = document.querySelector('.nav-link[data-section="' + hash + '"]');
        showSection(hash, link);
      }
    }
    window.addEventListener('hashchange', applyHashToSection);

    function api(path, options = {}) {
      return fetch(path, { ...options, headers: { 'Content-Type': 'application/json', ...options.headers } });
    }

    function updateUI(data, prefix = '') {
      const p = prefix ? prefix + '-' : '';
      
        // Status
      const statusEl = document.getElementById(p + 'status') || document.getElementById('overview-status');
      if (statusEl) {
        statusEl.textContent = data.status || '—';
            statusEl.className = 'metric-value ' + (data.status === 'RUNNING' ? 'text-success-custom' : data.status === 'AUTO_CLOSED' ? 'text-warning-custom' : 'text-muted');
      }
      
        // Mode
      const modeEl = document.getElementById(p + 'mode') || document.getElementById('overview-mode');
      if (modeEl) modeEl.textContent = (data.mode || 'backtest').toUpperCase();
      
        // US Bias
        let usBiasText = '—';
        let usBiasClass = 'text-muted';
        let usBiasIcon = '';
        
        // Check if US market is still open
        if (data.us_market_status === 'open') {
            usBiasText = 'Market Open';
            usBiasClass = 'text-warning-custom';
            usBiasIcon = '⏳';
        } else if (data.us_bias != null) {
            if (data.us_bias === 1) { usBiasText = 'Bullish'; usBiasClass = 'text-success-custom'; usBiasIcon = '↗'; }
            else if (data.us_bias === -1) { usBiasText = 'Bearish'; usBiasClass = 'text-danger-custom'; usBiasIcon = '↘'; }
            else { usBiasText = 'Neutral'; usBiasClass = 'text-warning-custom'; usBiasIcon = '→'; }
            
            if (data.us_market_pct_change != null) {
                const sign = data.us_market_pct_change >= 0 ? '+' : '';
                usBiasText += ` (${sign}${data.us_market_pct_change.toFixed(2)}%)`;
            }
        }
        const usBiasEls = document.querySelectorAll('[id$="usBias"]');
        usBiasEls.forEach(el => { 
            el.innerHTML = usBiasIcon ? `<span style="font-size: 1.2em;">${usBiasIcon}</span> ${usBiasText}` : usBiasText; 
            el.className = 'metric-value ' + usBiasClass; 
        });
        
        // US Bias Date
        const dateEl = document.getElementById(p + 'usBiasDate') || document.getElementById('overview-usBiasDate');
        if (dateEl) {
            if (data.us_market_status === 'open') {
                dateEl.textContent = 'Waiting for US close (~1:30 AM IST)';
                dateEl.className = 'small text-warning-custom mt-1';
            } else if (data.us_market_date) {
                const dateStr = new Date(data.us_market_date + 'T12:00:00').toLocaleDateString();
                dateEl.textContent = `US close: ${dateStr}`;
                dateEl.className = 'small text-muted mt-1';
            }
        }
        
        // US Futures
        if (data.us_futures_pct_change != null) {
            const futEl = document.getElementById(p + 'usFutures') || document.getElementById('overview-usFutures');
            
            if(futEl) {
                const sign = data.us_futures_pct_change >= 0 ? '+' : '';
                const futIcon = data.us_futures_pct_change >= 0 ? '↗' : '↘';
                futEl.innerHTML = `<span style="font-size: 1.2em;">${futIcon}</span> ${sign}${data.us_futures_pct_change.toFixed(2)}%`;
                futEl.className = 'metric-value ' + (data.us_futures_pct_change >= 0 ? 'text-success-custom' : 'text-danger-custom');
            }
            
            // Set flag to enable live timestamp updates
            usaFuturesIsLive = true;
        } else {
            usaFuturesIsLive = false;
            const futEl = document.getElementById(p + 'usFutures') || document.getElementById('overview-usFutures');
            const futDateEl = document.getElementById(p + 'usFuturesDate') || document.getElementById('overview-usFuturesDate');
            if(futEl) {
                futEl.textContent = 'Market Closed';
                futEl.className = 'metric-value text-muted';
            }
            if(futDateEl) {
                futDateEl.textContent = '';
            }
        }
        
        // Nifty 50 Live
        if (data.nifty_live_pct_change != null) {
            console.log('Nifty Live Update:', data.nifty_live_pct_change, data.nifty_live_date); // Debug log
            const niftyEl = document.getElementById(p + 'niftyLive') || document.getElementById('overview-niftyLive');
            
            if(niftyEl) {
                const sign = data.nifty_live_pct_change >= 0 ? '+' : '';
                const niftyIcon = data.nifty_live_pct_change >= 0 ? '↗' : '↘';
                const priceDisplay = data.nifty_live_price ? `<div style="font-size: 0.6em; opacity: 0.8;">${data.nifty_live_price.toFixed(2)}</div>` : '';
                niftyEl.innerHTML = `<span style="font-size: 1.2em;">${niftyIcon}</span> ${sign}${data.nifty_live_pct_change.toFixed(2)}%${priceDisplay}`;
                niftyEl.className = 'metric-value ' + (data.nifty_live_pct_change >= 0 ? 'text-success-custom' : 'text-danger-custom');
            }
            
            // Set flag to enable live timestamp updates
            niftyIsLive = true;
        } else {
            niftyIsLive = false;
             const niftyEl = document.getElementById(p + 'niftyLive') || document.getElementById('overview-niftyLive');
             const niftyDateEl = document.getElementById(p + 'niftyLiveDate') || document.getElementById('overview-niftyLiveDate');
             if(niftyEl) {
                 niftyEl.textContent = 'Market Closed';
                 niftyEl.className = 'metric-value text-muted';
             }
             if(niftyDateEl) {
                 niftyDateEl.textContent = '';
             }
        }

        // Bank Nifty
        if (data.bank_nifty_pct_change != null) {
            const bankNiftyEl = document.getElementById(p + 'bankNifty') || document.getElementById('overview-bankNifty');
            const bankNiftyDateEl = document.getElementById(p + 'bankNiftyDate') || document.getElementById('overview-bankNiftyDate');
            
            if(bankNiftyEl) {
                const sign = data.bank_nifty_pct_change >= 0 ? '+' : '';
                const icon = data.bank_nifty_pct_change >= 0 ? '↗' : '↘';
                const priceDisplay = data.bank_nifty_price ? `<div style="font-size: 0.6em; opacity: 0.8;">${data.bank_nifty_price.toFixed(2)}</div>` : '';
                bankNiftyEl.innerHTML = `<span style="font-size: 1.2em;">${icon}</span> ${sign}${data.bank_nifty_pct_change.toFixed(2)}%${priceDisplay}`;
                bankNiftyEl.className = 'metric-value ' + (data.bank_nifty_pct_change >= 0 ? 'text-success-custom' : 'text-danger-custom');
            }
            if(bankNiftyDateEl && data.bank_nifty_date) {
                bankNiftyDateEl.innerHTML = `<span class="live-dot"></span>Live`;
            }
        } else {
            const bankNiftyEl = document.getElementById(p + 'bankNifty') || document.getElementById('overview-bankNifty');
            if(bankNiftyEl) {
                bankNiftyEl.textContent = 'Market Closed';
                bankNiftyEl.className = 'metric-value text-muted';
            }
        }

        // India VIX
        if (data.india_vix != null) {
            const vixEl = document.getElementById(p + 'indiaVix') || document.getElementById('overview-indiaVix');
            if(vixEl) {
                const vixValue = data.india_vix;
                let vixColor = '';
                let vixLabel = '';
                
                if (vixValue < 15) {
                    vixColor = 'text-success-custom';
                    vixLabel = 'Low';
                } else if (vixValue < 25) {
                    vixColor = '';
                    vixLabel = 'Medium';
                } else {
                    vixColor = 'text-danger-custom';
                    vixLabel = 'High';
                }
                
                vixEl.innerHTML = `${vixValue.toFixed(2)} <span style="font-size: 0.6em; opacity: 0.8;">(${vixLabel})</span>`;
                vixEl.className = 'metric-value ' + vixColor;
            }
        } else {
            const vixEl = document.getElementById(p + 'indiaVix') || document.getElementById('overview-indiaVix');
            if(vixEl) vixEl.textContent = '—';
        }

        // Market Status
        if (data.market_status_type) {
            const statusEl = document.getElementById(p + 'marketStatus') || document.getElementById('overview-marketStatus');
            if(statusEl) {
                const statusMap = {
                    'trending': { icon: '📈', color: 'text-primary-custom', label: 'Trending' },
                    'sideways': { icon: '↔️', color: '', label: 'Sideways' },
                    'volatile': { icon: '⚠️', color: 'text-warning-custom', label: 'Volatile' }
                };
                const status = statusMap[data.market_status_type] || { icon: '', color: '', label: 'Unknown' };
                statusEl.innerHTML = `${status.icon} ${status.label}`;
                statusEl.className = 'metric-value ' + status.color;
            }
        } else {
            const statusEl = document.getElementById(p + 'marketStatus') || document.getElementById('overview-marketStatus');
            if(statusEl) statusEl.textContent = '—';
        }

        // Sentiment with label
        if (data.sentiment_score != null) {
            const sentimentEl = document.getElementById(p + 'sentiment') || document.getElementById('overview-sentiment');
            if(sentimentEl) {
                const score = data.sentiment_score;
                let label = '';
                let color = '';
                
                if (score > 0.3) {
                    label = 'Good';
                    color = 'text-success-custom';
                } else if (score > 0.1) {
                    label = 'Positive';
                    color = 'text-success-custom';
                } else if (score < -0.3) {
                    label = 'Bad';
                    color = 'text-danger-custom';
                } else if (score < -0.1) {
                    label = 'Negative';
                    color = 'text-danger-custom';
                } else {
                    label = 'Neutral';
                    color = '';
                }
                
                sentimentEl.innerHTML = `${score.toFixed(2)} <span style="font-size: 0.6em; opacity: 0.8;">(${label})</span>`;
                sentimentEl.className = 'metric-value ' + color;
            }
        } else {
            const sentimentEl = document.getElementById(p + 'sentiment') || document.getElementById('overview-sentiment');
            if(sentimentEl) sentimentEl.textContent = '—';
        }

        // Basic fields (stock price shows symbol name + value)
        const priceVal = data.price != null ? '₹' + Number(data.price).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '—';
        const map = {
            'price': (data.symbol || '—') + '  ' + priceVal,
            'tradesToday': (data.trade_count_today ?? 0) + ' / ' + (data.max_trades_per_day ?? 3),
            'maxTrades': data.max_trades_per_day ?? 3
        };
        for(let k in map) {
            const el = document.getElementById(p + k) || document.getElementById('overview-' + k);
            if(el) el.textContent = map[k];
        }

        // Total P&L
        const pnlEl = document.getElementById(p + 'pnl') || document.getElementById('overview-pnl');
        if(pnlEl) {
            pnlEl.textContent = data.pnl != null ? data.pnl.toFixed(2) : '—';
            pnlEl.className = 'metric-value ' + (data.pnl > 0 ? 'text-success-custom' : data.pnl < 0 ? 'text-danger-custom' : '');
        }

        // Available Balance
        const balanceEl = document.getElementById(p + 'balance') || document.getElementById('overview-balance');
        if(balanceEl) {
            balanceEl.textContent = data.balance != null ? '₹' + data.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '—';
        }

        // Amount to use for trade (Live section only) — sync from server when input not focused
        if(prefix === 'live') {
            const amountInp = document.getElementById('liveAmountToUse');
            if(amountInp && data.trading_amount != null && document.activeElement !== amountInp) amountInp.value = data.trading_amount;
        }

        // Today's P&L
        const todayPnlEl = document.getElementById(p + 'todayPnl') || document.getElementById('overview-todayPnl');
        if(todayPnlEl) {
            const todayPnl = data.today_pnl != null ? data.today_pnl : 0;
            const sign = todayPnl >= 0 ? '+' : '';
            todayPnlEl.textContent = '₹' + sign + todayPnl.toFixed(2);
            todayPnlEl.className = 'metric-value ' + (todayPnl > 0 ? 'text-success-custom' : todayPnl < 0 ? 'text-danger-custom' : '');
        }

        // Countdown
        const cdEl = document.getElementById(p + 'countdown') || document.getElementById('live-countdown');
        if(cdEl) cdEl.textContent = data.minutes_until_auto_close != null ? data.minutes_until_auto_close + ' min left' : '—';
        
        // Auto-close time display (convert to 12-hour format)
        const autoCloseTimeEl = document.getElementById('auto-close-time-display');
        if (autoCloseTimeEl && data.auto_close_time) {
            autoCloseTimeEl.textContent = convertTo12Hour(data.auto_close_time);
        }

        // Buttons
      if (prefix === 'live') {
        const running = data.trading_on === true;
        document.getElementById('btnStart').disabled = running || data.status === 'AUTO_CLOSED';
        document.getElementById('btnStop').disabled = !running;
      }
      
        // Live Positions
      if (prefix === 'live') {
        const tbody = document.getElementById('live-positionsBody');
            if(data.positions && data.positions.length > 0) {
                tbody.innerHTML = data.positions.map(p => 
                    `<tr><td class="ps-4">${p.symbol}</td><td>${p.quantity}</td><td class="${(p.pnl >= 0 ? 'text-success-custom' : 'text-danger-custom')}">${p.pnl}</td></tr>`
          ).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="ps-4 text-muted">No positions</td></tr>';
        }
      }
      
        // News with Links
      const newsList = document.getElementById(p + 'newsList') || document.getElementById('overview-newsList');
        if(newsList && data.news_headlines) {
            if(data.news_headlines.length === 0) newsList.innerHTML = '<li class="list-group-item bg-transparent text-muted text-center py-3">No news available</li>';
            else newsList.innerHTML = data.news_headlines.map(h => 
                `<li class="list-group-item bg-transparent text-muted border-bottom border-secondary border-opacity-10 py-3">
                    <a href="${h.url || '#'}" target="_blank" class="fw-bold text-light mb-1 text-decoration-none d-block hover-primary">${h.title}</a>
                    <div class="small d-flex justify-content-between">
                        <span>${h.source || 'Unknown'}</span>
                        <span>${h.publishedAt ? new Date(h.publishedAt).toLocaleDateString() : ''}</span>
                    </div>
                </li>`
          ).join('');
        }

        // Prediction (Overview only)
        if(prefix === 'overview' || !prefix) {
            const pred = data.market_prediction || 'NEUTRAL';
            const predEl = document.getElementById('market-prediction');
            if(predEl) {
                // Handle WAITING status
                if(pred === 'WAITING') {
                    predEl.textContent = '⏳ WAITING';
                    predEl.className = 'fs-1 fw-bold text-warning-custom';
                } else {
                    predEl.textContent = pred;
                }
                predEl.className = 'prediction-value ' + (pred === 'BULLISH' ? 'text-success-custom' : pred === 'BEARISH' ? 'text-danger-custom' : 'text-muted');
            }
            // Only show confidence if prediction is not WAITING
            if(document.getElementById('prediction-confidence')) {
                if(pred === 'WAITING' || data.prediction_confidence == null) {
                    document.getElementById('prediction-confidence').textContent = 'Confidence: —';
                } else {
                    document.getElementById('prediction-confidence').textContent = 'Confidence: ' + data.prediction_confidence + '%';
                }
            }
            
            // Factors
            const factorsEl = document.getElementById('prediction-factors');
            const icon = document.getElementById('prediction-reasoning-icon');
            
            if(data.prediction_factors && data.prediction_factors.length > 0) {
                factorsEl.innerHTML = '<div class="fw-bold mb-2">Analysis Factors:</div>' + data.prediction_factors.map(f => `<div class="mb-1">• ${f}</div>`).join('');
                if(icon) {
                    icon.style.display = 'inline-flex';
                    const tooltipContent = '<strong>Prediction Basis:</strong><br>' + data.prediction_factors.map(f => '• ' + f).join('<br>');
                    // Update Bootstrap tooltip
                    icon.setAttribute('data-bs-title', tooltipContent);
                    const tooltip = bootstrap.Tooltip.getInstance(icon);
                    if (tooltip) { tooltip.setContent({ '.tooltip-inner': tooltipContent }); }
                    else { new bootstrap.Tooltip(icon); }
                }
            } else {
                factorsEl.innerHTML = '<div class="text-muted fst-italic">No factors available</div>';
                if(icon) icon.style.display = 'none';
            }

            // Prediction vs Actual
            const predIcon = pred === 'WAITING' ? '⏳' : pred === 'BULLISH' ? '↗' : pred === 'BEARISH' ? '↘' : '→';
            document.getElementById('predicted-direction').innerHTML = `<span style="font-size: 1.5rem;">${predIcon}</span> ${pred}`;
            document.getElementById('predicted-direction').className = 'fs-3 fw-normal d-flex align-items-center justify-content-center gap-2 ' + (pred === 'WAITING' ? 'text-warning-custom' : pred === 'BULLISH' ? 'text-success-custom' : pred === 'BEARISH' ? 'text-danger-custom' : 'text-muted');
            
            // Actual - only show if available and not null
            const actual = (data.actual_direction && data.actual_direction !== 'None' && data.actual_direction !== 'null') ? data.actual_direction : '—';
            const actualIcon = actual === 'BULLISH' ? '↗' : actual === 'BEARISH' ? '↘' : actual === '—' ? '' : '→';
            document.getElementById('actual-direction').innerHTML = actualIcon ? `<span style="font-size: 1.5rem;">${actualIcon}</span> ${actual}` : actual;
            document.getElementById('actual-direction').className = 'fs-3 fw-normal d-flex align-items-center justify-content-center gap-2 ' + (actual === 'BULLISH' ? 'text-success-custom' : actual === 'BEARISH' ? 'text-danger-custom' : 'text-muted');
            
            const resEl = document.getElementById('prediction-result');
            // Only show result badge if both prediction and actual are available
            if(pred === 'WAITING') {
                resEl.textContent = 'Waiting for US market close...';
                resEl.className = 'badge bg-warning-subtle p-2 fw-normal';
            } else if(!data.actual_direction || data.actual_direction === '—') {
                resEl.textContent = 'Waiting for market close...';
                resEl.className = 'badge bg-secondary p-2 fw-normal';
            } else if(data.prediction_accuracy === 'CORRECT') {
                resEl.textContent = 'Correct Prediction';
                resEl.className = 'badge bg-success-subtle p-2 fw-normal';
            } else if(data.prediction_accuracy === 'INCORRECT') {
                resEl.textContent = 'Incorrect Prediction';
                resEl.className = 'badge bg-danger-subtle p-2 fw-normal';
            } else if(data.prediction_accuracy === 'PARTIAL') {
                resEl.textContent = 'Partial Match';
                resEl.className = 'badge bg-warning-subtle p-2 fw-normal';
            } else {
                resEl.textContent = 'Calculating...';
                resEl.className = 'badge bg-secondary p-2 fw-normal';
            }

            // Price change - only show if market closed and actual is available
            const priceChange = (actual !== '—' && data.price_change_pct) ? data.price_change_pct + '%' : '—';
            document.getElementById('price-change-pct').textContent = priceChange;
            document.getElementById('overall-accuracy').textContent = (data.overall_accuracy || 0) + '%';
        }
    }

    function poll() {
        api(`/api/live?symbol=${currentSymbol}&mode=${currentMode}`).then(r => r.json()).then(d => {
            updateUI(d, 'overview');
            updateUI(d, 'testing');
            updateUI(d, 'live');
        });
    }

    function startTrading() { api('/api/start', {method:'POST'}).then(r=>r.json()).then(d=>{ if(d.ok) { poll(); if(!pollTimer) pollTimer=setInterval(poll, POLL_MS); } }); }
    function stopTrading() { api('/api/stop', {method:'POST'}).then(()=>{ poll(); }); }
    function killSwitch() { if(confirm('Close all positions?')) api('/api/kill', {method:'POST'}).then(()=>{ stopTrading(); }); }
    let liveSymbolSearchDebounce = null;
    function onLiveSymbolSearchInput() {
        const inp = document.getElementById('liveSymbol');
        const drop = document.getElementById('liveSymbolDropdown');
        if (!inp || !drop) return;
        const q = (inp.value || '').trim();
        if (q.length < 2) { drop.classList.add('d-none'); drop.innerHTML = ''; return; }
        clearTimeout(liveSymbolSearchDebounce);
        liveSymbolSearchDebounce = setTimeout(function() {
            api('/api/zerodha/search-symbols?q=' + encodeURIComponent(q) + '&limit=20')
                .then(r => r.json())
                .then(d => {
                    if (!d.ok || !d.symbols || !d.symbols.length) { drop.classList.add('d-none'); drop.innerHTML = ''; return; }
                    drop.innerHTML = d.symbols.map(function(item) {
                        var sym = item.symbol || item.tradingsymbol || '';
                        var exchange = (item.exchange || 'NSE').toUpperCase();
                        var itype = (item.instrument_type || '').toUpperCase();
                        var typeBadge = itype === 'INDEX' ? ' <span class="badge bg-primary bg-opacity-50 small">Index</span>' : (itype === 'FUT' ? ' <span class="badge bg-warning bg-opacity-50 small text-dark">F&O</span>' : '');
                        var name = (item.name || '').substring(0, 28);
                        if ((item.name || '').length > 28) name += '…';
                        var last = item.last != null ? Number(item.last) : 0;
                        var o = item.open != null ? Number(item.open) : 0, h = item.high != null ? Number(item.high) : 0, l = item.low != null ? Number(item.low) : 0;
                        var changePct = item.change_pct != null ? Number(item.change_pct) : 0;
                        var pctColor = changePct > 0 ? '#6dd58c' : (changePct < 0 ? '#ffb4ab' : '#c4c7c5');
                        var priceStr = last ? '₹' + last.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '—';
                        var pctStr = (changePct > 0 ? '+' : '') + changePct.toFixed(2) + '%';
                        var ohlcStr = (o || h || l) ? ('O ' + o.toFixed(2) + '  H ' + h.toFixed(2) + '  L ' + l.toFixed(2)) : '';
                        return '<div class="px-3 py-2 border-bottom border-secondary border-opacity-25 symbol-search-item cursor-pointer d-flex justify-content-between align-items-center" data-symbol="' + sym + '" data-exchange="' + exchange + '" role="button" tabindex="0">' +
                            '<div class="text-start"><span class="badge bg-secondary bg-opacity-50 me-1 small">' + exchange + '</span>' + typeBadge + '<strong class="text-light">' + sym + '</strong>' + (name ? ' <span class="text-muted small d-block">' + name + '</span>' : '') + (ohlcStr ? ' <span class="text-muted small d-block opacity-75">' + ohlcStr + '</span>' : '') + '</div>' +
                            '<div class="text-end ms-2"><div class="fw-bold text-light">' + priceStr + '</div><div class="small fw-bold" style="color:' + pctColor + '">' + pctStr + '</div></div></div>';
                    }).join('');
                    drop.classList.remove('d-none');
                })
                .catch(function() { drop.classList.add('d-none'); drop.innerHTML = ''; });
        }, 280);
    }
    document.addEventListener('click', function(e) {
        var drop = document.getElementById('liveSymbolDropdown');
        var inp = document.getElementById('liveSymbol');
        if (drop && inp && !drop.contains(e.target) && e.target !== inp) drop.classList.add('d-none');
    });
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('liveSymbolDropdown').addEventListener('click', function(e) {
            var item = e.target.closest('.symbol-search-item');
            if (!item) return;
            var sym = item.getAttribute('data-symbol');
            var inp = document.getElementById('liveSymbol');
            if (inp && sym) { inp.value = sym; updateLiveSymbol(); }
            document.getElementById('liveSymbolDropdown').classList.add('d-none');
        });
    });
    function updateLiveSymbol() { currentSymbol = document.getElementById('liveSymbol').value || 'RELIANCE'; poll(); }

    function saveTradingAmount() {
        const inp = document.getElementById('liveAmountToUse');
        const msgEl = document.getElementById('liveAmountSaveMsg');
        const val = inp ? String(inp.value).trim() : '';
        if (msgEl) { msgEl.classList.add('d-none'); msgEl.classList.remove('text-success-custom', 'text-danger-custom'); }
        api('/api/trading-amount', { method: 'POST', body: JSON.stringify({ amount: val }) })
            .then(r => {
                if (!r.ok) throw new Error(r.statusText);
                return r.json();
            })
            .then(d => {
                if (msgEl) {
                    msgEl.classList.remove('d-none');
                    if (d.ok) {
                        msgEl.textContent = d.message || 'Saved';
                        msgEl.classList.add('text-success-custom');
                        if (d.trading_amount !== undefined && inp) inp.value = d.trading_amount;
                        poll();
                    } else {
                        msgEl.textContent = d.error || 'Failed to save';
                        msgEl.classList.add('text-danger-custom');
                    }
                }
            })
            .catch(e => {
                if (msgEl) {
                    msgEl.classList.remove('d-none');
                    msgEl.textContent = 'Failed to save: ' + (e.message || 'Network error');
                    msgEl.classList.add('text-danger-custom');
                }
            });
    }
    function loadTradingAmount() {
        api('/api/trading-amount').then(r => r.json()).then(d => {
            if (d.ok && d.trading_amount !== undefined) {
                const inp = document.getElementById('liveAmountToUse');
                if (inp && document.activeElement !== inp) inp.value = d.trading_amount;
            }
        }).catch(() => {});
    }
    
    // Trade Suggestions logic
    function loadTradeSuggestions() { return _loadSuggestions('backtestSymbol', 'tradeSuggestions', 'suggestion'); }
    function loadLiveTradeSuggestions() { return _loadSuggestions('liveSymbol', 'liveTradeSuggestions', 'liveSuggestion'); }
    
    function _loadSuggestions(inpId, divId, pfx) {
        const sym = document.getElementById(inpId).value;
        document.getElementById(divId).style.display = 'none';
        api(`/api/trade-suggestions?symbol=${sym}`).then(r=>r.json()).then(d=>{
            if(d.ok) {
                document.getElementById(divId).style.display = 'block';
                document.getElementById(pfx+'Max').textContent = d.suggested_max;
                if(pfx==='suggestion') {
                    document.getElementById('suggestionMin').textContent = d.min_trades;
                    document.getElementById('suggestionCurrent').textContent = d.current_max;
                    document.getElementById('suggestionReasoning').textContent = d.reasoning;
                }
                window.suggestedMaxTrades = d.suggested_max;
            } else alert(d.error);
        });
    }

    function applySuggestedMax() {
        if(!window.suggestedMaxTrades) return;
        if(confirm(`Apply max trades: ${window.suggestedMaxTrades}?`)) alert(`Set Max Trades to ${window.suggestedMaxTrades} in settings.`);
    }

    function runBacktest() {
        const s = document.getElementById('backtestSymbol').value;
        const d = document.getElementById('backtestDays').value;
        document.getElementById('backtestResultsPane').style.display='block';
        document.getElementById('backtestResults').innerHTML = 'Running...';
        api('/api/backtest', {method:'POST', body:JSON.stringify({symbol:s, days:d})}).then(r=>r.json()).then(res=>{
            if(res.ok && res.results.length) {
                document.getElementById('backtestResults').innerHTML = res.results.map(r=>
                    `<div class="border-bottom border-secondary border-opacity-10 p-2 fs-7">
                        <strong class="text-light">${r.symbol}</strong> ${r.action} @ ${r.price} 
                        <span class="${parseFloat(r.pnl)>=0?'text-success-custom':'text-danger-custom'}">(P&L: ${r.pnl})</span>
                    </div>`
                ).join('');
            } else document.getElementById('backtestResults').textContent = 'No trades found.';
        });
    }

    // Prediction History & Pagination
    function loadPredictionHistory() {
        const histDiv = document.getElementById('prediction-history');
        const loading = document.getElementById('history-loading');
        
        histDiv.style.display='none'; loading.classList.remove('d-none');
        document.getElementById('excel-download-btn').style.display = 'none';
        
        api(`/api/prediction-history?symbol=${currentSymbol}&limit=30`).then(r=>r.json()).then(d=>{
            loading.classList.add('d-none'); histDiv.style.display='block';
            if(d.ok && d.history.length) {
                allHistoryData = d.history;
                currentHistoryPage = 1;
                renderPredictionHistoryTable();
                document.getElementById('excel-download-btn').style.display = 'inline-block';
          } else {
                allHistoryData = [];
                renderPredictionHistoryTable();
            }
        });
    }

    function renderPredictionHistoryTable() {
        const body = document.getElementById('prediction-history-body');
        const info = document.getElementById('pagination-info');
        const prevBtn = document.getElementById('prev-page-btn');
        const nextBtn = document.getElementById('next-page-btn');

        if (allHistoryData.length === 0) {
            body.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No history</td></tr>';
            info.textContent = '0-0 of 0';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
        return;
        }

        const start = (currentHistoryPage - 1) * HISTORY_PER_PAGE;
        const end = Math.min(start + HISTORY_PER_PAGE, allHistoryData.length);
        const pageData = allHistoryData.slice(start, end);

        body.innerHTML = pageData.map(h => {
            // Format USA Bias with color coding
            const usaBiasVal = h.usa_bias_value || 0;
            const usaBiasClass = usaBiasVal > 0 ? 'text-success-custom' : usaBiasVal < 0 ? 'text-danger-custom' : 'text-muted';
            const usaBiasDisplay = h.usa_bias || 'N/A';
            
            // Add icons for prediction and actual
            const predIcon = h.prediction==='BULLISH'?'↗':h.prediction==='BEARISH'?'↘':'→';
            const actualDisplay = h.market_closed ? 'Market closed' : (h.actual || '—');
            const actualIcon = h.market_closed ? '' : (h.actual==='BULLISH'?'↗':h.actual==='BEARISH'?'↘':'→');
            const actualCellClass = h.market_closed ? 'text-muted' : (h.actual==='BULLISH'?'text-success-custom':h.actual==='BEARISH'?'text-danger-custom':'');
            
            // Format analysis - truncate if too long and add tooltip
            const analysis = h.analysis || 'N/A';
            const analysisShort = analysis.length > 30 ? analysis.substring(0, 30) + '...' : analysis;
            
            return `<tr>
                <td>${h.date}</td>
                <td class="${h.prediction==='BULLISH'?'text-success-custom':h.prediction==='BEARISH'?'text-danger-custom':''}">${predIcon} ${h.prediction}</td>
                <td class="${usaBiasClass}">${usaBiasDisplay}</td>
                <td class="${actualCellClass}">${actualIcon} ${actualDisplay}</td>
                <td>${h.market_closed ? '—' : (h.accuracy||'-')}</td>
                <td>${h.market_closed ? '—' : (h.price_change_pct + '%')}</td>
                <td class="small" title="${analysis}">${analysisShort}</td>
            </tr>`;
        }).join('');

        info.textContent = `${start + 1}-${end} of ${allHistoryData.length}`;
        prevBtn.disabled = currentHistoryPage === 1;
        nextBtn.disabled = end >= allHistoryData.length;
    }

    function changePredictionHistoryPage(delta) {
        currentHistoryPage += delta;
        renderPredictionHistoryTable();
    }
    
    function downloadPredictionHistoryExcel() {
        // Simple CSV export
        if (!allHistoryData.length) return;
        
        let csv = 'Date,Prediction,USA Bias,Actual,Accuracy,Price Change %,Analysis,Confidence,Factors\n';
        allHistoryData.forEach(row => {
            const factors = row.factors ? row.factors.join('; ').replace(/,/g, '') : '';
            const usaBias = row.usa_bias || 'N/A';
            const analysis = row.analysis || 'N/A';
            csv += `${row.date},${row.prediction},"${usaBias}",${row.actual||''},${row.accuracy||''},${row.price_change_pct},"${analysis}",${row.confidence},"${factors}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `prediction_history_${currentSymbol}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Init
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

    // Zerodha Authentication Functions
    let tokenTimeRemaining = 0;
    let tokenTimerInterval = null;
    
    function formatTimeRemaining(seconds) {
        if (seconds <= 0) return 'Expired';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        if (hours > 0) {
            return `${hours}h ${minutes}m remaining`;
        } else if (minutes > 0) {
            return `${minutes}m ${secs}s remaining`;
        } else {
            return `${secs}s remaining`;
        }
    }
    
    function updateTokenTimer() {
        const statusDetails = document.getElementById('auth-status-details');
        const statusText = document.getElementById('auth-status-text');
        const alertEl = document.getElementById('zerodha-auth-alert');
        
        if (tokenTimeRemaining > 0) {
            tokenTimeRemaining--;
            const timeStr = formatTimeRemaining(tokenTimeRemaining);
            
            const userName = statusDetails.getAttribute('data-username') || '';
            const email = statusDetails.getAttribute('data-email') || '';
            
            // Show warning if less than 1 hour remaining
            if (tokenTimeRemaining < 3600 && tokenTimeRemaining > 0) {
                alertEl.style.background = 'rgba(253, 196, 0, 0.1)';
                alertEl.querySelector('.material-icons-round').style.color = '#fdc400';
                statusText.textContent = 'Token Expiring Soon ⏰';
                statusDetails.innerHTML = `${userName} (${email}) • Expires in: <strong>${timeStr}</strong>`;
            } else {
                alertEl.style.background = 'rgba(109, 213, 140, 0.1)';
                alertEl.querySelector('.material-icons-round').style.color = '#6dd58c';
                statusText.textContent = 'Zerodha Connected ✓';
                statusDetails.innerHTML = `${userName} (${email}) • Token valid: <strong>${timeStr}</strong>`;
            }
        } else if (tokenTimeRemaining === 0) {
            // Token expired
            checkZerodhaAuth(); // Recheck status
        }
    }
    
    function checkZerodhaAuth() {
        api('/api/zerodha/check-auth')
            .then(r => r.json())
            .then(data => {
                const alertEl = document.getElementById('zerodha-auth-alert');
                const statusText = document.getElementById('auth-status-text');
                const statusDetails = document.getElementById('auth-status-details');
                const generateBtn = document.getElementById('generate-token-btn');
                
                if (data.authenticated) {
                    // Store user info
                    statusDetails.setAttribute('data-username', data.user_name || '');
                    statusDetails.setAttribute('data-email', data.email || '');
                    
                    // Set up timer
                    if (data.time_remaining_seconds) {
                        tokenTimeRemaining = data.time_remaining_seconds;
                        
                        // Clear existing timer
                        if (tokenTimerInterval) {
                            clearInterval(tokenTimerInterval);
                        }
                        
                        // Update UI immediately, then start countdown
                        const timeStr = formatTimeRemaining(tokenTimeRemaining);
                        
                        if (tokenTimeRemaining < 3600) {
                            alertEl.style.background = 'rgba(253, 196, 0, 0.1)';
                            alertEl.querySelector('.material-icons-round').style.color = '#fdc400';
                            statusText.textContent = 'Token Expiring Soon ⏰';
                            statusDetails.innerHTML = (data.email ? `${data.user_name} (${data.email})` : data.user_name) + ` • Expires in: <strong>${timeStr}</strong>`;
                        } else {
                            alertEl.style.background = 'rgba(109, 213, 140, 0.1)';
                            alertEl.querySelector('.material-icons-round').style.color = '#6dd58c';
                            statusText.textContent = 'Zerodha Connected ✓';
                            statusDetails.innerHTML = (data.email ? `${data.user_name} (${data.email})` : data.user_name) + ` • Token valid: <strong>${timeStr}</strong>`;
                        }
                        
                        // Start countdown timer
                        tokenTimerInterval = setInterval(updateTokenTimer, 1000);
                    } else {
                        alertEl.style.background = 'rgba(109, 213, 140, 0.1)';
                        alertEl.querySelector('.material-icons-round').style.color = '#6dd58c';
                        statusText.textContent = 'Zerodha Connected';
                        statusDetails.textContent = data.email ? `Logged in as: ${data.user_name} (${data.email})` : `Logged in as: ${data.user_name}`;
                    }
                    generateBtn.style.display = '';  // always show on home so user can refresh token
                } else {
                    // Clear timer
                    if (tokenTimerInterval) {
                        clearInterval(tokenTimerInterval);
                        tokenTimerInterval = null;
                    }
                    
                    alertEl.style.background = 'rgba(255, 180, 171, 0.1)';
                    alertEl.querySelector('.material-icons-round').style.color = '#ffb4ab';
                    
                    if (data.expired) {
                        statusText.textContent = 'Token Expired';
                        statusDetails.textContent = 'Please generate a new token to continue trading';
                    } else {
                        statusText.textContent = 'Zerodha Not Connected';
                        statusDetails.textContent = data.message || 'Generate access token to start trading';
                    }
                    generateBtn.style.display = '';  // show on home
                }
            })
            .catch(err => {
                console.error('Auth check failed:', err);
            });
    }

    function generateZerodhaToken() {
        const btn = document.getElementById('generate-token-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Redirecting...';
        
        api('/api/zerodha/start-auth')
            .then(r => r.json())
            .then(data => {
                if (data.ok && data.login_url) {
                    // Open Zerodha login in new window
                    window.open(data.login_url, '_blank', 'width=800,height=600');
                    
                    // Reset button after a delay
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = '<span class="material-icons-round fs-6 me-1">refresh</span> Generate Token';
                        
                        // Check auth status after user completes OAuth
                        setTimeout(() => checkZerodhaAuth(), 3000);
                    }, 2000);
                } else {
                    alert('Error: ' + (data.error || 'Failed to start authentication'));
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-icons-round fs-6 me-1">refresh</span> Generate Token';
                }
            })
            .catch(err => {
                alert('Error: ' + err);
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons-round fs-6 me-1">refresh</span> Generate Token';
            });
    }

    // Apply URL hash on load (e.g. /dashboard#live -> show Live section)
    applyHashToSection();

    // Check Zerodha auth on page load
    checkZerodhaAuth();
    // Recheck auth every 30 seconds
    setInterval(checkZerodhaAuth, 30000);

    // Start polling immediately and continuously (every 1 second)
    poll();
    pollTimer = setInterval(poll, POLL_MS);
    
    setTimeout(() => { if(document.getElementById('section-overview').classList.contains('active')) loadPredictionHistory(); }, 1500);
    setTimeout(checkGptStatus, 2000);

    // Analytics Charts
    let weekdayChart = null;
    let timeOfDayChart = null;
    let comparisonChart = null;

    function formatRupee(val) {
        if (val == null || val === '' || isNaN(val)) return '—';
        return '₹' + Number(val).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function loadIntradayPicks(forceRefresh) {
        const errEl = document.getElementById('intraday-picks-error');
        const tbody = document.getElementById('intraday-picks-tbody');
        if (errEl) errEl.classList.add('d-none');
        if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">Loading… (scoring in parallel, ~20–45s)</td></tr>';
        const url = forceRefresh ? '/api/intraday-picks?refresh=1' : '/api/intraday-picks';
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 100000);
        fetch(url, { signal: controller.signal, headers: { 'Content-Type': 'application/json' } })
            .then(r => { clearTimeout(timeoutId); if (!r.ok) throw new Error('Request failed: ' + r.status); return r.json(); })
            .then(data => {
                const picks = data.picks || [];
                const ai = data.ai_suggestion || {};
                const symEl = document.getElementById('intraday-ai-symbols');
                const reasonEl = document.getElementById('intraday-ai-reasoning');
                const sourceEl = document.getElementById('intraday-ai-source');
                if (symEl) symEl.textContent = (ai.suggested_symbols || []).length ? ai.suggested_symbols.join(', ') : '—';
                if (reasonEl) reasonEl.textContent = ai.reasoning || '—';
                if (sourceEl) sourceEl.textContent = (ai.source || 'rules') === 'openai' ? 'AI (OpenAI)' : 'Rule-based';
                if (!tbody) return;
                if (!picks.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">No picks available. Try again later.</td></tr>';
                    return;
                }
                tbody.innerHTML = picks.map((p, i) => {
                    const score = p.score != null ? p.score : 0;
                    const scoreClass = score > 0 ? 'text-success-custom' : (score < 0 ? 'text-danger-custom' : '');
                    const pred = (p.prediction || 'NEUTRAL').toUpperCase();
                    const predClass = pred === 'BULLISH' ? 'text-success-custom' : (pred === 'BEARISH' ? 'text-danger-custom' : '');
                    const tags = (p.tags || []).join(' · ');
                    return '<tr><td>' + (i + 1) + '</td><td><strong>' + (p.symbol || '—') + '</strong></td><td class="text-center ' + predClass + '">' + pred + '</td><td class="text-end ' + scoreClass + '">' + score.toFixed(2) + '</td><td class="small">' + (tags || '—') + '</td></tr>';
                }).join('');
            })
            .catch(e => {
                clearTimeout(timeoutId);
                const msg = e.name === 'AbortError' ? 'Request timed out. Try again.' : (e.message || 'Network error');
                if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-danger text-center">Failed: ' + msg + '</td></tr>';
                if (errEl) { errEl.textContent = msg; errEl.classList.remove('d-none'); }
            });
    }

    function loadLiveIntradayPicks() {
        const wrap = document.getElementById('live-picks-wrap');
        const tbody = document.getElementById('live-picks-tbody');
        const loading = document.getElementById('live-picks-loading');
        const errEl = document.getElementById('live-picks-error');
        const empty = document.getElementById('live-picks-empty');
        const applyBtn = document.getElementById('livePicksApplyBtn');
        const loadBtn = document.getElementById('livePicksLoadBtn');
        if (!tbody) return;
        if (loadBtn) loadBtn.disabled = true;
        if (wrap) wrap.style.display = 'none';
        if (empty) empty.classList.add('d-none');
        if (errEl) { errEl.classList.add('d-none'); errEl.textContent = ''; }
        if (loading) loading.classList.remove('d-none');
        const url = '/api/intraday-picks';
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 100000);
        fetch(url, { signal: controller.signal, headers: { 'Content-Type': 'application/json' } })
            .then(r => { clearTimeout(timeoutId); if (!r.ok) throw new Error('Request failed: ' + r.status); return r.json(); })
            .then(data => {
                if (loading) loading.classList.add('d-none');
                if (loadBtn) loadBtn.disabled = false;
                const picks = data.picks || [];
                if (!picks.length) {
                    if (empty) empty.classList.remove('d-none');
                    if (applyBtn) applyBtn.disabled = true;
                    return;
                }
                const predClass = (p) => { const pr = (p.prediction || 'NEUTRAL').toUpperCase(); return pr === 'BULLISH' ? 'text-success-custom' : (pr === 'BEARISH' ? 'text-danger-custom' : ''); };
                const scoreClass = (p) => { const s = p.score != null ? p.score : 0; return s > 0 ? 'text-success-custom' : (s < 0 ? 'text-danger-custom' : ''); };
                tbody.innerHTML = picks.map((p) => {
                    const sym = (p.symbol || '—').trim();
                    const pred = (p.prediction || 'NEUTRAL').toUpperCase();
                    const score = (p.score != null ? p.score : 0).toFixed(2);
                    return '<tr><td class="ps-3"><input type="checkbox" class="form-check-input live-pick-cb" data-symbol="' + sym + '" aria-label="Select ' + sym + ' for trading"></td><td><strong>' + sym + '</strong></td><td class="text-center ' + predClass(p) + '">' + pred + '</td><td class="text-end ' + scoreClass(p) + '">' + score + '</td></tr>';
                }).join('');
                if (wrap) wrap.style.display = 'block';
                if (empty) empty.classList.add('d-none');
                tbody.querySelectorAll('.live-pick-cb').forEach(cb => cb.addEventListener('change', updateLivePicksApplyButton));
                updateLivePicksApplyButton();
            })
            .catch(e => {
                clearTimeout(timeoutId);
                if (loading) loading.classList.add('d-none');
                if (loadBtn) loadBtn.disabled = false;
                const msg = e.name === 'AbortError' ? 'Request timed out. Try again.' : (e.message || 'Network error');
                if (errEl) { errEl.textContent = msg; errEl.classList.remove('d-none'); }
                if (empty) empty.classList.add('d-none');
                if (applyBtn) applyBtn.disabled = true;
            });
    }

    function updateLivePicksApplyButton() {
        const applyBtn = document.getElementById('livePicksApplyBtn');
        if (!applyBtn) return;
        const checked = document.querySelectorAll('.live-pick-cb:checked');
        applyBtn.disabled = !checked.length;
    }

    function applySelectedPicksToTrading() {
        const checked = document.querySelectorAll('.live-pick-cb:checked');
        if (!checked.length) return;
        const first = checked[0].getAttribute('data-symbol');
        const inp = document.getElementById('liveSymbol');
        if (inp && first) {
            inp.value = first;
            updateLiveSymbol();
        }
    }

    function checkGptStatus() {
        const btn = document.getElementById('gpt-status-btn');
        const txt = document.getElementById('gpt-status-text');
        if (btn) btn.disabled = true;
        if (txt) txt.textContent = 'Checking…';
        api('/api/gpt-status')
            .then(r => r.json())
            .then(data => {
                if (txt) txt.textContent = data.working ? 'GPT: Working' : 'GPT: Not working';
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('btn-outline-secondary', 'btn-outline-danger', 'btn-outline-success');
                    btn.classList.add(data.working ? 'btn-outline-success' : 'btn-outline-danger');
                    btn.title = data.message || (data.working ? 'OpenAI is connected' : 'Check Settings → AI');
                }
            })
            .catch(() => {
                if (txt) txt.textContent = 'GPT: Check';
                if (btn) { btn.disabled = false; btn.classList.remove('btn-outline-success', 'btn-outline-danger'); btn.classList.add('btn-outline-secondary'); }
            });
    }

    function loadZerodhaProfile() {
        const errEl = document.getElementById('zerodha-profile-error');
        const contentEl = document.getElementById('zerodha-profile-content');
        errEl.classList.add('d-none');
        contentEl.style.opacity = '0.6';
        api('/api/zerodha/profile')
            .then(r => {
                const ct = (r.headers.get('content-type') || '');
                if (!ct.includes('application/json')) {
                    throw new Error('Server returned non-JSON. Restart the app and try again.');
                }
                if (!r.ok) throw new Error('Request failed: ' + r.status);
                return r.json();
            })
            .then(data => {
                contentEl.style.opacity = '1';
                if (!data.connected || data.error) {
                    errEl.textContent = data.error || 'Zerodha not connected. Generate token from Overview.';
                    errEl.classList.remove('d-none');
                    return;
                }
                const profile = data.profile || {};
                if (profile.error) {
                    errEl.textContent = 'Profile: ' + profile.error;
                    errEl.classList.remove('d-none');
                } else {
                    const fields = [
                        { label: 'User name', key: 'user_name' },
                        { label: 'User ID', key: 'user_id' },
                        { label: 'Email', key: 'email' },
                        { label: 'User type', key: 'user_type' },
                        { label: 'Broker', key: 'broker' },
                        { label: 'Exchanges', key: 'exchanges', fmt: v => Array.isArray(v) ? v.join(', ') : (v || '—') },
                        { label: 'Products', key: 'products', fmt: v => Array.isArray(v) ? v.join(', ') : (v || '—') },
                        { label: 'Order types', key: 'order_types', fmt: v => Array.isArray(v) ? v.join(', ') : (v || '—') }
                    ];
                    const html = fields.map(f => {
                        let val = profile[f.key];
                        if (f.fmt) val = f.fmt(val); else val = val != null ? String(val) : '—';
                        return '<div class="col-md-6 col-lg-4"><span class="text-muted small">' + f.label + '</span><div class="fw-bold">' + val + '</div></div>';
                    }).join('');
                    document.getElementById('zerodha-profile-fields').innerHTML = html;
                }
                const margins = data.margins || {};
                if (margins.error) {
                    document.getElementById('z-margin-cash').textContent = margins.error;
                } else {
                    const avail = margins.available || {};
                    const util = margins.utilised || {};
                    document.getElementById('z-margin-cash').textContent = formatRupee(avail.cash);
                    document.getElementById('z-margin-live-balance').textContent = formatRupee(avail.live_balance);
                    document.getElementById('z-margin-opening').textContent = formatRupee(avail.opening_balance);
                    document.getElementById('z-margin-collateral').textContent = formatRupee(avail.collateral);
                    document.getElementById('z-margin-adhoc').textContent = formatRupee(avail.adhoc_margin);
                    document.getElementById('z-margin-intraday-payin').textContent = formatRupee(avail.intraday_payin);
                    document.getElementById('z-margin-debits').textContent = formatRupee(util.debits);
                    document.getElementById('z-margin-span').textContent = formatRupee(util.span);
                    document.getElementById('z-margin-exposure').textContent = formatRupee(util.exposure);
                    document.getElementById('z-margin-m2m-unrealised').textContent = formatRupee(util.m2m_unrealised);
                    document.getElementById('z-margin-m2m-realised').textContent = formatRupee(util.m2m_realised);
                    document.getElementById('z-margin-delivery').textContent = formatRupee(util.delivery);
                    const net = margins.net != null ? margins.net : 0;
                    document.getElementById('z-margin-net').textContent = formatRupee(net);
                }
                const posSummary = data.positions_summary || {};
                const positions = posSummary.positions || [];
                const totalPnl = posSummary.total_pnl != null ? posSummary.total_pnl : 0;
                document.getElementById('z-positions-count').textContent = posSummary.count != null ? posSummary.count : positions.length;
                const pnlEl = document.getElementById('z-positions-pnl');
                pnlEl.textContent = formatRupee(totalPnl);
                pnlEl.className = 'fw-bold ' + (totalPnl > 0 ? 'text-success-custom' : totalPnl < 0 ? 'text-danger-custom' : 'text-white');
                const tbody = document.getElementById('zerodha-positions-tbody');
                if (!positions.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">No open positions</td></tr>';
                } else {
                    tbody.innerHTML = positions.map(p => {
                        const pnl = parseFloat(p.pnl || 0);
                        const pnlClass = pnl >= 0 ? 'text-success-custom' : 'text-danger-custom';
                        return '<tr><td>' + (p.symbol || '—') + '</td><td class="text-end">' + (p.quantity || 0) + '</td><td class="text-end">' + formatRupee(p.average_price) + '</td><td class="text-end">' + formatRupee(p.last_price) + '</td><td class="text-end ' + pnlClass + '">' + formatRupee(pnl) + '</td></tr>';
                    }).join('');
                }
            })
            .catch(e => {
                contentEl.style.opacity = '1';
                errEl.textContent = 'Failed to load: ' + (e.message || 'Network error');
                errEl.classList.remove('d-none');
            });
    }

    function loadAnalytics() {
        const timeRange = document.getElementById('analyticsTimeRange').value;
        
        api('/api/analytics?range=' + timeRange)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    console.error('Analytics error:', data.error);
                    return;
                }
                
                // Update summary stats
                document.getElementById('analytics-bestDay').textContent = data.best_day || '—';
                document.getElementById('analytics-worstDay').textContent = data.worst_day || '—';
                document.getElementById('analytics-bestTime').textContent = data.best_time || '—';
                document.getElementById('analytics-totalTrades').textContent = data.total_trades || '0';
                
                // Render Weekday Chart
                renderWeekdayChart(data.by_weekday);
                
                // Render Time of Day Chart
                renderTimeOfDayChart(data.by_time_of_day);
                
                // Load comparison data
                loadComparison();
            })
            .catch(err => {
                console.error('Failed to load analytics:', err);
            });
    }

    function loadComparison() {
        api('/api/comparison')
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    console.error('Comparison error:', data.error);
                    return;
                }
                
                // Update win rates
                document.getElementById('comparison-backtestWinRate').textContent = 
                    data.backtest.win_rate != null ? data.backtest.win_rate.toFixed(1) + '%' : '—';
                document.getElementById('comparison-liveWinRate').textContent = 
                    data.live.win_rate != null ? data.live.win_rate.toFixed(1) + '%' : '—';
                
                // Update comparison table
                updateComparisonTable(data);
                
                // Render comparison chart
                renderComparisonChart(data);
            })
            .catch(err => {
                console.error('Failed to load comparison:', err);
            });
    }

    function updateComparisonTable(data) {
        const formatValue = (val, suffix = '') => val != null ? val.toFixed(2) + suffix : '—';
        const formatDiff = (backtest, live, suffix = '', inverse = false) => {
            if (backtest == null || live == null) return '—';
            const diff = live - backtest;
            const sign = diff >= 0 ? '+' : '';
            const color = inverse ? (diff <= 0 ? 'text-success-custom' : 'text-danger-custom') 
                                  : (diff >= 0 ? 'text-success-custom' : 'text-danger-custom');
            return `<span class="${color}">${sign}${diff.toFixed(2)}${suffix}</span>`;
        };
        
        // P&L
        document.getElementById('comparison-backtest-pnl').textContent = '₹' + formatValue(data.backtest.total_pnl);
        document.getElementById('comparison-live-pnl').textContent = '₹' + formatValue(data.live.total_pnl);
        document.getElementById('comparison-diff-pnl').innerHTML = formatDiff(data.backtest.total_pnl, data.live.total_pnl, '');
        
        // Avg Profit
        document.getElementById('comparison-backtest-avgProfit').textContent = '₹' + formatValue(data.backtest.avg_profit);
        document.getElementById('comparison-live-avgProfit').textContent = '₹' + formatValue(data.live.avg_profit);
        document.getElementById('comparison-diff-avgProfit').innerHTML = formatDiff(data.backtest.avg_profit, data.live.avg_profit, '');
        
        // Total Trades
        document.getElementById('comparison-backtest-trades').textContent = data.backtest.total_trades || '0';
        document.getElementById('comparison-live-trades').textContent = data.live.total_trades || '0';
        const tradeDiff = (data.live.total_trades || 0) - (data.backtest.total_trades || 0);
        document.getElementById('comparison-diff-trades').textContent = tradeDiff >= 0 ? '+' + tradeDiff : tradeDiff;
        
        // Max Drawdown (inverse - lower is better)
        document.getElementById('comparison-backtest-drawdown').textContent = formatValue(data.backtest.max_drawdown, '%');
        document.getElementById('comparison-live-drawdown').textContent = formatValue(data.live.max_drawdown, '%');
        document.getElementById('comparison-diff-drawdown').innerHTML = formatDiff(data.backtest.max_drawdown, data.live.max_drawdown, '%', true);
        
        // Sharpe Ratio
        document.getElementById('comparison-backtest-sharpe').textContent = formatValue(data.backtest.sharpe_ratio);
        document.getElementById('comparison-live-sharpe').textContent = formatValue(data.live.sharpe_ratio);
        document.getElementById('comparison-diff-sharpe').innerHTML = formatDiff(data.backtest.sharpe_ratio, data.live.sharpe_ratio, '');
    }

    function renderWeekdayChart(data) {
        const ctx = document.getElementById('chartWeekday').getContext('2d');
        
        if (weekdayChart) {
            weekdayChart.destroy();
        }
        
        const labels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const profits = labels.map(day => data[day] || 0);
        
        weekdayChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Profit (₹)',
                    data: profits,
                    backgroundColor: profits.map(p => p >= 0 ? 'rgba(109, 213, 140, 0.7)' : 'rgba(255, 180, 171, 0.7)'),
                    borderColor: profits.map(p => p >= 0 ? 'rgb(109, 213, 140)' : 'rgb(255, 180, 171)'),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 30, 30, 0.95)',
                        titleColor: '#e2e2e2',
                        bodyColor: '#e2e2e2',
                        borderColor: '#444746',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return 'Profit: ₹' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(68, 71, 70, 0.3)'
                        },
                        ticks: {
                            color: '#c4c7c5',
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#c4c7c5'
                        }
                    }
                }
            }
        });
    }

    function renderTimeOfDayChart(data) {
        const ctx = document.getElementById('chartTimeOfDay').getContext('2d');
        
        if (timeOfDayChart) {
            timeOfDayChart.destroy();
        }
        
        const labels = ['9-10 AM', '10-11 AM', '11-12 PM', '12-1 PM', '1-2 PM', '2-3 PM', '3-4 PM'];
        const profits = labels.map(time => data[time] || 0);
        
        timeOfDayChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Profit (₹)',
                    data: profits,
                    borderColor: 'rgb(168, 199, 250)',
                    backgroundColor: 'rgba(168, 199, 250, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: 'rgb(168, 199, 250)',
                    pointBorderColor: '#1e1e1e',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 30, 30, 0.95)',
                        titleColor: '#e2e2e2',
                        bodyColor: '#e2e2e2',
                        borderColor: '#444746',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return 'Profit: ₹' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(68, 71, 70, 0.3)'
                        },
                        ticks: {
                            color: '#c4c7c5',
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(68, 71, 70, 0.3)'
                        },
                        ticks: {
                            color: '#c4c7c5'
                        }
                    }
                }
            }
        });
    }

    function renderComparisonChart(data) {
        const ctx = document.getElementById('chartComparison').getContext('2d');
        
        if (comparisonChart) {
            comparisonChart.destroy();
        }
        
        const metrics = ['Win Rate (%)', 'Avg Profit (₹)', 'Max Drawdown (%)', 'Sharpe Ratio'];
        const backtestData = [
            data.backtest.win_rate || 0,
            data.backtest.avg_profit || 0,
            data.backtest.max_drawdown || 0,
            data.backtest.sharpe_ratio || 0
        ];
        const liveData = [
            data.live.win_rate || 0,
            data.live.avg_profit || 0,
            data.live.max_drawdown || 0,
            data.live.sharpe_ratio || 0
        ];
        
        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: metrics,
                datasets: [
                    {
                        label: 'Backtest',
                        data: backtestData,
                        backgroundColor: 'rgba(168, 199, 250, 0.7)',
                        borderColor: 'rgb(168, 199, 250)',
                        borderWidth: 2
                    },
                    {
                        label: 'Live',
                        data: liveData,
                        backgroundColor: 'rgba(109, 213, 140, 0.7)',
                        borderColor: 'rgb(109, 213, 140)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#e2e2e2',
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 30, 30, 0.95)',
                        titleColor: '#e2e2e2',
                        bodyColor: '#e2e2e2',
                        borderColor: '#444746',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const value = context.parsed.y;
                                // Format based on metric type
                                if (context.dataIndex === 1) { // Avg Profit
                                    label += '₹' + value.toFixed(2);
                                } else if (context.dataIndex === 0 || context.dataIndex === 2) { // Percentages
                                    label += value.toFixed(2) + '%';
                                } else {
                                    label += value.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(68, 71, 70, 0.3)'
                        },
                        ticks: {
                            color: '#c4c7c5'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#c4c7c5'
                        }
                    }
                }
            }
        });
    }


  </script>
</body>
</html>